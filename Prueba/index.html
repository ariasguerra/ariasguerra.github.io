<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Meta tags y título -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Unificada: Generar Acta & Extractor PDF</title>

    <!-- Librerías externas (Font Awesome para iconos) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Estilos CSS -->
    <style>
        /* ------------------------- */
        /* Variables y Reset Global  */
        /* ------------------------- */
        :root {
            --primary: #4CAF50; --primary-dark: #45a049; --primary-light: #a5d6a7;
            --secondary: #f4f4f4; --text: #333333; --text-light: #666666;
            --border: #cccccc; --danger: #f44336; --success: #4caf50;
            --radius: 0.375rem; --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', Segoe UI, sans-serif; font-size: 10pt; color: var(--text); background-color: #f9fafb; line-height: 1.5; margin: 0; }

        /* ------------------------- */
        /* Estilos del Encabezado    */
        /* ------------------------- */
        header { background: var(--primary); color: white; text-align: center; padding: 20px; box-shadow: var(--shadow); }
        .app-title { font-size: 14pt; font-weight: 600; margin-bottom: 0.5rem; }
        .app-subtitle { font-size: 10pt; opacity: 0.9; }

        /* ------------------------- */
        /* Estilos de Navegación     */
        /* ------------------------- */
        nav { background: var(--secondary); display: flex; gap: 20px; padding: 10px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        nav a { text-decoration: none; color: var(--text); padding: 8px 15px; border-radius: var(--radius); transition: background-color 0.3s; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        nav a:hover { background-color: var(--primary-light); color: var(--text); }
        nav a.active { background-color: var(--primary); color: white; }

        /* ------------------------- */
        /* Contenedor Principal      */
        /* ------------------------- */
        .container { max-width: 800px; margin: 20px auto; background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; border: 1px solid var(--border); }

        /* ------------------------- */
        /* Títulos y Encabezados     */
        /* ------------------------- */
        h1 { text-align: center; font-size: 14pt; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        h1 i { color: var(--primary); }
        h3 { font-size: 10pt; margin: 15px 0 5px; }

        /* ------------------------- */
        /* Estilos de Formularios    */
        /* ------------------------- */
        form .form-group { margin-bottom: 15px; }
        form label { font-weight: 600; display: block; margin-bottom: 5px; font-size: 10pt; }
        form input[type="text"], form textarea, form select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 10pt; background-color: white; }
        form input[type="text"]:focus, form textarea:focus, form select:focus { outline: none; border-color: var(--primary); }
        form select:disabled { background-color: #eee; cursor: not-allowed; } /* Style for disabled select */

        /* ------------------------- */
        /* Estilos de Botones        */
        /* ------------------------- */
        button { background-color: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; padding: 10px 15px; font-size: 10pt; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s; }
        button:hover { background-color: var(--primary-dark); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ----------------------------- */
        /* Estilos Acta Generada         */
        /* ----------------------------- */
        #actaGenerada { border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px; text-align: justify; }
        #primerParrafo { text-transform: uppercase; } /* Asegura mayúsculas para el primer párrafo */

        /* ----------------------------- */
        /* Estilos Extractor PDF         */
        /* ----------------------------- */
        /* Zona de arrastre */
        .drop-zone { border: 2px dashed var(--border); padding: 50px; text-align: center; cursor: pointer; background-color: var(--secondary); margin: 20px 0; border-radius: var(--radius); transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .drop-zone i { font-size: 2.5rem; color: var(--text-light); }
        .drop-zone.dragover { border-color: var(--primary); background-color: #e6ffe6; }
        .drop-zone.dragover i { color: var(--primary); }

        /* Salida, sugerencias y estadísticas */
        #output, #suggestion, #stats { margin-top: 20px; padding: 10px; background-color: var(--secondary); border-radius: var(--radius); font-size: 10pt; }
        #stats { display: flex; flex-wrap: wrap; gap: 10px; }
        .stat-item { display: flex; align-items: center; gap: 8px; background: white; padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--border); }
        .stat-item i { color: var(--primary); }

        /* Controles (rango, iconos) */
        .range-container { margin: 20px 0; }
        .range-container label { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
        .icon-group { display: flex; flex-wrap: wrap; align-items: center; gap: 20px; margin: 15px 0; justify-content: center; }
        .icon-group label { cursor: pointer; display: flex; flex-direction: column; align-items: center; font-weight: normal; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius); transition: all 0.3s; }
        .icon-group label:hover { border-color: var(--primary-light); }
        .icon-group input[type="radio"] { display: none; }
        .single-box { width: 50px; height: 50px; background-color: #e5e7eb; margin-bottom: 5px; border-radius: 0.25rem; }
        .four-boxes { display: grid; grid-template-columns: repeat(2, 20px); grid-template-rows: repeat(2, 20px); gap: 5px; margin-bottom: 5px; }
        .four-boxes .box { background-color: #e5e7eb; border-radius: 0.25rem; }
        .icon-group input[type="radio"]:checked + label { border-color: var(--primary); background-color: rgba(76, 175, 80, 0.1); }

        /* Contenedor y navegación de imágenes */
        .image-container { margin-top: 20px; text-align: center; }
        .image-wrapper { display: inline-block; background-color: white; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); max-width: 100%; position: relative; }
        .image-wrapper::after { content: "Haz clic para copiar"; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 9pt; opacity: 0; transition: opacity 0.3s; pointer-events: none; /* Prevent hover effect from blocking click */ }
        .image-wrapper:hover::after { opacity: 1; }
        .image-wrapper img { width: auto; height: auto; max-width: 100%; cursor: pointer; display: block; }
        .image-navigation { margin-top: 10px; display: flex; justify-content: center; gap: 20px; align-items: center; }
        .image-counter { font-size: 10pt; color: var(--text-light); }

        /* Toast notification style */
        .toast-notification {
            position:fixed;
            bottom:20px;
            left:50%;
            transform:translateX(-50%);
            background:rgba(76,175,80,0.9);
            color:white;
            padding:8px 16px;
            border-radius:4px;
            z-index:1000;
            font-size:10pt;
            transition: opacity 0.5s ease-in-out;
            opacity: 0; /* Start hidden */
        }
        .toast-notification.show {
            opacity: 1;
        }


        /* ------------------------- */
        /* Estilos Responsivos       */
        /* ------------------------- */
        @media (max-width: 600px) {
            .container { padding: 10px; margin: 10px; }
            .drop-zone { padding: 30px 15px; }
            .icon-group { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- ======================== -->
    <!--      ENCABEZADO          -->
    <!-- ======================== -->
    <header>
        <h1 class="app-title">Aplicación Unificada</h1>
        <p class="app-subtitle">Generación de Acta de Instrucción & Extractor de Contenido PDF</p>
    </header>

    <!-- ======================== -->
    <!--      NAVEGACIÓN          -->
    <!-- ======================== -->
    <nav>
        <a href="#" id="tabActa" class="active"><i class="fas fa-file-alt"></i> Generar Acta</a>
        <a href="#" id="tabPdf"><i class="fas fa-file-pdf"></i> Extractor PDF</a>
    </nav>

    <!-- ======================== -->
    <!--   CONTENIDO PRINCIPAL    -->
    <!-- ======================== -->
    <main>

        <!-- ----------------------------- -->
        <!-- SECCIÓN GENERACIÓN DE ACTA    -->
        <!-- ----------------------------- -->
        <section id="actaSection" class="container">
            <h1><i class="fas fa-file-signature"></i> Generar Acta de Instrucción</h1>

            <!-- Formulario para ingresar datos del acta -->
            <form id="actaForm">
                <div class="form-group">
                    <label for="equipoActa">Equipo de Trabajo</label>
                    <select id="equipoActa" required>
                        <option value="" disabled selected>Cargando equipos...</option>
                        <!-- Opciones cargadas por JavaScript desde equipos.json -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="grado">Grado</label>
                    <input type="text" id="grado" placeholder="Ej: Capitán" required>
                </div>
                <div class="form-group">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" placeholder="Nombre completo" required>
                </div>
                <div class="form-group">
                    <label for="cargo">Cargo</label>
                    <input type="text" id="cargo" placeholder="Cargo del funcionario" required>
                </div>
                <div class="form-group">
                    <label for="tema">Tema de Instrucción</label>
                    <input type="text" id="tema" placeholder="Tema" required>
                </div>
                <div class="form-group">
                    <label for="temas">Temas a tratar</label>
                    <textarea id="temas" placeholder="Lista de temas a tratar" required rows="4"></textarea>
                </div>
                <button type="submit"><i class="fas fa-check-circle"></i> Generar Acta</button>
            </form>

            <!-- Div donde se mostrará el acta generada -->
            <div id="actaGenerada" style="display:none;">
                <h1>ACTA DE INSTRUCCIÓN</h1>
                <p id="actaInfoEquipo">Equipo de Trabajo: <span id="actaEquipoDisplay"></span></p>
                <br>
                <p id="primerParrafo">
                    LA INSTRUCCIÓN DIRIGIDA POR PARTE DEL SEÑOR
                    <span id="actaGrado"></span>,
                    <span id="actaCargo"></span>,
                    AL PERSONAL QUE CONFORMA <span id="actaEquipo1"></span>,
                    SOBRE <span id="articuloTema"></span> <span id="actaTema"></span>.
                </p>
                <br><h3>ORDEN DEL DÍA</h3>
                    <ol style="padding-left: 60px;">
                        <li>Verificación de asistentes</li>
                        <li>Lectura del acta anterior</li>
                        <li>Verificación de los compromisos</li>
                        <li>Temas a tratar</li>
                    </ol>
                <br><h3>DESARROLLO</h3>
                <p>
                    Se realiza instrucción al personal adscrito <span id="actaEquipo2"></span>
                    por parte del señor <span id="actaGrado2"></span>, <span id="actaCargo2"></span>,
                    a quienes se les socializan los lineamientos sobre
                    <span id="articuloTema2"></span> <span id="actaTema2"></span>.
                </p>
                <br><h3>1. Verificación de asistentes</h3>
                <p>
                    Se verifica la asistencia del personal adscrito a la unidad y se constata la compatibilidad
                    de los correos electrónicos del personal que integra <span id="actaEquipo3"></span>.
                    Dejando constancia que la presente acta de instrucción se surtirá presencialmente, por correo
                    electrónico y a través del Sistema de Información Gestor de Documentos Policiales, en virtud
                    a lo dispuesto en el Art. 103 del Código General del Proceso -- Uso de las tecnologías de la
                    información y de las comunicaciones, Ley 527 del 18 de agosto de 1999, Ley 794 del 01 de agosto
                    de 2003 y la Ley 962 del 08 de julio de 2005.
                </p>
                <br><h3>2. Lectura del acta anterior</h3><p>(NO APLICA)</p>
                <br><h3>3. Verificación de los compromisos</h3><p>(NO APLICA)</p>
                <br><h3>4. Temas a tratar</h3><p id="temasTratar"></p>
            </div>
        </section>

        <!-- ----------------------------- -->
        <!-- SECCIÓN EXTRACTOR PDF         -->
        <!-- ----------------------------- -->
        <section id="pdfSection" class="container" style="display:none;">
            <h1><i class="fas fa-file-export"></i> Extractor de Contenido PDF Mejorado</h1>

            <!-- Input de archivo y zona de arrastre -->
            <div class="form-group">
                <label for="fileInput">Seleccionar archivo PDF o arrastrar y soltar:</label>
                <div id="dropZone" class="drop-zone">
                    <i class="fas fa-file-upload"></i>
                    <p>Arrastra y suelta el archivo PDF aquí o haz clic para seleccionarlo</p>
                </div>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            </div>

            <!-- Mensajes al usuario -->
            <div id="suggestion"></div>

            <!-- Control de margen -->
            <div class="range-container">
                <label for="marginRange">Margen sugerido para recorte (píxeles): <span id="rangeValue">150</span></label>
                <input type="range" id="marginRange" value="150" min="0" max="200" step="1">
            </div>

            <!-- Control de agrupación de páginas -->
            <div>
                <p style="margin: 10px 0; font-weight: 600;">Elige modo de agrupación:</p>
                <div class="icon-group">
                    <input type="radio" id="singleMode" name="pagesMode" value="1" checked>
                    <label for="singleMode"><div class="single-box"></div><span>1 Hoja</span></label>
                    <input type="radio" id="fourMode" name="pagesMode" value="4">
                    <label for="fourMode"><div class="four-boxes"><div class="box"></div><div class="box"></div><div class="box"></div><div class="box"></div></div><span>4 Hojas</span></label>
                </div>
            </div>

            <!-- Botón para procesar -->
            <button id="processButton"><i class="fas fa-cogs"></i> Procesar PDF</button>

            <!-- Salida y estadísticas -->
            <div id="output"></div>
            <div id="stats" style="display: none;">
                <div class="stat-item"><i class="fas fa-file-alt"></i><span id="processedStat">0</span> páginas procesadas</div>
                <div class="stat-item"><i class="fas fa-file"></i><span id="blankStat">0</span> páginas en blanco omitidas</div>
            </div>

            <!-- Visor y navegación de imágenes -->
            <div class="image-container" id="imageContainer" style="display:none;">
                <div class="image-wrapper"><img id="currentImage" alt="Imagen actual extraída del PDF"></div>
                <div class="image-navigation">
                    <button id="prevButton"><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span class="image-counter">Imagen <span id="currentImageIndex">1</span> de <span id="totalImages">1</span></span>
                    <button id="nextButton">Siguiente <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- Botón de descarga -->
            <button id="downloadAll" style="display: none; margin-top: 20px;"><i class="fas fa-download"></i> Descargar todas las imágenes</button>
        </section>

    </main>

    <!-- ======================== -->
    <!-- LIBRERÍAS JAVASCRIPT     -->
    <!-- ======================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <!-- pdf.worker.min.js es necesario para pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js"></script>

    <!-- ======================== -->
    <!-- SCRIPT DE LA APLICACIÓN  -->
    <!-- ======================== -->
    <script>
        // --------------------------------------------------------------------
        // LÓGICA DE PESTAÑAS (Tabs)
        // --------------------------------------------------------------------
        const tabActa = document.getElementById('tabActa');
        const tabPdf = document.getElementById('tabPdf');
        const actaSection = document.getElementById('actaSection');
        const pdfSection = document.getElementById('pdfSection');

        tabActa.addEventListener('click', (e) => {
            e.preventDefault();
            tabActa.classList.add('active');
            tabPdf.classList.remove('active');
            actaSection.style.display = 'block';
            pdfSection.style.display = 'none';
        });

        tabPdf.addEventListener('click', (e) => {
            e.preventDefault();
            tabPdf.classList.add('active');
            tabActa.classList.remove('active');
            pdfSection.style.display = 'block';
            actaSection.style.display = 'none';
        });

        // --------------------------------------------------------------------
        // DATOS Y FUNCIONES PARA GENERAR ACTA
        // --------------------------------------------------------------------

        // --- Referencia al dropdown de Equipos ---
        const equipoActaSelect = document.getElementById('equipoActa');

        // --- Función para poblar el dropdown de Equipos (ahora recibe los datos) ---
        function populateEquiposDropdown(equiposData) {
            // Limpia opciones previas y establece el placeholder inicial correcto
            equipoActaSelect.options.length = 0; // Limpia todas las opciones
            const initialOption = document.createElement('option');
            initialOption.value = "";
            initialOption.textContent = "Seleccione un equipo...";
            initialOption.disabled = true;
            initialOption.selected = true;
            equipoActaSelect.appendChild(initialOption);

            if (!equiposData || !Array.isArray(equiposData)) {
                 console.error("Datos de equipos inválidos o no cargados.");
                 equipoActaSelect.disabled = true; // Deshabilita el select si hay error
                 initialOption.textContent = "Error al cargar equipos"; // Mensaje de error
                 return; // Detiene la ejecución si los datos no son válidos
            }

            equiposData.forEach(equipo => {
                const option = document.createElement('option');
                option.value = equipo.name;
                option.textContent = equipo.name;
                equipoActaSelect.appendChild(option);
            });
            equipoActaSelect.disabled = false; // Habilita el select una vez poblado
        }

        // --- Funciones para guardar y cargar datos del formulario en LocalStorage ---
        function saveToLocalStorage(data) {
            localStorage.setItem('actaData', JSON.stringify(data));
        }
        function loadFromLocalStorage() {
            const data = localStorage.getItem('actaData');
            return data ? JSON.parse(data) : null;
        }

        // --- Función para actualizar el formulario con datos cargados ---
        function updateForm(data) {
            if (data) {
                document.getElementById('grado').value = data.grado || '';
                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('cargo').value = data.cargo || '';
                document.getElementById('tema').value = data.tema || '';
                document.getElementById('temas').value = data.temas || '';

                // Espera un momento para asegurarse de que el dropdown esté poblado
                // antes de intentar seleccionar una opción guardada.
                setTimeout(() => {
                    if (data.equipo && equipoActaSelect.options.length > 1) { // Asegura que hay opciones cargadas
                         // Verifica si la opción guardada todavía existe en el dropdown
                        if ([...equipoActaSelect.options].some(option => option.value === data.equipo)) {
                            equipoActaSelect.value = data.equipo;
                        } else {
                            console.warn(`Equipo guardado "${data.equipo}" no encontrado en el desplegable.`);
                            equipoActaSelect.value = ""; // Resetea si no existe
                        }
                    } else {
                        equipoActaSelect.value = ""; // Resetea si no hay equipo guardado o dropdown vacío
                    }
                }, 100); // Pequeña demora (100ms)

            } else {
                document.getElementById('actaForm').reset();
                equipoActaSelect.value = ""; // Asegura reseteo del dropdown
            }
        }

        // --- Función para determinar el artículo correcto (EL/LA/LOS/LAS) ---
        function determinarArticulo(tema) {
            const t = tema.trim().toLowerCase();
            if (!t) return { articulo: "EL", articuloMin: "el" };

            const m = ["protocolo", "procedimiento", "manual", "instructivo", "reglamento", "decreto", "código", "estatuto", "memorando", "oficio", "formulario", "programa", "plan", "sistema", "método", "formato", "proceso", "uso", "manejo", "curso", "taller", "seminario", "simposio", "congreso", "informe", "reporte", "documento", "expediente", "registro", "archivo", "control", "seguimiento", "operativo", "operacional", "servicio", "deber"];
            const f = ["normativa", "norma", "directiva", "instrucción", "circular", "resolución", "orden", "directriz", "ley", "regulación", "disposición", "medida", "acción", "guía", "metodología", "técnica", "estrategia", "táctica", "operación", "actividad", "capacitación", "formación", "conferencia", "charla", "presentación", "exposición", "jornada", "sesión", "reunión", "clase", "política", "aplicación", "implementación", "comunicación"];
            const mp = ["protocolos", "procedimientos", "manuales", "instructivos", "reglamentos", "decretos", "códigos", "estatutos", "memorandos", "oficios", "formularios", "programas", "planes", "sistemas", "métodos", "formatos", "procesos", "usos", "manejos", "cursos", "talleres", "seminarios", "simposios", "congresos", "informes", "reportes", "documentos", "expedientes", "registros", "archivos", "controles", "seguimientos", "operativos"];
            const fp = ["normativas", "normas", "directivas", "instrucciones", "circulares", "resoluciones", "órdenes", "directrices", "leyes", "regulaciones", "disposiciones", "medidas", "acciones", "guías", "metodologías", "técnicas", "estrategias", "tácticas", "operaciones", "actividades", "capacitaciones", "formaciones", "conferencias", "charlas", "presentaciones", "exposiciones", "jornadas", "sesiones", "reuniones", "clases", "políticas", "comunicaciones"];

            const p = t.split(' ');
            let i = 0;
            const pa = ["de", "del", "la", "el", "los", "las", "sobre", "para", "en", "con", "y", "o"];
            while (i < p.length && pa.includes(p[i])) { i++; }
            const p1 = (i < p.length) ? p[i] : p[0];
            if (!p1) return { articulo: "EL", articuloMin: "el" };

            const plural = p1.endsWith('s') || p1.endsWith('es');

            if (mp.includes(p1)) return { articulo: "LOS", articuloMin: "los" };
            if (fp.includes(p1)) return { articulo: "LAS", articuloMin: "las" };
            if (m.includes(p1)) return { articulo: "EL", articuloMin: "el" };
            if (f.includes(p1)) return { articulo: "LA", articuloMin: "la" };

            if (plural) {
                const s = p1.endsWith('es') ? p1.slice(0, -2) : p1.slice(0, -1);
                if (s.endsWith('a') || s.endsWith('dad') || s.endsWith('ción') || s.endsWith('sión') || s.endsWith('tud') || s.endsWith('umbre')) return { articulo: "LAS", articuloMin: "las" };
                else return { articulo: "LOS", articuloMin: "los" };
            } else {
                if (p1.endsWith('a') || p1.endsWith('dad') || p1.endsWith('ción') || p1.endsWith('sión') || p1.endsWith('tud') || p1.endsWith('umbre')) return { articulo: "LA", articuloMin: "la" };
                else return { articulo: "EL", articuloMin: "el" };
            }
        }

        // --- Función para convertir texto a formato Título (con excepciones) ---
        function toTitleCase(str) {
            if (!str) return "";
            return str.toLowerCase().split(' ').map(function(word) {
                if (word === 'cai') { return 'CAI'; }
                let capitalizedWord = word.charAt(0).toUpperCase() + word.slice(1);
                if (word === 'de') { capitalizedWord = 'de'; }
                return capitalizedWord;
            }).join(' ');
        }

        // --- Función Principal para Generar el Acta ---
        function generateActa(data) {
            const selectedEquipo = data.equipo;
            if (!selectedEquipo) { // Asegura que haya un equipo
                 console.error("Intento de generar acta sin equipo seleccionado.");
                 return;
            }

            let preposition = "a la";
            let article = "la";
            if (selectedEquipo.startsWith("CAI")) {
                preposition = "al";
                article = "el";
            }
            const titleCaseEquipo = toTitleCase(selectedEquipo);

            document.getElementById('actaGrado').textContent = data.grado + ' ' + data.nombre;
            document.getElementById('actaCargo').textContent = data.cargo;
            document.getElementById('actaTema').textContent = data.tema;
            document.getElementById('actaGrado2').textContent = data.grado + ' ' + data.nombre;
            document.getElementById('actaCargo2').textContent = data.cargo;
            document.getElementById('actaTema2').textContent = data.tema;
            document.getElementById('temasTratar').textContent = data.temas;

            document.getElementById('actaEquipoDisplay').textContent = selectedEquipo;

            let equipo1Text = selectedEquipo;
            if (selectedEquipo.startsWith("ESTACIÓN")) { equipo1Text = "LA " + selectedEquipo; }
            else if (selectedEquipo.startsWith("CAI")) { equipo1Text = "EL " + selectedEquipo; }
            document.getElementById('actaEquipo1').textContent = equipo1Text;

            document.getElementById('actaEquipo2').textContent = preposition + " " + titleCaseEquipo;
            document.getElementById('actaEquipo3').textContent = article + " " + titleCaseEquipo;

            const { articulo, articuloMin } = determinarArticulo(data.tema);
            document.getElementById('articuloTema').textContent = articulo;
            document.getElementById('articuloTema2').textContent = articuloMin;

            document.getElementById('actaGenerada').style.display = 'block';
        }

        // --- Event Listener: Se ejecuta cuando el HTML ha cargado completamente ---
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Carga los datos de equipos desde el archivo JSON ---
            let equiposCargados = null;
            try {
                equipoActaSelect.disabled = true; // Deshabilita mientras carga
                const response = await fetch('equipos.json'); // ¡Asegúrate que equipos.json esté en el mismo directorio!
                if (!response.ok) {
                    throw new Error(`Error HTTP al cargar equipos.json: ${response.status}`);
                }
                equiposCargados = await response.json(); // Parsea la respuesta JSON
                populateEquiposDropdown(equiposCargados); // Pobla el dropdown con los datos cargados
            } catch (error) {
                console.error("Error cargando o procesando equipos.json:", error);
                populateEquiposDropdown(null); // Llama con null para mostrar estado de error
                // Opcional: Mostrar un mensaje más visible al usuario
                // alert("No se pudieron cargar los equipos de trabajo. Por favor, verifica el archivo 'equipos.json' o recarga la página.");
            }

            // --- Carga datos guardados y actualiza el formulario ---
            const savedData = loadFromLocalStorage();
            updateForm(savedData); // Actualiza el formulario (esto esperará si es necesario)

            // --- Intenta generar acta si hay datos guardados válidos ---
            // Espera un poco para asegurar que el updateForm haya intentado seleccionar el equipo
            setTimeout(() => {
                if (savedData && savedData.grado && savedData.equipo && equipoActaSelect.value === savedData.equipo) {
                    generateActa(savedData);
                }
             }, 150); // Espera un poco más que updateForm

        });

        // --- Event Listener: Se ejecuta al enviar el formulario del acta ---
        document.getElementById('actaForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const data = {
                equipo: equipoActaSelect.value, // Obtiene el valor del select
                grado: document.getElementById('grado').value,
                nombre: document.getElementById('nombre').value,
                cargo: document.getElementById('cargo').value,
                tema: document.getElementById('tema').value,
                temas: document.getElementById('temas').value
            };

            if (!data.equipo) {
                 alert("Por favor, seleccione un equipo de trabajo.");
                 equipoActaSelect.focus();
                 return;
             }

            saveToLocalStorage(data);
            generateActa(data);
        });


        // --------------------------------------------------------------------
        // FUNCIONES EXTRACTOR PDF
        // --------------------------------------------------------------------
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const processButton = document.getElementById('processButton');
        const output = document.getElementById('output');
        const suggestion = document.getElementById('suggestion');
        const stats = document.getElementById('stats');
        const processedStat = document.getElementById('processedStat');
        const blankStat = document.getElementById('blankStat');
        const imageContainer = document.getElementById('imageContainer');
        const currentImage = document.getElementById('currentImage');
        const downloadAllButton = document.getElementById('downloadAll');
        const currentImageIndex = document.getElementById('currentImageIndex');
        const totalImages = document.getElementById('totalImages');
        const marginRange = document.getElementById('marginRange');
        const rangeValueSpan = document.getElementById('rangeValue');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');

        let singlePageImages = [];
        let processedImages = [];
        let currentIndex = 0;
        let currentPdfDocument = null; // Almacena la referencia al documento PDF cargado

        marginRange.addEventListener('input', () => { rangeValueSpan.textContent = marginRange.value; });
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                handleFileSelection();
            }
        });
        fileInput.addEventListener('change', handleFileSelection);

        // --- Modificación: Asociar el procesamiento al botón después de cargar ---
        processButton.addEventListener('click', () => {
            if (currentPdfDocument) {
                processPDF(currentPdfDocument);
            } else {
                suggestion.innerHTML = '<i class="fas fa-exclamation-circle"></i> Primero carga un archivo PDF.';
                suggestion.style.display = 'block';
            }
        });


        async function handleFileSelection() {
            const file = fileInput.files[0];
            if (!file || file.type !== 'application/pdf') {
                suggestion.innerHTML = '<i class="fas fa-exclamation-circle"></i> Por favor, sube un archivo PDF válido.';
                suggestion.style.display = 'block';
                currentPdfDocument = null; // Resetea el PDF cargado
                // Reset UI related to processing
                output.innerHTML = '';
                output.style.display = 'none';
                stats.style.display = 'none';
                imageContainer.style.display = 'none';
                downloadAllButton.style.display = 'none';
                return;
            }
            suggestion.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando el archivo...';
            suggestion.style.display = 'block';
            // Reset previous results immediately
            output.innerHTML = '';
            output.style.display = 'none';
            stats.style.display = 'none';
            imageContainer.style.display = 'none';
            downloadAllButton.style.display = 'none';
            singlePageImages = [];
            processedImages = [];
            currentIndex = 0;

            try {
                const arrayBuffer = await file.arrayBuffer();
                currentPdfDocument = await pdfjsLib.getDocument(arrayBuffer).promise; // Almacena la referencia
                suggestion.innerHTML = `<i class="fas fa-check-circle"></i> PDF cargado (${currentPdfDocument.numPages} páginas). Listo para procesar.`;
                 // No se llama a processPDF aquí, el usuario usará el botón
            } catch (error) {
                suggestion.innerHTML = '<i class="fas fa-times-circle"></i> Error al cargar el archivo PDF.';
                console.error("Error al cargar PDF:", error);
                currentPdfDocument = null; // Resetea en caso de error
            }
        }

        async function processPDF(pdf) { // Ahora recibe el PDF como argumento
            output.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando PDF...';
            output.style.display = 'block';
            imageContainer.style.display = 'none';
            stats.style.display = 'none';
            singlePageImages = [];
            processedImages = [];
            currentIndex = 0;
            downloadAllButton.style.display = 'none';

            try {
                const numPages = pdf.numPages;
                let processedPages = 0;
                let blankPages = 0;
                const pagesMode = parseInt(document.querySelector('input[name="pagesMode"]:checked').value, 10);

                for (let i = 1; i <= numPages; i++) {
                    output.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Procesando página ${i} de ${numPages}...`;
                    const isBlank = await processPage(pdf, i); // processPage ahora también usa el pdf pasado
                    if (isBlank) {
                        blankPages++;
                    } else {
                        processedPages++;
                    }
                }

                if (pagesMode === 1) {
                    processedImages = singlePageImages;
                } else if (pagesMode === 4 && singlePageImages.length > 0) {
                    let index = 0;
                    while (index < singlePageImages.length) {
                        const group = singlePageImages.slice(index, index + 4);
                        if (group.length === 4) {
                            const collage = await createCollageOfFour(group);
                            processedImages.push(collage);
                            index += 4;
                        } else {
                            processedImages.push(...group);
                            break;
                        }
                    }
                 } else {
                     processedImages = singlePageImages;
                 }


                processedStat.textContent = processedPages;
                blankStat.textContent = blankPages;
                stats.style.display = 'flex';
                output.innerHTML = '<i class="fas fa-check-circle"></i> Proceso completado.';

                if (processedImages.length > 0) {
                    currentIndex = 0;
                    totalImages.textContent = processedImages.length;
                    showImage(currentIndex);
                    imageContainer.style.display = 'block';
                    downloadAllButton.style.display = 'inline-flex';
                } else {
                    imageContainer.style.display = 'none';
                    downloadAllButton.style.display = 'none';
                    output.innerHTML += '<br>No se extrajeron imágenes con contenido.';
                }
            } catch (error) {
                output.innerHTML = `<i class="fas fa-times-circle"></i> Error durante el procesamiento: ${error.message}`;
                console.error('Error procesando PDF:', error);
            }
        }

        async function processPage(pdf, pageNumber) {
            const page = await pdf.getPage(pageNumber);
            const scale = 3;
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

            if (isPageBlank(imageData)) {
                return true;
            }

            const bounds = findContentBounds(imageData);
            // Skip if bounds are invalid (e.g., width or height is 0 or less)
            if (bounds.width <= 0 || bounds.height <= 0) {
                 console.warn(`Página ${pageNumber}: Contenido no encontrado o inválido después del recorte. Omitiendo.`);
                 return true; // Tratar como en blanco si no se puede recortar
             }

            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = bounds.width;
            croppedCanvas.height = bounds.height;
            const croppedContext = croppedCanvas.getContext('2d');

            croppedContext.drawImage(
                canvas,
                bounds.left, bounds.top,
                bounds.width, bounds.height,
                0, 0,
                bounds.width, bounds.height
            );

            const dataUrl = croppedCanvas.toDataURL('image/png');
            singlePageImages.push({ name: `pagina_${pageNumber}.png`, dataUrl: dataUrl });
            return false;
        }

        function isPageBlank(imageData) {
            const { data, width, height } = imageData;
            const threshold = 245;
            const sampleSize = 100;
            let whitePixels = 0;

            for (let i = 0; i < sampleSize; i++) {
                const randomX = Math.floor(Math.random() * width);
                const randomY = Math.floor(Math.random() * height);
                const index = (randomY * width + randomX) * 4;
                if (data[index] > threshold && data[index + 1] > threshold && data[index + 2] > threshold) {
                    whitePixels++;
                }
            }
            return (whitePixels / sampleSize) > 0.98;
        }

        function findContentBounds(imageData) {
            const { data, width, height } = imageData;
            let initialMargin;
             try {
                 initialMargin = parseInt(marginRange.value, 10); // Asegura que es un número
                 if (isNaN(initialMargin)) throw new Error("Invalid margin value");
             } catch (e) {
                 console.warn("Using default margin due to error:", e);
                 initialMargin = 150; // Fallback
             }

             let minX = width, minY = height, maxX = 0, maxY = 0;
             const threshold = 200;
             const extraMargin = 5;

            // Ensure margin doesn't exceed half the dimension
             const safeMarginX = Math.min(initialMargin, Math.floor(width / 2) - 1);
             const safeMarginY = Math.min(initialMargin, Math.floor(height / 2) - 1);

            for (let y = safeMarginY; y < height - safeMarginY; y++) {
                for (let x = safeMarginX; x < width - safeMarginX; x++) {
                    const i = (y * width + x) * 4;
                    if (data[i] < threshold || data[i + 1] < threshold || data[i + 2] < threshold) {
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }

             // Check if any content was found
            if (maxX < minX || maxY < minY) {
                console.warn("No content found within specified margins. Returning full page bounds (minus margins).");
                 // Return bounds based on margins if no content pixel was dark enough
                return {
                    left: safeMarginX,
                    top: safeMarginY,
                    width: Math.max(0, width - 2 * safeMarginX),
                    height: Math.max(0, height - 2 * safeMarginY)
                 };
             }


            const left = Math.max(safeMarginX, minX - extraMargin);
            const top = Math.max(safeMarginY, minY - extraMargin);
            const right = Math.min(width - safeMarginX - 1, maxX + extraMargin);
            const bottom = Math.min(height - safeMarginY - 1, maxY + extraMargin);

            return {
                left: left,
                top: top,
                width: Math.max(0, right - left + 1),
                height: Math.max(0, bottom - top + 1)
            };
        }

        async function createCollageOfFour(imagesGroup) {
            const collageWidth = 1275;
            const collageHeight = 1650;
            const collageCanvas = document.createElement('canvas');
            collageCanvas.width = collageWidth;
            collageCanvas.height = collageHeight;
            const collageContext = collageCanvas.getContext('2d');
            collageContext.fillStyle = 'white'; // Fill background white in case images have transparency
            collageContext.fillRect(0, 0, collageWidth, collageHeight);

            const quadrantWidth = collageWidth / 2;
            const quadrantHeight = collageHeight / 2;

            for (let i = 0; i < imagesGroup.length; i++) {
                const imageData = imagesGroup[i];
                const imageEl = new Image();
                // Promisify image loading
                await new Promise((resolve, reject) => {
                     imageEl.onload = resolve;
                     imageEl.onerror = reject; // Handle potential loading errors
                     imageEl.src = imageData.dataUrl;
                 });


                const row = Math.floor(i / 2);
                const col = i % 2;
                const dx = col * quadrantWidth;
                const dy = row * quadrantHeight;

                // Draw image centered within the quadrant, maintaining aspect ratio
                const aspectRatio = imageEl.width / imageEl.height;
                let drawWidth = quadrantWidth;
                let drawHeight = quadrantHeight;

                if (quadrantWidth / quadrantHeight > aspectRatio) {
                    // Quadrant is wider than image aspect ratio
                    drawWidth = quadrantHeight * aspectRatio;
                } else {
                    // Quadrant is taller or equal aspect ratio
                    drawHeight = quadrantWidth / aspectRatio;
                }

                // Calculate centering offsets
                const offsetX = dx + (quadrantWidth - drawWidth) / 2;
                const offsetY = dy + (quadrantHeight - drawHeight) / 2;

                collageContext.drawImage(imageEl, offsetX, offsetY, drawWidth, drawHeight);
            }

            const pageNumberMatch = imagesGroup[0].name.match(/pagina_(\d+)/);
            const collageName = pageNumberMatch
                ? `collage_pag_${pageNumberMatch[1]}.png`
                : `collage_${Date.now()}.png`; // Fallback name

            return {
                name: collageName,
                dataUrl: collageCanvas.toDataURL('image/png')
            };
        }

        function showImage(index) {
            if (!processedImages || processedImages.length === 0 || index < 0 || index >= processedImages.length) {
                imageContainer.style.display = 'none';
                return;
            }
            const imageData = processedImages[index];
            currentImage.src = imageData.dataUrl;
            currentImage.alt = imageData.name || `Imagen ${index + 1}`;
            currentImageIndex.textContent = index + 1;
            totalImages.textContent = processedImages.length;

            prevButton.disabled = (index === 0);
            nextButton.disabled = (index === processedImages.length - 1);
            imageContainer.style.display = 'block';
        }

        prevButton.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                showImage(currentIndex);
            }
        });
        nextButton.addEventListener('click', () => {
            if (currentIndex < processedImages.length - 1) {
                currentIndex++;
                showImage(currentIndex);
            }
        });

         // --- Toast Notification Function ---
         function showToast(message) {
             const toast = document.createElement('div');
             toast.className = 'toast-notification';
             toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
             document.body.appendChild(toast);

             // Trigger fade in
             setTimeout(() => {
                 toast.classList.add('show');
             }, 10); // Small delay to allow CSS transition

             // Set timeout to fade out and remove
             setTimeout(() => {
                 toast.classList.remove('show');
                 // Remove element after transition ends
                 toast.addEventListener('transitionend', () => {
                     if (toast.parentNode) { // Check if it hasn't been removed already
                         document.body.removeChild(toast);
                     }
                 });
                 // Fallback removal if transitionend doesn't fire (e.g., element removed by other means)
                  setTimeout(() => {
                     if (toast.parentNode) {
                          document.body.removeChild(toast);
                     }
                  }, 600); // Slightly longer than transition duration (0.5s)
             }, 2000); // Duration toast is visible
         }

        currentImage.addEventListener('click', async () => {
            if (!processedImages || processedImages.length === 0 || !navigator.clipboard || !navigator.clipboard.write) {
                 console.warn("Clipboard API not available or no image selected.");
                 // Optionally show a message to the user
                 // showToast("Error: No se puede copiar al portapapeles.");
                 return;
             }
            try {
                const dataUrl = processedImages[currentIndex].dataUrl;
                const blob = await (await fetch(dataUrl)).blob();

                // Check if the browser supports writing PNG directly
                 let clipboardItemInput;
                 if (ClipboardItem && blob.type === 'image/png') {
                     clipboardItemInput = { [blob.type]: blob };
                 } else {
                     // Fallback for browsers that might not handle PNG directly in ClipboardItem
                     // Or if the blob type is somehow different
                     console.warn("Attempting to write blob with potentially unsupported type or no ClipboardItem support:", blob.type);
                     // This might still work in some browsers, but it's less standard
                     clipboardItemInput = { [blob.type || 'application/octet-stream']: blob };
                 }

                const clipboardItem = new ClipboardItem(clipboardItemInput);
                await navigator.clipboard.write([clipboardItem]);

                console.log('Imagen copiada al portapapeles.');
                showToast('¡Imagen copiada!'); // Use the toast function

                // Advance to next image only if copy was successful
                if (currentIndex < processedImages.length - 1) {
                    currentIndex++;
                    showImage(currentIndex);
                }
            } catch (error) {
                console.error('Error al copiar la imagen:', error);
                showToast('Error al copiar imagen.'); // Show error toast
            }
        });

        async function downloadAllImages() {
            if (!processedImages || processedImages.length === 0) return;

            const zip = new JSZip();
            processedImages.forEach((image) => { // No need for index here
                const base64Data = image.dataUrl.split(',')[1];
                // Sanitize filename: replace potentially problematic characters
                 let safeFileName = (image.name || `imagen_${Date.now()}.png`).replace(/[^a-z0-9_.\-]/gi, '_');
                zip.file(safeFileName, base64Data, { base64: true });
            });

            output.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando archivo ZIP...';
            try {
                const content = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'imagenes_extraidas.zip';
                link.click();
                URL.revokeObjectURL(link.href);
                output.innerHTML = '<i class="fas fa-check-circle"></i> Archivo ZIP generado.';
            } catch (error) {
                 output.innerHTML = '<i class="fas fa-times-circle"></i> Error generando ZIP.';
                 console.error("Error generando ZIP:", error);
            }
        }
        downloadAllButton.addEventListener('click', downloadAllImages);

    </script>

</body>
</html>
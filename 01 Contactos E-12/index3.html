<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informe Policial</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilos base (móvil primero) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0.5rem;
        }
        .container {
            max-width: 1000px;
            margin: 10px auto;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* Títulos de sección y subsección */
        .section-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .cai-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #374151;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .subsection-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #374151;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
        }
        /* Campos de entrada y áreas de texto */
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        /* Estilos para botones */
        .btn {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 38px;
            min-height: 38px;
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            gap: 0.3rem;
            min-width: 32px;
            min-height: 32px;
        }
        .btn-float {
            border-radius: 9999px;
            width: 56px;
            height: 56px;
            padding: 0;
            font-size: 1.25rem;
        }
        .btn-primary { background-color: #2563eb; color: #ffffff; }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .btn-secondary { background-color: #6b7280; color: #ffffff; }
        .btn-secondary:hover { background-color: #4b5563; transform: translateY(-1px); }
        .btn-danger { background-color: #ef4444; color: #ffffff; }
        .btn-danger:hover { background-color: #dc2626; transform: translateY(-1px); }
        .btn-success { background-color: #22c55e; color: #ffffff; }
        .btn-success:hover { background-color: #16a34a; }
        
        /* **NUEVO**: Estilo para botones flotantes azul oscuro */
        .btn-dark-blue { background-color: #1e40af; color: #ffffff; }
        .btn-dark-blue:hover { background-color: #1e3a8a; }

        /* Estilos para tarjetas de contenido */
        .card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        /* Estilos para la salida del informe */
        .report-output {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            min-height: 150px;
            font-family: monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            color: #374151;
        }
        
        /* Estilos para Búsqueda de Personal */
        .search-result-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background-color: #fff;
        }
        .search-result-item .info {
            font-size: 0.9rem;
            flex-grow: 1;
        }
        .search-result-item .status {
             font-size: 0.8rem;
             width: 100%;
             margin-top: 0.25rem;
        }
        .search-result-item .status-assigned { color: #ef4444; font-weight: 600; }
        .search-result-item .status-free { color: #22c55e; font-weight: 600; }

        /* --- Estilos para el Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .modal-message {
            font-size: 0.9rem;
            color: #4b5563;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        /* Estilos para el mensaje de copiado */
        .copy-feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1001;
        }
        .copy-feedback.show { opacity: 1; visibility: visible; }

        /* --- ESTILOS PARA SELECTOR CON BÚSQUEDA --- */
        .search-select-container {
            position: relative;
            width: 100%;
        }
        .search-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1010;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-select-option {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .search-select-option:hover {
            background-color: #f0f2f5;
        }
        .search-select-clear-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0 0.25rem;
        }
        .search-select-clear-btn:hover {
            color: #374151;
        }

        /* Ajustes para pantallas más grandes (Desktop) */
        @media (min-width: 640px) {
            body { padding: 2rem; }
            .container { margin: 20px auto; padding: 20px; }
            .section-title { font-size: 1.5rem; }
            .cai-section-title { font-size: 1.25rem; }
            .subsection-title { font-size: 1.25rem; }
            .input-field { padding: 0.75rem 1rem; font-size: 1rem; }
            .btn { padding: 0.75rem 1.25rem; font-size: 1rem; min-width: 44px; min-height: 44px; }
            .btn-sm { padding: 0.5rem 1rem; font-size: 0.9rem; }
            .report-output { padding: 1.5rem; min-height: 200px; font-size: 1rem; }
            .modal-content { padding: 2rem; }
            .modal-title { font-size: 1.75rem; }
            .modal-message { font-size: 1rem; }
            .modal-input { padding: 0.75rem 1rem; font-size: 1rem; }
            .search-result-item .status { width: auto; margin-top: 0; }
        }

        /* **NUEVO**: Media query para reducir botones flotantes en pantallas pequeñas */
        @media (max-width: 639px) {
            .btn-float {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body class="p-4">

    <!-- Botones Flotantes -->
    <div style="position: fixed; top: 50%; left: 20px; transform: translateY(-50%); z-index: 999;" class="flex flex-col gap-3">
        <button onclick="openConfigModal()" class="btn btn-dark-blue btn-float shadow-lg" title="Configuración">
            <i class="fas fa-cog"></i>
        </button>
        <button onclick="downloadData()" class="btn btn-dark-blue btn-float shadow-lg" title="Descargar Datos">
            <i class="fas fa-download"></i>
        </button>
        <label for="uploadFile" class="btn btn-dark-blue btn-float shadow-lg cursor-pointer" title="Cargar Datos">
            <i class="fas fa-upload"></i>
        </label>
        <input type="file" id="uploadFile" class="hidden" accept=".json" onchange="handleFileUpload(event)">
        <button onclick="openSearchModal()" class="btn btn-dark-blue btn-float shadow-lg" title="Buscar Personal">
            <i class="fas fa-search"></i>
        </button>
        <button onclick="openReportModal()" class="btn btn-dark-blue btn-float shadow-lg" title="Generar Informe">
            <i class="fas fa-file-alt"></i>
        </button>
    </div>

    <div class="container">
        <!-- Sección de Equipos y Grupos -->
        <div class="mb-8 p-6 bg-green-50 rounded-lg shadow-inner">
            <h2 class="section-title text-green-800">
                Zonas de Atención
            </h2>
            <div id="assignmentSectionContent">
                <!-- Secciones CAI -->
                <div id="caiSectionsContainer">
                    <!-- Las secciones CAI se renderizarán aquí -->
                </div>
                <button onclick="addCaiSection()" class="btn btn-primary mt-4"><i class="fas fa-plus"></i></button>

                <!-- Otros Grupos -->
                <div class="mt-8">
                    <h3 class="subsection-title">Otros Grupos</h3>
                    <div id="otherGroupsContainer">
                        <!-- Otros grupos se renderizarán aquí -->
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <input type="text" id="newGroupName" class="input-field flex-grow" placeholder="Nombre del nuevo grupo" aria-label="Nuevo Nombre del Grupo">
                        <button onclick="addOtherGroup()" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación/Prompt -->
    <div id="customModalOverlay" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalMessage" class="modal-message"></p>
            <input type="text" id="modalInput" class="modal-input hidden">
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn btn-primary hidden">Aceptar</button>
                <button id="modalCancelBtn" class="btn btn-secondary hidden">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Búsqueda -->
    <div id="searchModalOverlay" class="modal-overlay" onclick="if(event.target === this) closeSearchModal()">
        <div class="modal-content w-full max-w-lg">
             <div class="flex justify-between items-center mb-4">
                <h3 class="modal-title text-left !mb-0">Búsqueda de Personal</h3>
                <button onclick="closeSearchModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="personnelSearch" class="input-field" placeholder="Escriba grado o nombre..." oninput="renderPersonnelSearch()">
            </div>
            <div id="personnelSearchResults" class="mt-4 max-h-[60vh] overflow-y-auto">
                <!-- Los resultados de la búsqueda aparecerán aquí -->
            </div>
        </div>
    </div>

    <!-- Modal de Configuración -->
    <div id="configModalOverlay" class="modal-overlay" onclick="if(event.target === this) closeConfigModal()">
        <div class="modal-content w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="modal-title text-left !mb-0">Configuración</h3>
                <button onclick="closeConfigModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <!-- Contenido de Configuración -->
            <div class="max-h-[70vh] overflow-y-auto pr-2">
                <!-- Comandante -->
                <div class="mb-4">
                    <label for="commanderRank" class="block text-gray-700 font-medium mb-2">Grado del Comandante:</label>
                    <input type="text" id="commanderRank" class="input-field" value="" onchange="saveData()">
                </div>
                <div class="mb-4">
                    <label for="commanderName" class="block text-gray-700 font-medium mb-2">Nombre del Comandante:</label>
                    <input type="text" id="commanderName" class="input-field" value="" onchange="saveData()">
                </div>

                <!-- Servicios de Importancia -->
                <div class="mb-6">
                    <h3 class="subsection-title">Servicios de Importancia <span class="text-sm text-gray-500">(uno por línea)</span></h3>
                    <textarea id="importantServices" class="input-field min-h-[120px]" onchange="saveData()"></textarea>
                </div>

                <!-- Gestión de Personal -->
                <div class="mb-6">
                    <h3 class="subsection-title">Gestión de Personal <span class="text-sm text-gray-500">(uno por línea: GRADO NOMBRE APELLIDO)</span></h3>
                    <div class="flex gap-4 mb-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="personnelListSelector" value="list1" class="form-radio" onchange="switchPersonnelList('list1')">
                            <span class="ml-2 text-gray-700">Lista 1</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="personnelListSelector" value="list2" class="form-radio" onchange="switchPersonnelList('list2')">
                            <span class="ml-2 text-gray-700">Lista 2</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="personnelListSelector" value="list3" class="form-radio" onchange="switchPersonnelList('list3')">
                            <span class="ml-2 text-gray-700">Lista 3</span>
                        </label>
                    </div>
                    <textarea id="personnelTextarea" class="input-field min-h-[150px]" onchange="saveData()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Informe Generado -->
    <div id="reportModalOverlay" class="modal-overlay" onclick="if(event.target === this) closeReportModal()">
        <div class="modal-content w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="modal-title text-left !mb-0">Informe Generado</h3>
                <div class="flex gap-2">
                    <button onclick="copyReport()" class="btn btn-secondary btn-sm" title="Copiar informe">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                    <button onclick="closeReportModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
            </div>
            <pre id="reportOutput" class="report-output max-h-[60vh] overflow-y-auto"></pre>
        </div>
    </div>


    <!-- Feedback de copiado -->
    <div id="copyFeedback" class="copy-feedback">
        ¡Copiado!
    </div>

    <script>
        let scrollPosition = 0;

        // --- Selectores de Elementos del DOM ---
        const customModalOverlay = document.getElementById('customModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const searchModalOverlay = document.getElementById('searchModalOverlay');
        const configModalOverlay = document.getElementById('configModalOverlay');
        const reportModalOverlay = document.getElementById('reportModalOverlay');

        // Función para generar un ID único
        function generateUniqueId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Función para categorizar personal por empleo
        function getPersonnelCategory(grade) {
            const oficiales = ["CR", "TC", "MY", "CT", "TE", "ST"];
            const suboficiales = ["CM", "SC", "IJ", "IT", "SI"];
            const patrulleros = ["PT", "PP"];

            if (oficiales.includes(grade.toUpperCase())) return "Oficiales";
            if (suboficiales.includes(grade.toUpperCase())) return "Suboficiales";
            if (patrulleros.includes(grade.toUpperCase())) return "Patrulleros";
            return "Desconocido";
        }

        // Función de formato de título inteligente
        function toTitleCaseSmart(str) {
            if (!str || typeof str !== 'string') return '';
            
            const minorWords = new Set(['de', 'a', 'en', 'y', 'e', 'o', 'u', 'el', 'la', 'los', 'las', 'un', 'una']);
            const acronyms = new Set(['CAI', 'E-12']);

            return str.split(' ').map((word, index) => {
                const upperWord = word.toUpperCase();
                if (acronyms.has(upperWord)) {
                    return upperWord;
                }
                
                const lowerWord = word.toLowerCase();
                if (index > 0 && minorWords.has(lowerWord)) {
                    return lowerWord;
                }
                
                return lowerWord.charAt(0).toUpperCase() + lowerWord.slice(1);
            }).join(' ');
        }

        // --- ESTRUCTURA DE DATOS ---
        // Plantilla para la configuración de una lista individual
        const defaultConfig = {
            commanderName: "", commanderRank: "", importantServices: [],
            caiSections: [
                { id: generateUniqueId(), name: "CAI - MODELO", teams: [ { id: generateUniqueId(), name: "11-13", members: [] }, { id: generateUniqueId(), name: "12-14", members: [] }, { id: generateUniqueId(), name: "15-16", members: [] } ] },
                { id: generateUniqueId(), name: "CAI - ALCAZARES", teams: [ { id: generateUniqueId(), name: "1", members: [] }, { id: generateUniqueId(), name: "2", members: [] } ] },
                { id: generateUniqueId(), name: "CAI - POLO CLUB", teams: [ { id: generateUniqueId(), name: "6-7", members: [] }, { id: generateUniqueId(), name: "8", members: [] } ] },
                { id: generateUniqueId(), name: "CAI - RIONEGRO", teams: [ { id: generateUniqueId(), name: "9", members: [] }, { id: generateUniqueId(), name: "10", members: [] } ] },
                { id: generateUniqueId(), name: "CAI - 7 DE AGOSTO", teams: [ { id: generateUniqueId(), name: "3", members: [] }, { id: generateUniqueId(), name: "4-5", members: [] } ] }
            ],
            otherGroups: [
                { id: generateUniqueId(), name: "Jefe de Vigilancia", members: [], defaultName: "Jefe de Vigilancia" }, { id: generateUniqueId(), name: "Zona T", members: [], defaultName: "Zona T" }, { id: generateUniqueId(), name: "Jefe de información E-12 y Centinelas", members: [], defaultName: "Jefe de información E-12 y Centinelas" }, { id: generateUniqueId(), name: "Custodios E-12", members: [], defaultName: "Custodios E-12" }, { id: generateUniqueId(), name: "CAI - ALCAZARES (Información)", members: [], defaultName: "CAI - ALCAZARES (Información)" }, { id: generateUniqueId(), name: "CAI - MODELO (Información)", members: [], defaultName: "CAI - MODELO (Información)" }, { id: generateUniqueId(), name: "CAI - POLO CLUB (Información)", members: [], defaultName: "CAI - POLO CLUB (Información)" }, { id: generateUniqueId(), name: "CAI - RIONEGRO (Información)", members: [], defaultName: "CAI - RIONEGRO (Información)" }, { id: generateUniqueId(), name: "CAI - 7 DE AGOSTO (Información)", members: [], defaultName: "CAI - 7 DE AGOSTO (Información)" }, { id: generateUniqueId(), name: "Vacaciones", members: [], defaultName: "Vacaciones" }, { id: generateUniqueId(), name: "Excusado", members: [], defaultName: "Excusado" }, { id: generateUniqueId(), name: "Calamidad", members: [], defaultName: "Calamidad" }
            ],
            uiState: { collapsedCaiSections: {} }
        };

        // Estructura de estado inicial completa de la aplicación
        const initialFullState = {
            allPersonnelLists: { list1: [], list2: [], list3: [] },
            configurations: {
                list1: JSON.parse(JSON.stringify(defaultConfig)),
                list2: JSON.parse(JSON.stringify(defaultConfig)),
                list3: JSON.parse(JSON.stringify(defaultConfig))
            },
            currentListId: 'list1'
        };
        // Inicializar el estado de la UI para cada configuración por defecto
        Object.values(initialFullState.configurations).forEach(config => {
            config.caiSections.forEach(cai => {
                config.uiState.collapsedCaiSections[cai.id] = true;
            });
        });

        let fullState = {};
        let appData = {}; // Puntero a la configuración actual
        let modalCallback = null;

        // --- Funciones para Modales ---
        function showModal(title, message, type, defaultValue = '', callback) {
            scrollPosition = window.scrollY;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCallback = callback;

            modalInput.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            if (type === 'prompt') {
                modalInput.value = defaultValue;
                modalInput.classList.remove('hidden');
                modalConfirmBtn.textContent = 'Aceptar';
                modalConfirmBtn.classList.remove('hidden');
            } else if (type === 'confirm') {
                modalConfirmBtn.textContent = 'Sí';
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.textContent = 'No';
                modalCancelBtn.classList.remove('hidden');
            }

            customModalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            if (type === 'prompt') modalInput.focus();
        }

        function closeModal() {
            customModalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            window.scrollTo(0, scrollPosition);
        }

        modalConfirmBtn.onclick = () => {
            closeModal();
            if (modalCallback) modalCallback(!modalInput.classList.contains('hidden') ? modalInput.value : true);
        };
        modalCancelBtn.onclick = () => {
            closeModal();
            if (modalCallback) modalCallback(false);
        };
        
        function openSearchModal() {
            scrollPosition = window.scrollY;
            searchModalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.getElementById('personnelSearch').focus();
            renderPersonnelSearch();
        }

        function closeSearchModal() {
            searchModalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            window.scrollTo(0, scrollPosition);
        }
        
        function openConfigModal() {
            scrollPosition = window.scrollY;
            configModalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeConfigModal() {
            configModalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            window.scrollTo(0, scrollPosition);
        }

        function openReportModal() {
            generateReport();
            scrollPosition = window.scrollY;
            reportModalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeReportModal() {
            reportModalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            window.scrollTo(0, scrollPosition);
        }


        // --- Gestión de Datos ---
        function loadData() {
            const storedState = localStorage.getItem('policeReportFullState');
            if (storedState) {
                fullState = JSON.parse(storedState);
                if (!fullState.configurations || !fullState.allPersonnelLists || !fullState.currentListId) {
                    fullState = JSON.parse(JSON.stringify(initialFullState));
                }
            } else {
                fullState = JSON.parse(JSON.stringify(initialFullState));
            }
            appData = fullState.configurations[fullState.currentListId];
            renderUI();
        }
        
        function updatePersonnelDataFromDOM() {
            const personnelText = document.getElementById('personnelTextarea').value;
            const lines = personnelText.split('\n').map(line => line.trim()).filter(line => line !== '');
            const currentPersonnelList = fullState.allPersonnelLists[fullState.currentListId] || [];
            const newPersonnelData = [];
            const existingPersonnelMap = new Map(currentPersonnelList.map(p => [`${p.grade.toUpperCase()} ${p.name.toUpperCase()}`, p]));

            lines.forEach(line => {
                const parts = line.split(' ');
                if (parts.length >= 2) {
                    const grade = parts[0].trim();
                    const name = parts.slice(1).join(' ').trim();
                    const key = `${grade.toUpperCase()} ${name.toUpperCase()}`;
                    if (existingPersonnelMap.has(key)) {
                        const existingPerson = existingPersonnelMap.get(key);
                        existingPerson.grade = grade;
                        existingPerson.name = name;
                        existingPerson.category = getPersonnelCategory(grade);
                        newPersonnelData.push(existingPerson);
                        existingPersonnelMap.delete(key);
                    } else {
                        newPersonnelData.push({ id: generateUniqueId(), grade: grade, name: name, assigned: false, category: getPersonnelCategory(grade) });
                    }
                }
            });
            fullState.allPersonnelLists[fullState.currentListId] = newPersonnelData;
        }

        function saveDataToLocalStorage() {
            fullState.configurations[fullState.currentListId] = appData;
            localStorage.setItem('policeReportFullState', JSON.stringify(fullState));
        }

        function commitAndRender() {
            saveDataToLocalStorage();
            renderUI();
        }

        function saveData() {
            appData.commanderRank = document.getElementById('commanderRank').value;
            appData.commanderName = document.getElementById('commanderName').value;
            appData.importantServices = document.getElementById('importantServices').value.split('\n').filter(line => line.trim() !== '');
            updatePersonnelDataFromDOM();
            commitAndRender();
        }

        // --- Lógica de Renderizado de UI ---
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return "buenos días";
            if (hour >= 12 && hour < 19) return "buenas tardes";
            return "buenas noches";
        }

        function createSearchableSelect(selectedPersonId = '', onChangeCallback) {
            const container = document.createElement('div');
            container.className = 'search-select-container';

            const currentPersonnelList = fullState.allPersonnelLists[fullState.currentListId];
            const selectedPerson = currentPersonnelList.find(p => p.id === selectedPersonId);

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-field';
            input.value = selectedPerson ? `${selectedPerson.grade.toUpperCase()} ${selectedPerson.name}` : '';
            input.placeholder = '-- Buscar y seleccionar --';
            input.autocomplete = 'off';

            const dropdown = document.createElement('div');
            dropdown.className = 'search-select-dropdown';
            
            const availablePersonnel = currentPersonnelList.filter(p => !p.assigned || p.id === selectedPersonId);
            availablePersonnel.sort((a, b) => a.grade.localeCompare(b.grade) || a.name.localeCompare(b.name));

            if (availablePersonnel.length === 0) {
                const noOpt = document.createElement('div');
                noOpt.className = 'search-select-option text-gray-500';
                noOpt.textContent = 'No hay personal disponible';
                dropdown.appendChild(noOpt);
            } else {
                availablePersonnel.forEach(person => {
                    const option = document.createElement('div');
                    option.className = 'search-select-option';
                    option.textContent = `${person.grade.toUpperCase()} ${person.name}`;
                    option.dataset.id = person.id;
                    
                    option.onclick = () => {
                        onChangeCallback(person.id);
                    };
                    dropdown.appendChild(option);
                });
            }

            input.onfocus = () => {
                document.querySelectorAll('.search-select-dropdown').forEach(d => d.style.display = 'none');
                dropdown.style.display = 'block';
                input.select();
            };

            input.oninput = () => {
                const searchTerm = input.value.toLowerCase();
                dropdown.querySelectorAll('.search-select-option').forEach(opt => {
                    const text = opt.textContent.toLowerCase();
                    opt.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            };
            
            container.appendChild(input);
            container.appendChild(dropdown);

            if (selectedPerson) {
                const clearBtn = document.createElement('button');
                clearBtn.innerHTML = '&times;';
                clearBtn.className = 'search-select-clear-btn';
                clearBtn.title = 'Desasignar';
                clearBtn.onclick = (e) => {
                    e.stopPropagation();
                    onChangeCallback('');
                };
                container.appendChild(clearBtn);
            }
            
            return container;
        }

        function updatePersonnelAssignedStatus() {
            const currentPersonnelList = fullState.allPersonnelLists[fullState.currentListId];
            if (!currentPersonnelList) return;
            
            currentPersonnelList.forEach(p => p.assigned = false);
            
            appData.caiSections.forEach(cai => cai.teams.forEach(team => team.members.forEach(memberId => {
                const person = currentPersonnelList.find(p => p.id === memberId);
                if (person) person.assigned = true;
            })));
            appData.otherGroups.forEach(group => group.members.forEach(memberId => {
                const person = currentPersonnelList.find(p => p.id === memberId);
                if (person) person.assigned = true;
            }));
        }

        // --- Renderizado de Componentes Específicos (CAI, Grupos, etc.) ---
        
        function renderCaiSections() {
            const container = document.getElementById('caiSectionsContainer');
            container.innerHTML = '';
            appData.caiSections.forEach(cai => {
                const caiDiv = document.createElement('div');
                caiDiv.id = `cai-${cai.id}`;
                caiDiv.className = 'card mb-6';
                caiDiv.innerHTML = `
                    <div class="cai-section-title" onclick="toggleCaiSection('${cai.id}')">
                        <input type="text" value="${cai.name}" class="font-semibold input-field flex-grow mr-2 mb-2 sm:mb-0" onchange="updateCaiName('${cai.id}', this.value)" onclick="event.stopPropagation();">
                        <i id="caiToggleIcon-${cai.id}" class="fas fa-chevron-up ml-2"></i>
                    </div>
                    <div id="caiContent-${cai.id}">
                        <div id="cai-teams-${cai.id}"></div>
                        <button onclick="addCaiTeam('${cai.id}')" class="btn btn-secondary btn-sm mt-4"><i class="fas fa-plus"></i></button>
                        <div id="cai-info-${cai.id}" class="mt-6"></div>
                    </div>`;
                container.appendChild(caiDiv);
                renderCaiTeams(cai.id);
                renderCaiInfoSection(cai.id, cai.name);
                applyCaiSectionState(cai.id);
            });
        }

        function renderCaiInfoSection(caiId, caiName) {
            const container = document.getElementById(`cai-info-${caiId}`);
            if (!container) return;
            const infoGroupName = `${caiName} (Información)`;
            const infoGroup = appData.otherGroups.find(g => g.name === infoGroupName);
            if (infoGroup) {
                container.innerHTML = `
                    <h3 class="subsection-title">Información de ${caiName.replace('CAI - ', '')}</h3>
                    <div id="cai-info-members-container-${infoGroup.id}" class="mb-3"></div>
                    <button onclick="addMemberToOtherGroup('${infoGroup.id}')" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i></button>`;
                renderOtherGroupMembers(infoGroup.id);
            } else {
                container.innerHTML = `<p class="text-gray-500 text-sm">No hay sección de información para este CAI.</p>`;
            }
        }

        function renderCaiTeams(caiId) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (!cai) return;
            const container = document.getElementById(`cai-teams-${cai.id}`);
            container.innerHTML = '';
            cai.teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'card bg-white p-4 mb-3';
                teamDiv.innerHTML = `
                    <div class="flex justify-between items-center gap-2 mb-3">
                        <input type="text" value="${team.name}" class="font-semibold input-field flex-grow" onchange="updateCaiTeamName('${cai.id}', '${team.id}', this.value)">
                        <button onclick="deleteCaiTeam('${cai.id}', '${team.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div id="cai-${cai.id}-team-${team.id}-member1" class="flex-1"></div>
                        <div id="cai-${cai.id}-team-${team.id}-member2" class="flex-1"></div>
                    </div>`;
                container.appendChild(teamDiv);
                document.getElementById(`cai-${cai.id}-team-${team.id}-member1`).appendChild(createSearchableSelect(team.members[0], (personId) => updateCaiTeamMember(cai.id, team.id, 0, personId)));
                document.getElementById(`cai-${cai.id}-team-${team.id}-member2`).appendChild(createSearchableSelect(team.members[1], (personId) => updateCaiTeamMember(cai.id, team.id, 1, personId)));
            });
        }

        function renderOtherGroups() {
            const container = document.getElementById('otherGroupsContainer');
            container.innerHTML = '';
            const filteredOtherGroups = appData.otherGroups.filter(g => !g.name.includes("(Información)"));
            filteredOtherGroups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.id = `group-${group.id}`;
                groupDiv.className = 'card mb-6';
                groupDiv.innerHTML = `
                    <div class="flex justify-between items-center gap-2 mb-4">
                        <input type="text" value="${group.name}" class="subsection-title input-field flex-grow" onchange="updateOtherGroupName('${group.id}', this.value)">
                        <button onclick="deleteOtherGroup('${group.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="group-members-container-${group.id}" class="mb-3"></div>
                    <button onclick="addMemberToOtherGroup('${group.id}')" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i></button>`;
                container.appendChild(groupDiv);
                renderOtherGroupMembers(group.id);
            });
        }

        function renderOtherGroupMembers(groupId) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (!group) return;
            const containerId = group.name.includes("(Información)") ? `cai-info-members-container-${groupId}` : `group-members-container-${groupId}`;
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            group.members.forEach((memberId, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'mb-2';
                memberDiv.appendChild(createSearchableSelect(memberId, (personId) => updateOtherGroupMember(group.id, index, personId)));
                container.appendChild(memberDiv);
            });
        }

        function renderPersonnelSearch() {
            const searchInput = document.getElementById('personnelSearch');
            const resultsContainer = document.getElementById('personnelSearchResults');
            const searchTerm = searchInput.value.toLowerCase().trim();

            resultsContainer.innerHTML = '';
            const currentPersonnelList = fullState.allPersonnelLists[fullState.currentListId];
            if (!currentPersonnelList) return;
            
            const results = searchTerm ? currentPersonnelList.filter(p => p.name.toLowerCase().includes(searchTerm) || p.grade.toLowerCase().includes(searchTerm)) : currentPersonnelList;

            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No se encontraron funcionarios.</p>';
                return;
            }

            results.forEach(person => {
                const assignment = findAssignment(person.id);
                const resultDiv = document.createElement('div');
                resultDiv.className = 'search-result-item';
                resultDiv.innerHTML = `
                    <div class="info">
                        <strong>${person.grade} ${person.name}</strong>
                        <div class="status ${assignment ? 'status-assigned' : 'status-free'}">${assignment ? `Asignado a: ${assignment}` : 'Disponible'}</div>
                    </div>
                    ${assignment ? `<button onclick="unassignPersonnel('${person.id}')" class="btn btn-danger btn-sm">Desasignar</button>` : ''}`;
                resultsContainer.appendChild(resultDiv);
            });
        }

        // --- Lógica de Interacción del Usuario ---
        function updateCaiName(caiId, newName) { updatePersonnelDataFromDOM(); const cai = appData.caiSections.find(c => c.id === caiId); if (cai) { cai.name = newName.trim(); commitAndRender(); } }
        function addCaiSection() { updatePersonnelDataFromDOM(); showModal('Añadir Sección CAI', 'Ingrese el nombre de la nueva sección CAI (ej. CAI - NUEVO):', 'prompt', '', (newName) => { if (newName) { const newId = generateUniqueId(); appData.caiSections.push({ id: newId, name: newName.trim(), teams: [] }); appData.uiState.collapsedCaiSections[newId] = true; appData.otherGroups.push({ id: generateUniqueId(), name: `${newName.trim()} (Información)`, members: [] }); commitAndRender(); } }); }
        function deleteCaiSection(caiId) { updatePersonnelDataFromDOM(); showModal('Eliminar Sección CAI', '¿Seguro que quieres eliminar esta sección y sus equipos?', 'confirm', '', (confirmed) => { if (confirmed) { const cai = appData.caiSections.find(c => c.id === caiId); if (cai) appData.otherGroups = appData.otherGroups.filter(g => g.name !== `${cai.name} (Información)`); appData.caiSections = appData.caiSections.filter(c => c.id !== caiId); delete appData.uiState.collapsedCaiSections[caiId]; commitAndRender(); } }); }
        function updateCaiTeamName(caiId, teamId, newName) { updatePersonnelDataFromDOM(); const team = appData.caiSections.find(c => c.id === caiId)?.teams.find(t => t.id === teamId); if (team) { team.name = newName.trim(); commitAndRender(); } }
        function addCaiTeam(caiId) { updatePersonnelDataFromDOM(); const cai = appData.caiSections.find(c => c.id === caiId); if (cai) { showModal('Añadir Equipo', 'Ingrese el nombre del nuevo equipo (ej. 17-18):', 'prompt', '', (newName) => { if (newName) { cai.teams.push({ id: generateUniqueId(), name: newName.trim(), members: [] }); commitAndRender(); } }); } }
        function deleteCaiTeam(caiId, teamId) { updatePersonnelDataFromDOM(); showModal('Eliminar Equipo', '¿Seguro que quieres eliminar este equipo?', 'confirm', '', (confirmed) => { if (confirmed) { const cai = appData.caiSections.find(c => c.id === caiId); if (cai) { cai.teams = cai.teams.filter(t => t.id !== teamId); commitAndRender(); } } }); }
        function updateCaiTeamMember(caiId, teamId, memberIndex, personId) { updatePersonnelDataFromDOM(); const team = appData.caiSections.find(c => c.id === caiId)?.teams.find(t => t.id === teamId); if (team) { if (personId && team.members.includes(personId) && team.members[1 - memberIndex] === personId) { commitAndRender(); return; } team.members[memberIndex] = personId; commitAndRender(); } }
        function updateOtherGroupName(groupId, newName) { updatePersonnelDataFromDOM(); const group = appData.otherGroups.find(g => g.id === groupId); if (group) { group.name = newName.trim(); commitAndRender(); } }
        function addOtherGroup() { updatePersonnelDataFromDOM(); const input = document.getElementById('newGroupName'); const newName = input.value.trim(); if (newName) { appData.otherGroups.push({ id: generateUniqueId(), name: newName, members: [] }); input.value = ''; commitAndRender(); } }
        function deleteOtherGroup(groupId) { updatePersonnelDataFromDOM(); showModal('Eliminar Grupo', '¿Seguro que quieres eliminar este grupo?', 'confirm', '', (confirmed) => { if (confirmed) { appData.otherGroups = appData.otherGroups.filter(g => g.id !== groupId); commitAndRender(); } }); }
        
        function addMemberToOtherGroup(groupId) { 
            updatePersonnelDataFromDOM(); 
            const group = appData.otherGroups.find(g => g.id === groupId); 
            if (group) { 
                group.members.push(''); 
                commitAndRender(); 
            } 
        }
        
        function updateOtherGroupMember(groupId, memberIndex, personId) { 
            updatePersonnelDataFromDOM(); 
            const group = appData.otherGroups.find(g => g.id === groupId); 
            if (group) { 
                if(group.members.length <= memberIndex) {
                    group.members.push(personId);
                } else {
                    group.members[memberIndex] = personId;
                }
                commitAndRender(); 
            } 
        }

        function findAssignment(personId) {
            for (const cai of appData.caiSections) { for (const team of cai.teams) { if (team.members.includes(personId)) return `${cai.name} / ${team.name}`; } }
            for (const group of appData.otherGroups) { if (group.members.includes(personId)) return `Grupo: ${group.name}`; }
            return null;
        }

        function unassignPersonnel(personId) {
            updatePersonnelDataFromDOM();
            let wasUnassigned = false;
            appData.caiSections.forEach(cai => cai.teams.forEach(team => { 
                for(let i=0; i < team.members.length; i++){
                    if(team.members[i] === personId){
                        team.members[i] = '';
                        wasUnassigned = true;
                    }
                }
            }));
            appData.otherGroups.forEach(group => { 
                const initialLength = group.members.length;
                group.members = group.members.filter(id => id !== personId && id !== null);
                if(group.members.length < initialLength) wasUnassigned = true;
            });
            if (wasUnassigned) {
                commitAndRender();
                renderPersonnelSearch();
            }
        }

        // --- Lógica de Visibilidad y Estado de UI ---
        function toggleCaiSection(caiId) {
            const content = document.getElementById(`caiContent-${caiId}`);
            const icon = document.getElementById(`caiToggleIcon-${caiId}`);
            if (!content || !icon) return;
            const isCollapsed = content.classList.toggle('hidden');
            appData.uiState.collapsedCaiSections[caiId] = isCollapsed;
            saveDataToLocalStorage();
            icon.classList.toggle('fa-chevron-up', !isCollapsed);
            icon.classList.toggle('fa-chevron-down', isCollapsed);
        }

        function applyCaiSectionState(caiId) {
            const content = document.getElementById(`caiContent-${caiId}`);
            const icon = document.getElementById(`caiToggleIcon-${caiId}`);
            if (!content || !icon) return;
            const isCollapsed = appData.uiState.collapsedCaiSections[caiId] === true;
            content.classList.toggle('hidden', isCollapsed);
            icon.classList.toggle('fa-chevron-up', !isCollapsed);
            icon.classList.toggle('fa-chevron-down', isCollapsed);
        }

        function synchronize(master, target) {
            // Sync CAI Sections
            target.caiSections = master.caiSections.map(masterCai => {
                const targetCai = target.caiSections.find(c => c.id === masterCai.id);
                const newCai = JSON.parse(JSON.stringify(masterCai)); // Deep copy master structure
                
                newCai.teams.forEach(team => team.members = []);

                if (targetCai) {
                    newCai.teams.forEach(newTeam => {
                        const targetTeam = targetCai.teams.find(t => t.id === newTeam.id);
                        if (targetTeam) {
                            newTeam.members = targetTeam.members; 
                        }
                    });
                }
                return newCai;
            });

            // Sync Other Groups
            target.otherGroups = master.otherGroups.map(masterGroup => {
                const targetGroup = target.otherGroups.find(g => g.id === masterGroup.id);
                const newGroup = JSON.parse(JSON.stringify(masterGroup)); 
                newGroup.members = []; 

                if (targetGroup) {
                    newGroup.members = targetGroup.members; 
                }
                return newGroup;
            });
            
            target.uiState = JSON.parse(JSON.stringify(master.uiState));
        }


        function switchPersonnelList(listId) {
            saveData(); 

            const masterConfig = fullState.configurations['list1'];
            const targetConfig = fullState.configurations[listId];

            if (listId !== 'list1') {
                synchronize(masterConfig, targetConfig);
            }
            
            fullState.currentListId = listId;
            appData = fullState.configurations[listId];

            saveDataToLocalStorage();
            renderUI();
        }
        
        // --- Renderizado Principal y Generación de Informe ---
        function renderUI() {
            updatePersonnelAssignedStatus();
            document.getElementById('commanderRank').value = appData.commanderRank;
            document.getElementById('commanderName').value = appData.commanderName;
            document.getElementById('importantServices').value = appData.importantServices.join('\n');
            document.getElementById('personnelTextarea').value = fullState.allPersonnelLists[fullState.currentListId].map(p => `${p.grade} ${p.name}`).join('\n');
            document.querySelector(`input[name="personnelListSelector"][value="${fullState.currentListId}"]`).checked = true;
            renderCaiSections();
            renderOtherGroups();
        }

        function generateReport() {
            const greeting = getGreeting();
            const { commanderRank, commanderName, importantServices } = appData;
            const turno = getTurno();
            const currentPersonnelList = fullState.allPersonnelLists[fullState.currentListId];
            
            let oficialesTotalCount = 0;
            let suboficialesTotalCount = 0;
            let patrullerosTotalCount = 0;

            const assignedPersonnelIds = new Set();

            appData.caiSections.forEach(cai => {
                cai.teams.forEach(team => team.members.forEach(id => {
                    if (id) assignedPersonnelIds.add(id);
                }));
            });

            appData.otherGroups.forEach(group => {
                const isCountableGroup = group.name === "Jefe de Vigilancia" || 
                                         group.name === "Jefe de información E-12 y Centinelas" || 
                                         group.name === "Zona T" || 
                                         group.name.includes("(Información)");
                if (isCountableGroup) {
                    group.members.forEach(id => {
                        if (id) assignedPersonnelIds.add(id);
                    });
                }
            });

            assignedPersonnelIds.forEach(id => {
                const person = currentPersonnelList.find(p => p.id === id);
                if (person) {
                    if (person.category === "Oficiales") oficialesTotalCount++;
                    else if (person.category === "Suboficiales") suboficialesTotalCount++;
                    else if (person.category === "Patrulleros") patrullerosTotalCount++;
                }
            });

            let report = `Dios y Patria mi Mayor ${greeting}, respetuosamente me permito reportar el personal para el ${turno}, así:\n\n`;
            
            report += `*Parte =(${oficialesTotalCount}-${suboficialesTotalCount}-${patrullerosTotalCount})*\n\n`;

            let totalZones = 0;
            appData.caiSections.forEach(cai => cai.teams.forEach(team => { 
                const member1 = currentPersonnelList.find(p => p.id === team.members[0]);
                const member2 = currentPersonnelList.find(p => p.id === team.members[1]);
                if (member1 && member2) totalZones++; 
            }));
            report += `Total: *(${totalZones})* Zonas de Atención asignados al Nuevo Modelo de Servicio de Policía en la Estación Barrios Unidos, así:\n\n`;

            appData.caiSections.forEach(cai => {
                report += `*${toTitleCaseSmart(cai.name)}*\n`;
                cai.teams.forEach(team => {
                    const members = team.members.map(id => {
                        const p = currentPersonnelList.find(p => p.id === id);
                        return p ? `${p.grade.toUpperCase()} ${toTitleCaseSmart(p.name)}` : 'Personal no asignado';
                    }).join(' / ');
                    report += `🚔 ${team.name} ${members}\n`;
                });
                report += '\n';
            });
            
            const processGroup = (groupName, title) => {
                const group = appData.otherGroups.find(g => g.name === groupName);
                let text = '';
                if (group && group.members.length > 0) {
                    const validMembers = group.members.filter(id => id);
                    if (validMembers.length > 0) {
                        text += `*${toTitleCaseSmart(title)}*\n`;
                        validMembers.forEach(id => {
                            const p = currentPersonnelList.find(p => p.id === id);
                            if (p) text += `${p.grade.toUpperCase()} ${toTitleCaseSmart(p.name)}\n`;
                        });
                        text += '\n';
                    }
                }
                return text;
            };

            report += processGroup("Zona T", "Zona T");
            report += processGroup("Jefe de Vigilancia", "Jefe de Vigilancia");

            if (importantServices.length > 0) {
                report += `*Servicios de Importancia*\n\n`;
                importantServices.forEach(service => { report += `📍${toTitleCaseSmart(service)}\n`; });
                report += '\n';
            }

            report += processGroup("Jefe de información E-12 y Centinelas", "Jefe de información E-12 y Centinelas");

            const custodiosGroup = appData.otherGroups.find(g => g.name === "Custodios E-12");
            if (custodiosGroup && custodiosGroup.members.length > 0) {
                const uniqueMemberIds = [...new Set(custodiosGroup.members.filter(id => id))];
                if (uniqueMemberIds.length > 0) {
                    let custodioCounts = { Oficiales: 0, Suboficiales: 0, Patrulleros: 0 };
                    report += `*Custodios E-12*\n\n`;
                    uniqueMemberIds.forEach(id => {
                        const p = currentPersonnelList.find(p => p.id === id);
                        if (p) {
                             if (p.category === "Oficiales") custodioCounts.Oficiales++;
                             else if (p.category === "Suboficiales") custodioCounts.Suboficiales++;
                             else if (p.category === "Patrulleros") custodioCounts.Patrulleros++;
                        }
                    });
                    report += `Parte: (${custodioCounts.Oficiales}-${custodioCounts.Suboficiales}-${custodioCounts.Patrulleros})\n\n`;
                    uniqueMemberIds.forEach(id => {
                        const p = currentPersonnelList.find(p => p.id === id);
                        if (p) report += `${p.grade.toUpperCase()}. ${toTitleCaseSmart(p.name)}\n`;
                    });
                    report += '\n';
                }
            }

            const caiInfoGroups = appData.otherGroups.filter(g => g.name.includes("(Información)"));
            if (caiInfoGroups.some(g => g.members.length > 0 && g.members.some(id => id))) {
                report += `*Información de CAI*\n\n`;
                caiInfoGroups.forEach(group => {
                     const validMembers = group.members.filter(id => id);
                    if (validMembers.length > 0) {
                        validMembers.forEach(id => {
                            const p = currentPersonnelList.find(p => p.id === id);
                            if (p) report += `*${toTitleCaseSmart(group.name.replace(' (Información)', ''))}*\n👮🏻‍♂️ ${p.grade.toUpperCase()}. ${toTitleCaseSmart(p.name)}\n\n`;
                        });
                    }
                });
            }

            const defaultNovedadNames = ["Excusado", "Calamidad", "Vacaciones"];
            const allNovedadesGroups = appData.otherGroups.filter(g => (g.defaultName && defaultNovedadNames.includes(g.defaultName)) || (!g.defaultName && !g.name.includes("(Información)")));
            
            if (allNovedadesGroups.some(g => g.members.length > 0 && g.members.some(id => id))) {
                report += `*📌NOVEDADES*\n\n`;

                const customNovedades = allNovedadesGroups.filter(g => !g.defaultName);
                const defaultNovedadesInOrder = defaultNovedadNames.map(name => allNovedadesGroups.find(g => g.defaultName === name)).filter(Boolean);
                
                const orderedNovedades = [...customNovedades, ...defaultNovedadesInOrder];

                orderedNovedades.forEach(group => {
                    const validMembers = group.members.filter(id => id);
                    if (validMembers.length > 0) {
                        report += `*${toTitleCaseSmart(group.name)}*\n\n`;
                        validMembers.forEach(id => {
                            const p = currentPersonnelList.find(p => p.id === id);
                            if (p) report += `${p.grade.toUpperCase()} ${toTitleCaseSmart(p.name)}\n`;
                        });
                        report += '\n';
                    }
                });
            }

            report += `${toTitleCaseSmart(commanderRank)} ${toTitleCaseSmart(commanderName)}\n*Comandante Estación de Policía Barrios Unidos*\n`;
            document.getElementById('reportOutput').textContent = report;
        }
        
        function getTurno() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour <= 7) return "segundo turno";
            if (hour >= 20 && hour <= 22) return "primer turno";
            if (hour >= 12 && hour <= 14) return "tercer turno";
            return "segundo turno";
        }

        function copyReport() {
            const reportText = document.getElementById('reportOutput').textContent;
            const textarea = document.createElement('textarea');
            textarea.value = reportText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => { feedback.classList.remove('show'); }, 2000);
        }

        // --- Funciones de Importar/Exportar ---
        function downloadData() {
            saveDataToLocalStorage();
            const dataStr = JSON.stringify(fullState, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const date = new Date().toISOString().slice(0, 10);
            link.download = `datos-informe-completos-${date}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            showModal('Confirmar Carga', '¿Seguro que quieres cargar este archivo? Se sobrescribirán todos los datos y configuraciones actuales.', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const loadedData = JSON.parse(e.target.result);
                            if (loadedData && loadedData.configurations && loadedData.allPersonnelLists && loadedData.currentListId) {
                                fullState = loadedData;
                                const masterConfig = fullState.configurations['list1'];
                                if(masterConfig){
                                    synchronize(masterConfig, fullState.configurations['list2']);
                                    synchronize(masterConfig, fullState.configurations['list3']);
                                }
                                appData = fullState.configurations[fullState.currentListId];
                                commitAndRender();
                            } else {
                                showModal('Error', 'El archivo no parece ser un archivo de datos válido para la nueva estructura.', 'alert');
                            }
                        } catch (error) {
                            showModal('Error', 'No se pudo leer el archivo. Asegúrate de que es un archivo .json válido.', 'alert');
                            console.error("Error al parsear el archivo JSON:", error);
                        }
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            });
        }

        // --- Event Listener para cerrar dropdowns ---
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-select-container')) {
                document.querySelectorAll('.search-select-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // Inicializar la aplicación
        window.onload = loadData;
    </script>
</body>
</html>

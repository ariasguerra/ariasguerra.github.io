<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informe Policial</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- SheetJS (xlsx) CDN para leer archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos base para el cuerpo y contenedor principal */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 1rem; /* Padding general para el cuerpo en móviles */
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* Títulos de sección y subsección */
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .subsection-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #374151;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
        }
        /* Campos de entrada y áreas de texto */
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        /* Estilos para botones con íconos */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 44px; /* Asegura un buen tamaño de toque para móviles */
            min-height: 44px; /* Asegura un buen tamaño de toque para móviles */
        }
        /* Variantes de color para botones */
        .btn-primary {
            background-color: #2563eb;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #22c55e;
            color: #ffffff;
        }
        .btn-success:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
        }
        /* Estilos para tarjetas de contenido */
        .card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        /* Estilos para la salida del informe */
        .report-output {
            white-space: pre-wrap; /* Preserva espacios en blanco y saltos de línea */
            word-wrap: break-word; /* Rompe palabras largas */
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 200px;
            font-family: monospace;
            line-height: 1.5;
            color: #374151;
        }
        /* Estilos para elementos de lista de personal */
        .personnel-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .personnel-list-item:last-child {
            border-bottom: none;
        }

        /* --- Estilos para el Modal Personalizado --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%; /* Ancho responsivo para móviles */
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.75rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .modal-message {
            font-size: 1rem;
            color: #4b5563;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        /* Estilos para el mensaje de copiado */
        .copy-feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1001;
        }
        .copy-feedback.show {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            body {
                padding: 2rem;
            }
            .btn {
                padding: 0.75rem 1.25rem; /* Restore larger padding for desktop */
            }
            .flex-col-sm-row {
                flex-direction: row;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">Generador de Informe Policial</h1>

        <!-- Sección de Configuración -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
            <h2 class="section-title text-blue-800">Configuración del Informe</h2>

            <!-- Comandante -->
            <div class="mb-4">
                <label for="commanderRank" class="block text-gray-700 font-medium mb-2">Grado del Comandante:</label>
                <input type="text" id="commanderRank" class="input-field" value="MY." onchange="saveData()">
            </div>
            <div class="mb-4">
                <label for="commanderName" class="block text-gray-700 font-medium mb-2">Nombre del Comandante:</label>
                <input type="text" id="commanderName" class="input-field" value="Buitrago Valderrama Diego Alejandro" onchange="saveData()">
            </div>

            <!-- Servicios de Importancia -->
            <div class="mb-6">
                <h3 class="subsection-title">Servicios de Importancia <span class="text-sm text-gray-500">(uno por línea)</span></h3>
                <textarea id="importantServices" class="input-field min-h-[150px]" onchange="saveData()"></textarea>
            </div>

            <!-- Gestión de Personal -->
            <div class="mb-6">
                <h3 class="subsection-title">Gestión de Personal</h3>
                <!-- Nueva sección para cargar desde Excel -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <label for="excelFileInput" class="block text-gray-700 font-medium mb-2">Cargar Personal desde Excel (.xlsx/.xls):</label>
                    <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="input-field mb-2">
                    <button onclick="handleFileUpload()" class="btn btn-primary w-full"><i class="fas fa-file-excel"></i> Cargar Excel</button>
                </div>
                <div id="personnelListContainer" class="bg-white p-4 rounded-lg border border-gray-200 mb-4 max-h-60 overflow-y-auto">
                    <!-- Los elementos del personal se renderizarán aquí -->
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="newPersonnelGrade" class="input-field flex-grow" placeholder="Grado (ej. PT, SI)" aria-label="Nuevo Grado de Personal">
                    <input type="text" id="newPersonnelName" class="input-field flex-grow" placeholder="Nombre (ej. Martin, Daniela)" aria-label="Nuevo Nombre de Personal">
                    <button onclick="addPersonnel()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>

        <!-- Sección de Equipos y Grupos -->
        <div class="mb-8 p-6 bg-green-50 rounded-lg shadow-inner">
            <h2 class="section-title text-green-800">Asignación de Equipos y Grupos</h2>

            <!-- Secciones CAI -->
            <div id="caiSectionsContainer">
                <!-- Las secciones CAI se renderizarán aquí -->
            </div>
            <button onclick="addCaiSection()" class="btn btn-primary mt-4"><i class="fas fa-plus"></i></button>

            <!-- Otros Grupos -->
            <div class="mt-8">
                <h3 class="subsection-title">Otros Grupos</h3>
                <div id="otherGroupsContainer">
                    <!-- Otros grupos se renderizarán aquí -->
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <input type="text" id="newGroupName" class="input-field flex-grow" placeholder="Nombre del nuevo grupo" aria-label="Nombre del nuevo grupo">
                    <button onclick="addOtherGroup()" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>

        <!-- Botón de Generar Informe -->
        <div class="text-center mb-8">
            <button onclick="generateReport()" class="btn btn-primary text-xl px-8 py-4">Generar Informe</button>
        </div>

        <!-- Área de Salida del Informe -->
        <div class="p-6 bg-gray-100 rounded-lg shadow-inner relative">
            <h2 class="section-title text-gray-800">Informe Generado</h2>
            <button onclick="copyReport()" class="absolute top-4 right-4 btn btn-secondary p-2 text-lg" title="Copiar informe">
                <i class="fas fa-copy"></i>
            </button>
            <pre id="reportOutput" class="report-output"></pre>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="customModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalMessage" class="modal-message"></p>
            <input type="text" id="modalInput" class="modal-input hidden">
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn btn-primary hidden">Aceptar</button>
                <button id="modalCancelBtn" class="btn btn-secondary hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Feedback de copiado -->
    <div id="copyFeedback" class="copy-feedback">
        ¡Copiado!
    </div>

    <script>
        let scrollPosition = 0; // Variable para almacenar la posición de desplazamiento

        // Función para generar un ID único
        function generateUniqueId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Datos iniciales por defecto (usados para valores por defecto si no hay datos guardados)
        const defaultData = {
            commanderName: "Buitrago Valderrama Diego Alejandro",
            commanderRank: "MY.",
            importantServices: [
                "Puntos criticos",
                "Sector comercio",
                "Sector bancario",
                "Sector residencial",
                "Carrilera",
                "Zona Tolerancia",
                "Universidades",
                "Talleres 7 Agosto",
                "Puentes de la 92",
                "Av. Caracas",
                "Calle 63",
                "Carrera 30",
                "Calle 80"
            ],
            personnel: [], // Este sí debe iniciar vacío por defecto
            caiSections: [
                {
                    id: generateUniqueId(), name: "CAI - MODELO",
                    teams: [
                        { id: generateUniqueId(), name: "11-13", members: [] },
                        { id: generateUniqueId(), name: "12-14", members: [] },
                        { id: generateUniqueId(), name: "15-16", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - ALCAZARES",
                    teams: [
                        { id: generateUniqueId(), name: "1", members: [] },
                        { id: generateUniqueId(), name: "2", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - POLO CLUB",
                    teams: [
                        { id: generateUniqueId(), name: "6-7", members: [] },
                        { id: generateUniqueId(), name: "8", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - RIONEGRO",
                    teams: [
                        { id: generateUniqueId(), name: "9", members: [] },
                        { id: generateUniqueId(), name: "10", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - 7 DE AGOSTO",
                    teams: [
                        { id: generateUniqueId(), name: "3", members: [] },
                        { id: generateUniqueId(), name: "4-5", members: [] }
                    ]
                }
            ],
            otherGroups: [
                { id: generateUniqueId(), name: "Zona T", members: ["", ""] }, // Nuevo grupo "Zona T" con dos espacios
                { id: generateUniqueId(), name: "Jefe de Vigilancia", members: [""] }, // Un espacio por defecto
                { id: generateUniqueId(), name: "Jefe de información E-12 y Centinelas", members: [""] }, // Un espacio por defecto
                { id: generateUniqueId(), name: "Custodio E-12", members: [""] }, // Un espacio por defecto
                { id: generateUniqueId(), name: "CAI - ALCÁZARES (Información)", members: [""] }, // Added back
                { id: generateUniqueId(), name: "CAI - MODELO (Información)", members: [""] }, // Added back
                { id: generateUniqueId(), name: "CAI - POLO CLUB (Información)", members: [""] }, // Added back
                { id: generateUniqueId(), name: "CAI - RIONEGRO (Información)", members: [""] }, // Added back
                { id: generateUniqueId(), name: "CAI 7 DE AGOSTO (Información)", members: [""] }, // Added back
                { id: generateUniqueId(), name: "Vacaciones", members: [] },
                { id: generateUniqueId(), name: "Excusado", members: [] },
                { id: generateUniqueId(), name: "Calamidad", members: [] }
            ]
        };

        let appData = {};

        // --- Funciones para el Modal Personalizado ---
        const modalOverlay = document.getElementById('customModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        let modalCallback = null;

        /**
         * Muestra un modal personalizado para confirmación, prompt o alerta.
         * @param {string} title - Título del modal.
         * @param {string} message - Mensaje del modal.
         * @param {'prompt'|'confirm'|'alert'} type - Tipo de modal (prompt, confirm, alert).
         * @param {string} [defaultValue=''] - Valor por defecto para el input en tipo 'prompt'.
         * @param {function} [callback] - Función a ejecutar al confirmar (para 'prompt' y 'confirm').
         */
        function showModal(title, message, type, defaultValue = '', callback) {
            scrollPosition = window.scrollY; // Guarda la posición de desplazamiento actual
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCallback = callback;

            modalInput.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            if (type === 'prompt') {
                modalInput.value = defaultValue;
                modalInput.classList.remove('hidden');
                modalConfirmBtn.textContent = 'Aceptar';
                modalConfirmBtn.classList.remove('hidden');
            } else if (type === 'confirm') {
                modalConfirmBtn.textContent = 'Sí';
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.textContent = 'No';
                modalCancelBtn.classList.remove('hidden');
            } else if (type === 'alert') { // Nuevo tipo 'alert'
                modalConfirmBtn.textContent = 'Entendido';
                modalConfirmBtn.classList.remove('hidden');
                modalCallback = () => {}; // Para alertas, el callback no necesita hacer nada específico
            }

            modalOverlay.classList.add('active');
            // Deshabilita el desplazamiento del cuerpo mientras el modal está activo
            document.body.style.overflow = 'hidden';
            if (type === 'prompt') {
                modalInput.focus();
            }
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restaura el desplazamiento del cuerpo
            window.scrollTo(0, scrollPosition); // Vuelve a la posición de desplazamiento guardada
        }

        modalConfirmBtn.onclick = () => {
            closeModal();
            if (modalCallback) {
                if (!modalInput.classList.contains('hidden')) {
                    modalCallback(modalInput.value);
                } else {
                    modalCallback(true);
                }
            }
        };

        modalCancelBtn.onclick = () => {
            closeModal();
            if (modalCallback) {
                modalCallback(false);
            }
        };

        // --- Fin de funciones del Modal Personalizado ---

        // Función para cargar datos desde localStorage
        function loadData() {
            console.log('loadData: Intentando cargar datos de localStorage...');
            const storedData = localStorage.getItem('policeReportData');
            if (storedData) {
                appData = JSON.parse(storedData);
                console.log('loadData: Datos cargados de localStorage (raw):', JSON.parse(JSON.stringify(appData))); // Deep copy for logging

                // Ensure all top-level properties are present, using defaultData as fallback
                appData.commanderName = appData.commanderName !== undefined ? appData.commanderName : defaultData.commanderName;
                appData.commanderRank = appData.commanderRank !== undefined ? appData.commanderRank : defaultData.commanderRank;
                appData.importantServices = appData.importantServices !== undefined ? appData.importantServices : defaultData.importantServices;
                
                // Personnel: always load from localStorage or initialize empty
                appData.personnel = appData.personnel || []; 

                // CAI Sections: load from localStorage and merge with default values
                const mergedCaiSections = JSON.parse(JSON.stringify(defaultData.caiSections)); // Start with default structure
                if (appData.caiSections) {
                    appData.caiSections.forEach(savedCai => {
                        const existingCaiIndex = mergedCaiSections.findIndex(c => c.name === savedCai.name);
                        if (existingCaiIndex !== -1) {
                            // If CAI exists in defaults, update its teams with saved ones
                            savedCai.teams.forEach(savedTeam => {
                                const existingTeamIndex = mergedCaiSections[existingCaiIndex].teams.findIndex(t => t.name === savedTeam.name);
                                if (existingTeamIndex !== -1) {
                                    mergedCaiSections[existingCaiIndex].teams[existingTeamIndex].members = savedTeam.members;
                                } else {
                                    mergedCgedCaiSections[existingCaiIndex].teams.push(savedTeam); // Add new teams
                                }
                            });
                        } else {
                            mergedCaiSections.push(savedCai); // Add new CAI sections
                        }
                    });
                }
                appData.caiSections = mergedCaiSections;
                
                // Other Groups: load from localStorage and merge with default values
                const mergedOtherGroups = JSON.parse(JSON.stringify(defaultData.otherGroups)); // Start with default structure
                if (appData.otherGroups) {
                    appData.otherGroups.forEach(savedGroup => {
                        const existingGroupIndex = mergedOtherGroups.findIndex(g => g.name === savedGroup.name);
                        if (existingGroupIndex !== -1) {
                            // If group exists in defaults, update its members with saved ones
                            mergedOtherGroups[existingGroupIndex].members = savedGroup.members;
                        } else {
                            mergedOtherGroups.push(savedGroup); // Add new groups
                        }
                    });
                }
                appData.otherGroups = mergedOtherGroups;

                console.log('loadData: appData después de la fusión con defaults:', JSON.parse(JSON.stringify(appData))); // Deep copy for logging

                // After loading, update assigned status based on current assignments
                updatePersonnelAssignedStatus();

            } else {
                console.log('loadData: No se encontraron datos en localStorage. Inicializando con valores por defecto.');
                // If no saved data, initialize with deep copy of default values
                appData = {
                    commanderName: defaultData.commanderName,
                    commanderRank: defaultData.commanderRank,
                    importantServices: defaultData.importantServices,
                    personnel: JSON.parse(JSON.stringify(defaultData.personnel)), // Deep copy empty array
                    caiSections: JSON.parse(JSON.stringify(defaultData.caiSections)), // Deep copy default CAI structure
                    otherGroups: JSON.parse(JSON.stringify(defaultData.otherGroups))  // Deep copy default otherGroups structure
                };
            }
            renderUI();
        }

        // Función para asignar el personal por defecto a sus lugares iniciales
        // Esta función ya no se llama automáticamente al cargar, solo si se desea implementarla manualmente.
        function assignDefaultPersonnel() {
            // This function is kept for reference but is not called on load anymore.
            // It would manually assign personnel if needed.
            console.warn('assignDefaultPersonnel: Esta función no se llama automáticamente al cargar. Se usa para asignaciones manuales por defecto si fuera necesario.');
            
            // Reinicia todo el personal a no asignado primero
            appData.personnel.forEach(p => p.assigned = false);

            // Example default assignments (these would need to be based on actual personnel IDs)
            // For now, this function is mostly illustrative as Excel import handles initial assignment.
            
            updatePersonnelAssignedStatus(); 
        }

        // Función para guardar datos en localStorage
        function saveData() {
            try {
                localStorage.setItem('policeReportData', JSON.stringify(appData));
                console.log('saveData: Datos guardados exitosamente en localStorage.');
            } catch (e) {
                console.error('saveData: Error al guardar en localStorage:', e);
                showModal('Error de Guardado', 'No se pudieron guardar los datos en su navegador. El almacenamiento local podría estar lleno o deshabilitado.', 'alert');
            }
            renderUI(); // Re-renderiza la UI después de guardar para actualizar el personal disponible
        }

        // Función para obtener el saludo según la hora
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) {
                return "buenos días";
            } else if (hour >= 12 && hour < 19) {
                return "buenas tardes";
            } else {
                return "buenas noches";
            }
        }

        // --- Gestión de Personal ---

        /**
         * Maneja la carga de un archivo Excel para actualizar la lista de personal.
         * El archivo debe tener columnas llamadas "GR" y "APELLIDOS".
         */
        function handleFileUpload() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showModal('Error', 'Por favor, selecciona un archivo Excel.', 'alert');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Asume que los datos están en la primera hoja
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convertir la hoja a JSON
                    // header: 1 para obtener la primera fila como encabezados
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    console.log('handleFileUpload: JSON de Excel crudo:', json);

                    if (json.length < 2) { // Necesita al menos una fila de encabezado y una de datos
                        showModal('Error', 'El archivo Excel está vacío o no tiene el formato esperado (se espera al menos una fila de encabezado y una de datos).', 'alert');
                        return;
                    }

                    const headers = json[0]; // La primera fila son los encabezados
                    const gradeColIndex = headers.findIndex(h => h && h.toUpperCase() === 'GR');
                    const nameColIndex = headers.findIndex(h => h && h.toUpperCase() === 'APELLIDOS');
                    const novedadesColIndex = headers.findIndex(h => h && h.toUpperCase() === 'NOVEDADES'); // Nuevo índice para Novedades

                    if (gradeColIndex === -1 || nameColIndex === -1) {
                        showModal('Error', 'Las columnas "GR" y "APELLIDOS" no se encontraron en el archivo Excel. Asegúrate de que los encabezados coincidan exactamente.', 'alert');
                        return;
                    }

                    const newPersonnel = [];
                    // Usamos un mapa para almacenar las asignaciones de novedades temporales: { "NombreGrupo": [idPersona1, idPersona2] }
                    const novedadesAssignmentsTemp = {}; 
                    let ignoredRowsCount = 0;

                    // Itera desde la segunda fila (índice 1) para los datos
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        const grade = row[gradeColIndex];
                        const name = row[nameColIndex];
                        const novedad = novedadesColIndex !== -1 ? row[novedadesColIndex] : null;

                        if (grade && name) {
                            const personId = generateUniqueId();
                            newPersonnel.push({
                                id: personId,
                                grade: String(grade).trim(),
                                name: String(name).trim(),
                                assigned: false
                            });

                            // Procesar la columna de Novedades para asignar personal a grupos dinámicamente
                            if (novedad && String(novedad).trim() !== '') {
                                const novedadGroupName = String(novedad).trim();
                                if (!novedadesAssignmentsTemp[novedadGroupName]) {
                                    novedadesAssignmentsTemp[novedadGroupName] = [];
                                }
                                novedadesAssignmentsTemp[novedadGroupName].push(personId);
                            }
                        } else {
                            console.warn('handleFileUpload: Fila ignorada debido a datos faltantes (GR o APELLIDOS):', row);
                            ignoredRowsCount++;
                        }
                    }

                    // --- Limpiar todas las asignaciones existentes antes de aplicar las nuevas del Excel ---
                    console.log('handleFileUpload: Limpiando asignaciones existentes antes de la nueva carga...');
                    appData.personnel.forEach(p => p.assigned = false);
                    appData.caiSections.forEach(cai => cai.teams.forEach(team => team.members = []));
                    // Para otros grupos, solo limpiamos los miembros, no eliminamos los grupos en sí
                    appData.otherGroups.forEach(group => group.members = []); 

                    // Actualizar el personal principal
                    appData.personnel = newPersonnel;
                    console.log('handleFileUpload: Nuevo personal cargado:', JSON.parse(JSON.stringify(appData.personnel)));

                    // Añadir o actualizar los grupos de Novedades y asignar personal
                    for (const groupName in novedadesAssignmentsTemp) {
                        if (novedadesAssignmentsTemp.hasOwnProperty(groupName)) {
                            let group = appData.otherGroups.find(g => g.name === groupName);
                            if (!group) {
                                // Si el grupo no existe, créalo
                                group = {
                                    id: generateUniqueId(),
                                    name: groupName,
                                    members: []
                                };
                                appData.otherGroups.push(group);
                                console.log(`handleFileUpload: Creado nuevo grupo de Novedades: ${groupName}`);
                            }
                            // Asigna los miembros a este grupo
                            group.members = novedadesAssignmentsTemp[groupName];
                            console.log(`handleFileUpload: Asignado personal a grupo "${groupName}":`, group.members.length, 'miembros.');
                        }
                    }

                    saveData(); // Esto también re-renderiza la UI y guarda en localStorage
                    console.log('handleFileUpload: appData después de la carga y asignación de novedades:', JSON.parse(JSON.stringify(appData)));

                    let successMessage = `Se cargaron ${newPersonnel.length} miembros del personal desde el Excel.`;
                    if (Object.keys(novedadesAssignmentsTemp).length > 0) {
                        successMessage += ` Se asignaron personal a ${Object.keys(novedadesAssignmentsTemp).length} grupos de Novedades.`;
                    }
                    if (ignoredRowsCount > 0) {
                        successMessage += ` Se ignoraron ${ignoredRowsCount} filas debido a datos faltantes.`;
                        showModal('Advertencia', successMessage, 'alert');
                    } else {
                        showModal('Éxito', successMessage, 'alert');
                    }

                } catch (error) {
                    console.error('handleFileUpload: Error al procesar el archivo Excel:', error);
                    showModal('Error', 'Hubo un error al procesar el archivo Excel. Asegúrate de que sea un archivo .xlsx o .xls válido y que las columnas "GR" y "APELLIDOS" existan.', 'alert');
                } finally {
                    fileInput.value = ''; // Limpia el input de archivo para la próxima carga
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderPersonnelList() {
            const container = document.getElementById('personnelListContainer');
            container.innerHTML = '';
            appData.personnel.forEach(person => {
                const div = document.createElement('div');
                div.className = 'personnel-list-item';
                div.innerHTML = `
                    <span class="text-gray-800">${person.grade} ${person.name}</span>
                    <div class="flex gap-2">
                        <button onclick="editPersonnel('${person.id}')" class="text-blue-600 hover:text-blue-800 text-sm p-1 rounded-full"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePersonnel('${person.id}')" class="text-red-600 hover:text-red-800 text-sm p-1 rounded-full"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPersonnel() {
            const gradeInput = document.getElementById('newPersonnelGrade');
            const nameInput = document.getElementById('newPersonnelName');
            const grade = gradeInput.value.trim();
            const name = nameInput.value.trim();

            if (grade && name) {
                appData.personnel.push({ id: generateUniqueId(), grade: grade, name: name, assigned: false });
                gradeInput.value = '';
                nameInput.value = '';
                saveData();
            } else {
                showModal('Advertencia', 'Por favor, ingresa el grado y el nombre del personal.', 'alert');
            }
        }

        function editPersonnel(id) {
            const person = appData.personnel.find(p => p.id === id);
            if (person) {
                showModal('Editar Grado', `Editar grado para ${person.name}:`, 'prompt', person.grade, (newGrade) => {
                    if (newGrade !== null && newGrade.trim() !== '') {
                        showModal('Editar Nombre', `Editar nombre para ${person.grade} ${person.name}:`, 'prompt', person.name, (newName) => {
                            if (newName !== null && newName.trim() !== '') {
                                person.grade = newGrade.trim();
                                person.name = newName.trim();
                                saveData();
                            } else if (newName !== null) { // Si el usuario borró el nombre
                                showModal('Advertencia', 'El nombre no puede estar vacío.', 'alert');
                            }
                        });
                    } else if (newGrade !== null) { // Si el usuario borró el grado
                        showModal('Advertencia', 'El grado no puede estar vacío.', 'alert');
                    }
                });
            }
        }

        function deletePersonnel(id) {
            showModal('Eliminar Personal', '¿Estás seguro de que quieres eliminar a este miembro del personal? Esto lo desasignará de todos los equipos.', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    appData.personnel = appData.personnel.filter(p => p.id !== id);
                    // Eliminar de todas las asignaciones
                    appData.caiSections.forEach(cai => {
                        cai.teams.forEach(team => {
                            team.members = team.members.filter(memberId => memberId !== id);
                        });
                    });
                    appData.otherGroups.forEach(group => {
                        group.members = group.members.filter(memberId => memberId !== id);
                    });
                    saveData();
                }
            });
        }

        // --- Renderizado de Selectores de Personal ---
        function getAvailablePersonnel() {
            const available = appData.personnel.filter(p => !p.assigned);
            console.log('getAvailablePersonnel: Personal disponible (assigned: false):', available.map(p => p.name));
            return available;
        }

        function createPersonnelSelect(selectedPersonId = '', onChangeCallback) {
            const select = document.createElement('select');
            select.className = 'input-field w-full';
            select.innerHTML = '<option value="">-- Seleccionar Personal --</option>';

            const available = getAvailablePersonnel();
            const assignedPerson = selectedPersonId ? appData.personnel.find(p => p.id === selectedPersonId) : null;

            // Add the currently assigned person to the options, even if they are marked as assigned
            if (assignedPerson) {
                const option = document.createElement('option');
                option.value = assignedPerson.id;
                option.textContent = `${assignedPerson.grade} ${assignedPerson.name}`;
                option.selected = true;
                select.appendChild(option);
            }

            // Add the rest of the available personnel
            available.forEach(person => {
                if (person.id !== selectedPersonId) { // Avoid duplicating if already added as assigned
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = `${person.grade} ${person.name}`;
                    select.appendChild(option);
                }
            });
            console.log(`createPersonnelSelect: Generando selector para selectedPersonId: ${selectedPersonId}. Opciones disponibles:`, Array.from(select.options).map(opt => opt.textContent));

            select.onchange = onChangeCallback;
            return select;
        }

        // --- Actualizar estado de 'assigned' para el personal ---
        function updatePersonnelAssignedStatus() {
            console.log('updatePersonnelAssignedStatus: Reiniciando todos los estados de asignación a false.');
            appData.personnel.forEach(p => p.assigned = false); // Reset all to false

            // Mark assigned personnel in CAI teams
            appData.caiSections.forEach(cai => {
                cai.teams.forEach(team => {
                    team.members.forEach(memberId => {
                        const person = appData.personnel.find(p => p.id === memberId);
                        if (person) person.assigned = true;
                    });
                });
            });

            // Mark assigned personnel in other groups
            appData.otherGroups.forEach(group => {
                group.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) person.assigned = true;
                });
            });
            console.log('updatePersonnelAssignedStatus: Estado final del personal (assigned):', appData.personnel.map(p => ({ name: p.name, assigned: p.assigned })));
        }


        // --- Renderizado de Secciones CAI ---
        function renderCaiSections() {
            const container = document.getElementById('caiSectionsContainer');
            container.innerHTML = '';

            appData.caiSections.forEach(cai => {
                const caiDiv = document.createElement('div');
                caiDiv.id = `cai-${cai.id}`;
                caiDiv.className = 'card mb-6';

                // Header for the collapsible section
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between cursor-pointer py-2 px-4 bg-blue-100 rounded-t-lg';
                headerDiv.onclick = () => toggleCaiSection(cai.id);
                headerDiv.innerHTML = `
                    <input type="text" value="${cai.name}" class="font-semibold text-blue-800 bg-transparent border-none focus:outline-none flex-grow" onchange="updateCaiName('${cai.id}', this.value)">
                    <i id="icon-${cai.id}" class="fas fa-chevron-down text-blue-800 transition-transform duration-300"></i>
                `;
                caiDiv.appendChild(headerDiv);

                // Content area for teams
                const contentDiv = document.createElement('div');
                contentDiv.id = `cai-teams-content-${cai.id}`; // New ID for the collapsible content
                contentDiv.className = 'p-4 border border-t-0 border-gray-200 rounded-b-lg'; // Initially visible

                // Existing team rendering container
                const teamsContainer = document.createElement('div');
                teamsContainer.id = `cai-teams-${cai.id}`;
                contentDiv.appendChild(teamsContainer);

                // Add team button
                const addTeamButton = document.createElement('button');
                addTeamButton.onclick = () => addCaiTeam(cai.id);
                addTeamButton.className = 'btn btn-secondary mt-4';
                addTeamButton.innerHTML = '<i class="fas fa-plus"></i>';
                contentDiv.appendChild(addTeamButton);

                caiDiv.appendChild(contentDiv);
                container.appendChild(caiDiv);

                renderCaiTeams(cai.id); // Render teams inside the newly created teamsContainer
            });
        }

        /**
         * Toggles the visibility of a CAI section and rotates its icon.
         * @param {string} caiId - The ID of the CAI section to toggle.
         */
        function toggleCaiSection(caiId) {
            const content = document.getElementById(`cai-teams-content-${caiId}`);
            const icon = document.getElementById(`icon-${caiId}`);
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('rotate-180'); // Rotate icon back
            } else {
                content.style.display = 'none';
                icon.classList.add('rotate-180'); // Rotate icon
            }
        }

        function updateCaiName(caiId, newName) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                cai.name = newName.trim();
                saveData();
            }
        }

        function addCaiSection() {
            showModal('Añadir Sección CAI', 'Ingrese el nombre de la nueva sección CAI (ej. CAI - NUEVO):', 'prompt', '', (newCaiName) => {
                if (newCaiName && newCaiName.trim() !== '') {
                    appData.caiSections.push({
                        id: generateUniqueId(),
                        name: newCaiName.trim(),
                        teams: []
                    });
                    saveData();
                } else if (newCaiName !== null) {
                    showModal('Advertencia', 'El nombre de la sección CAI no puede estar vacío.', 'alert');
                }
            });
        }

        function deleteCaiSection(caiId) {
            showModal('Eliminar Sección CAI', '¿Estás seguro de que quieres eliminar esta sección CAI y todos sus equipos?', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const cai = appData.caiSections.find(c => c.id === caiId);
                    if (cai) {
                        // Desasigna a los miembros antes de eliminar la sección CAI
                        cai.teams.forEach(team => {
                            team.members.forEach(memberId => {
                                const person = appData.personnel.find(p => p.id === memberId);
                                if (person) person.assigned = false;
                            });
                        });
                    }
                    appData.caiSections = appData.caiSections.filter(c => c.id !== caiId);
                    saveData();
                }
            });
        }

        // --- Renderizado de Equipos de CAI ---
        function renderCaiTeams(caiId) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (!cai) return;

            const container = document.getElementById(`cai-teams-${cai.id}`);
            container.innerHTML = '';

            cai.teams.forEach((team, teamIndex) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'card bg-white p-4 mb-3';
                let teamMembersHtml = '';

                // Always show two member selectors for CAI teams
                teamMembersHtml = `
                    <div class="flex-1">
                        <label class="block text-gray-700 font-medium mb-1">Miembro 1:</label>
                        ${createPersonnelSelect(team.members[0], (event) => {
                            updateCaiTeamMember(cai.id, team.id, 0, event.target.value);
                        }).outerHTML}
                    </div>
                    <div class="flex-1">
                        <label class="block text-gray-700 font-medium mb-1">Miembro 2:</label>
                        ${createPersonnelSelect(team.members[1], (event) => {
                            updateCaiTeamMember(cai.id, team.id, 1, event.target.value);
                        }).outerHTML}
                    </div>
                `;
                

                teamDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-3">
                        <input type="text" value="${team.name}" class="font-semibold input-field flex-grow mr-2 mb-2 sm:mb-0" onchange="updateCaiTeamName('${cai.id}', '${team.id}', this.value)">
                        <button onclick="deleteCaiTeam('${cai.id}', '${team.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        ${teamMembersHtml}
                    </div>
                `;
                container.appendChild(teamDiv);
            });
        }

        function updateCaiTeamMember(caiId, teamId, memberIndex, personId) {
            console.log(`updateCaiTeamMember: CAI ID: ${caiId}, Team ID: ${teamId}, Member Index: ${memberIndex}, New Person ID: ${personId}`);
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                const team = cai.teams.find(t => t.id === teamId);
                if (team) {
                    // Check for duplicate assignment within the same team (only if it's not the same index)
                    if (personId && team.members.includes(personId) && team.members.indexOf(personId) !== memberIndex) {
                        showModal('Advertencia', 'Este personal ya está asignado a otra posición en este mismo equipo.', 'alert');
                        renderUI(); // Re-render to revert visual selection
                        return;
                    }

                    // Explicitly unassign the old member if they exist
                    const oldMemberId = team.members[memberIndex];
                    if (oldMemberId && oldMemberId !== '') { // Only unassign if there was a person assigned
                        const oldPerson = appData.personnel.find(p => p.id === oldMemberId);
                        if (oldPerson) {
                            oldPerson.assigned = false;
                            console.log(`updateCaiTeamMember: Desasignado personal: ${oldPerson.name} (ID: ${oldMemberId})`);
                        }
                    }

                    // Assign the new member
                    team.members[memberIndex] = personId;
                    if (personId && personId !== '') { // Only assign if a new person is selected
                        const newPerson = appData.personnel.find(p => p.id === personId);
                        if (newPerson) {
                            newPerson.assigned = true;
                            console.log(`updateCaiTeamMember: Asignado personal: ${newPerson.name} (ID: ${personId})`);
                        }
                    }
                    saveData();
                }
            }
        }


        function addCaiTeam(caiId) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                showModal('Añadir Equipo', 'Ingrese el nombre del nuevo equipo (ej. 17-18):', 'prompt', '', (newTeamName) => {
                    if (newTeamName && newTeamName.trim() !== '') {
                        cai.teams.push({ id: generateUniqueId(), name: newTeamName.trim(), members: ["", ""] }); // Default to two members
                        saveData();
                    } else if (newTeamName !== null) {
                        showModal('Advertencia', 'El nombre del equipo no puede estar vacío.', 'alert');
                    }
                });
            }
        }

        function deleteCaiTeam(caiId, teamId) {
            showModal('Eliminar Equipo', '¿Estás seguro de que quieres eliminar este equipo?', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const cai = appData.caiSections.find(c => c.id === caiId);
                    if (cai) {
                        const team = cai.teams.find(t => t.id === teamId);
                        if (team) {
                            // Desasigna a los miembros antes de eliminar el equipo
                            team.members.forEach(memberId => {
                                const person = appData.personnel.find(p => p.id === memberId);
                                if (person) person.assigned = false;
                            });
                        }
                        cai.teams = cai.teams.filter(t => t.id !== teamId);
                        saveData();
                    }
                }
            });
        }

        // --- Renderizado de Otros Grupos ---
        function renderOtherGroups() {
            const container = document.getElementById('otherGroupsContainer');
            container.innerHTML = '';

            appData.otherGroups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.id = `group-${group.id}`;
                groupDiv.className = 'card mb-6';
                groupDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <input type="text" value="${group.name}" class="subsection-title input-field flex-grow mr-2 mb-2 sm:mb-0" onchange="updateOtherGroupName('${group.id}', this.value)">
                        <button onclick="deleteOtherGroup('${group.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="group-members-${group.id}" class="mb-3">
                        <!-- Los miembros se renderizarán aquí -->
                    </div>
                    <button onclick="addMemberToOtherGroup('${group.id}')" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i></button>
                `;
                container.appendChild(groupDiv);
                renderOtherGroupMembers(group.id);
            });
        }

        function updateOtherGroupName(groupId, newName) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                group.name = newName.trim();
                saveData();
            }
        }

        function addOtherGroup() {
            const newGroupNameInput = document.getElementById('newGroupName');
            const newGroupName = newGroupNameInput.value.trim();
            if (newGroupName) {
                appData.otherGroups.push({
                    id: generateUniqueId(),
                    name: newGroupName,
                    members: [""] // Nuevo grupo con un campo por defecto
                });
                newGroupNameInput.value = '';
                saveData();
            } else {
                showModal('Advertencia', 'Por favor, ingresa el nombre del nuevo grupo.', 'alert');
            }
        }

        function deleteOtherGroup(groupId) {
            showModal('Eliminar Grupo', '¿Estás seguro de que quieres eliminar este grupo?', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const group = appData.otherGroups.find(g => g.id === groupId);
                    if (group) {
                        // Desasigna a los miembros antes de eliminar el grupo
                        group.members.forEach(memberId => {
                            const person = appData.personnel.find(p => p.id === memberId);
                            if (person) person.assigned = false;
                        });
                    }
                    appData.otherGroups = appData.otherGroups.filter(g => g.id !== groupId);
                    saveData();
                }
            });
        }

        function renderOtherGroupMembers(groupId) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (!group) return;

            const container = document.getElementById(`group-members-${group.id}`);
            container.innerHTML = '';

            // Renderiza los selectores de miembros existentes
            group.members.forEach((memberId, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center gap-2 mb-2';
                const select = createPersonnelSelect(memberId, (event) => {
                    updateOtherGroupMember(group.id, index, event.target.value);
                });
                memberDiv.appendChild(select);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm p-2 text-xs rounded-full';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>'; // Icono 'X'
                deleteBtn.onclick = () => deleteMemberFromOtherGroup(group.id, index);
                memberDiv.appendChild(deleteBtn);

                container.appendChild(memberDiv);
            });
        }

        function addMemberToOtherGroup(groupId) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                group.members.push(''); // Añade una ranura vacía para un nuevo miembro
                saveData();
            }
        }

        function updateOtherGroupMember(groupId, memberIndex, personId) {
            console.log(`updateOtherGroupMember: Group ID: ${groupId}, Member Index: ${memberIndex}, New Person ID: ${personId}`);
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                // Check for duplicate assignment within the same group
                if (personId && group.members.includes(personId) && group.members.some((id, idx) => id === personId && idx !== memberIndex)) {
                    showModal('Advertencia', 'Este personal ya está asignado a otra posición en este mismo grupo.', 'alert');
                    renderUI(); // Re-render to revert visual selection
                    return;
                }

                // Explicitly unassign the old member if they exist
                const oldMemberId = group.members[memberIndex];
                if (oldMemberId && oldMemberId !== '') { // Only unassign if there was a person assigned
                    const oldPerson = appData.personnel.find(p => p.id === oldMemberId);
                    if (oldPerson) {
                        oldPerson.assigned = false;
                        console.log(`updateOtherGroupMember: Desasignado personal: ${oldPerson.name} (ID: ${oldMemberId})`);
                    }
                }

                // Assign the new member
                group.members[memberIndex] = personId;
                if (personId && personId !== '') { // Only assign if a new person is selected
                    const newPerson = appData.personnel.find(p => p.id === personId);
                    if (newPerson) {
                        newPerson.assigned = true;
                        console.log(`updateOtherGroupMember: Asignado personal: ${newPerson.name} (ID: ${personId})`);
                    }
                }
                saveData();
            }
        }

        function deleteMemberFromOtherGroup(groupId, memberIndex) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                const memberId = group.members[memberIndex];
                if (memberId) {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) person.assigned = false;
                }
                group.members.splice(memberIndex, 1);
                saveData();
            }
        }

        // --- Renderizado General de la UI ---
        function renderUI() {
            console.log('renderUI: Iniciando renderizado de la UI.');
            // Asegura que el estado de asignado sea correcto antes de renderizar los selectores
            updatePersonnelAssignedStatus(); 

            // Actualiza los campos de entrada
            document.getElementById('commanderRank').value = appData.commanderRank;
            document.getElementById('commanderName').value = appData.commanderName;
            document.getElementById('importantServices').value = appData.importantServices.join('\n');

            renderPersonnelList();
            renderCaiSections();
            renderOtherGroups();
            console.log('renderUI: Renderizado de la UI completado. appData final:', JSON.parse(JSON.stringify(appData)));
        }

        // --- Generar Informe ---
        function generateReport() {
            console.log('generateReport: Iniciando generación del informe. appData actual:', JSON.parse(JSON.stringify(appData)));

            const greeting = getGreeting();
            const commanderRank = document.getElementById('commanderRank').value.trim();
            const commanderName = document.getElementById('commanderName').value.trim();
            const importantServicesText = document.getElementById('importantServices').value.trim();
            const importantServices = importantServicesText.split('\n').filter(line => line.trim() !== '');

            let report = `Dios y Patria mi Mayor ${greeting}, respetuosamente me permito reportar el personal para el segundo turno, así:\n\n`;

            // Parte de Zonas de Atención
            const totalZones = appData.caiSections.reduce((acc, cai) => acc + cai.teams.length, 0);
            report += `*Parte =(0-6-21)*\n\n`;
            report += `Total: *(${totalZones})* Zonas de Atención asignados al Nuevo Modelo de Servicio de Policía en la Estación Barrios Unidos, así:\n\n`;

            appData.caiSections.forEach(cai => {
                report += `*${cai.name.toUpperCase()}*\n`;
                cai.teams.forEach(team => {
                    const members = team.members.map(memberId => {
                        const person = appData.personnel.find(p => p.id === memberId);
                        return person ? `${person.grade} ${person.name}` : 'Personal no asignado';
                    }).join(' / ');
                    report += `🚔 ${team.name} ${members}\n`;
                });
                report += '\n'; // Añade un salto de línea después de cada sección CAI
            });

            // Zona T
            const zonaTGroup = appData.otherGroups.find(g => g.name === "Zona T");
            if (zonaTGroup && zonaTGroup.members.length > 0) {
                report += `*Zona T*\n\n`;
                zonaTGroup.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `👮🏻‍♂️ ${person.grade}. ${person.name}\n`;
                    }
                });
                report += '\n';
            }

            // Jefe de Vigilancia
            const jefeVigilanciaGroup = appData.otherGroups.find(g => g.name === "Jefe de Vigilancia");
            if (jefeVigilanciaGroup && jefeVigilanciaGroup.members.length > 0) {
                report += `*Jefe de Vigilancia*\n`;
                jefeVigilanciaGroup.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `${person.grade} ${person.name}\n`;
                    }
                });
                report += '\n';
            }

            // Servicios de Importancia
            if (importantServices.length > 0) {
                report += `*Servicios de Importancia*\n\n`;
                importantServices.forEach(service => {
                    report += `📌${service}\n`;
                });
                report += '\n';
            }

            // Jefe de información E-12 y Centinelas
            const jefeInfoGroup = appData.otherGroups.find(g => g.name === "Jefe de información E-12 y Centinelas");
            if (jefeInfoGroup && jefeInfoGroup.members.length > 0) {
                report += `*Jefe de información E-12 y Centinelas*\n\n`;
                jefeInfoGroup.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `👮🏻‍♂️${person.grade}. ${person.name}\n`;
                    }
                });
                report += '\n';
            }

            // Custodio E-12
            const custodioE12Group = appData.otherGroups.find(g => g.name === "Custodio E-12");
            if (custodioE12Group && custodioE12Group.members.length > 0) {
                report += `*Custodio E-12*\n\n`;
                report += `Parte: (0-1-3)\n\n`; // Esta parte es fija en el ejemplo
                custodioE12Group.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `${person.grade}. ${person.name}\n`;
                    }
                });
                report += '\n';
            }

            // Información de CAI (individual)
            const caiInfoGroups = appData.otherGroups.filter(g => g.name.includes("(Información)"));
            if (caiInfoGroups.length > 0) {
                report += `*Información de CAI*\n\n`;
                caiInfoGroups.forEach(group => {
                    if (group.members.length > 0) {
                        report += `*${group.name.replace(' (Información)', '')}*\n`;
                        group.members.forEach(memberId => {
                            const person = appData.personnel.find(p => p.id === memberId);
                            if (person) {
                                report += `👮🏻‍♂️ ${person.grade}. ${person.name}\n`;
                            }
                        });
                        report += '\n';
                    }
                });
            }

            // Novedades (incluye Vacaciones, Excusado, Calamidad y cualquier otro grupo dinámico)
            const allNovedadesGroups = appData.otherGroups.filter(g => 
                !["Zona T", "Jefe de Vigilancia", "Jefe de información E-12 y Centinelas", "Custodio E-12"].includes(g.name) && 
                !g.name.includes("(Información)") // Exclude (Información) groups from Novedades since they are now a separate section
            );

            if (allNovedadesGroups.length > 0) {
                report += `*📌NOVEDADES*\n\n`;
                allNovedadesGroups.forEach(group => {
                    if (group.members.length > 0) {
                        report += `*${group.name}*\n\n`;
                        group.members.forEach(memberId => {
                            const person = appData.personnel.find(p => p.id === memberId);
                            if (person) {
                                report += `${person.grade} ${person.name}\n`;
                            }
                        });
                        report += '\n';
                    }
                });
            }

            report += `${commanderRank} ${commanderName}\n`;
            report += `*Comandante Estación de Policía Barrios Unidos*\n`;

            document.getElementById('reportOutput').textContent = report;
            console.log('generateReport: Informe final generado:\n', report);
        }

        // --- Función para copiar el informe ---
        function copyReport() {
            const reportText = document.getElementById('reportOutput').textContent;
            try {
                const textarea = document.createElement('textarea');
                textarea.value = reportText;
                textarea.style.position = 'fixed'; // Evita que el scroll se mueva
                textarea.style.opacity = 0; // Lo hace invisible
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000); // Oculta el feedback después de 2 segundos
            } catch (err) {
                console.error('Error al copiar el informe: ', err);
                // Aquí podrías mostrar un mensaje de error al usuario si la copia falla
            }
        }


        // Inicializar la aplicación al cargar la página
        window.onload = loadData;
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informe Policial</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilos base para el cuerpo y contenedor principal */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 1rem; /* Padding general para el cuerpo en móviles */
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* Títulos de sección y subsección */
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            display: flex; /* Para alinear el título con el botón de colapsar */
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Indica que el título es clickeable */
        }
        /* Specific style for CAI titles to make them collapsible */
        .cai-section-title {
            font-size: 1.25rem; /* Smaller than main section title */
            font-weight: bold;
            color: #374151;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb; /* Lighter border for subsections */
        }
        .subsection-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #374151;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
        }
        /* Campos de entrada y áreas de texto */
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        /* Estilos para botones con íconos */
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 44px; /* Asegura un buen tamaño de toque para móviles */
            min-height: 44px; /* Asegura un buen tamaño de toque para móviles */
        }
        /* Variantes de color para botones */
        .btn-primary {
            background-color: #2563eb;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #22c55e;
            color: #ffffff;
        }
        .btn-success:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
        }
        /* Estilos para tarjetas de contenido */
        .card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        /* Estilos para la salida del informe */
        .report-output {
            white-space: pre-wrap; /* Preserva espacios en blanco y saltos de línea */
            word-wrap: break-word; /* Rompe palabras largas */
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 200px;
            font-family: monospace;
            line-height: 1.5;
            color: #374151;
        }
        /* Estilos para elementos de lista de personal */
        .personnel-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .personnel-list-item:last-child {
            border-bottom: none;
        }

        /* --- Estilos para el Modal Personalizado --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 90%; /* Ancho responsivo para móviles */
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.75rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .modal-message {
            font-size: 1rem;
            color: #4b5563;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        /* Estilos para el mensaje de copiado */
        .copy-feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 1001;
        }
        .copy-feedback.show {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            body {
                padding: 2rem;
            }
            .btn {
                padding: 0.75rem 1.25rem; /* Restore larger padding for desktop */
            }
            .flex-col-sm-row {
                flex-direction: row;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-8">Generador de Informe Policial</h1>

        <!-- Sección de Configuración -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
            <h2 class="section-title text-blue-800" onclick="toggleSection('configSection')">
                Configuración del Informe
                <i id="configSectionToggleIcon" class="fas fa-chevron-up"></i>
            </h2>
            <div id="configSectionContent">
                <!-- Comandante -->
                <div class="mb-4">
                    <label for="commanderRank" class="block text-gray-700 font-medium mb-2">Grado del Comandante:</label>
                    <input type="text" id="commanderRank" class="input-field" value="MY." onchange="saveData()">
                </div>
                <div class="mb-4">
                    <label for="commanderName" class="block text-gray-700 font-medium mb-2">Nombre del Comandante:</label>
                    <input type="text" id="commanderName" class="input-field" value="Buitrago Valderrama Diego Alejandro" onchange="saveData()">
                </div>

                <!-- Servicios de Importancia -->
                <div class="mb-6">
                    <h3 class="subsection-title">Servicios de Importancia <span class="text-sm text-gray-500">(uno por línea)</span></h3>
                    <textarea id="importantServices" class="input-field min-h-[150px]" onchange="saveData()"></textarea>
                </div>

                <!-- Gestión de Personal -->
                <div class="mb-6">
                    <h3 class="subsection-title">Gestión de Personal</h3>
                    <div id="personnelListContainer" class="bg-white p-4 rounded-lg border border-gray-200 mb-4 max-h-60 overflow-y-auto">
                        <!-- Los elementos del personal se renderizarán aquí -->
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newPersonnelGrade" class="input-field flex-grow" placeholder="Grado (ej. PT, SI)" aria-label="Nuevo Grado de Personal">
                        <input type="text" id="newPersonnelName" class="input-field flex-grow" placeholder="Nombre (ej. Martin, Daniela)" aria-label="Nuevo Nombre de Personal">
                        <button onclick="addPersonnel()" class="btn btn-success"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Equipos y Grupos -->
        <div class="mb-8 p-6 bg-green-50 rounded-lg shadow-inner">
            <h2 class="section-title text-green-800">
                Asignación de Equipos y Grupos
            </h2>
            <div id="assignmentSectionContent">
                <!-- Secciones CAI -->
                <div id="caiSectionsContainer">
                    <!-- Las secciones CAI se renderizarán aquí -->
                </div>
                <button onclick="addCaiSection()" class="btn btn-primary mt-4"><i class="fas fa-plus"></i></button>

                <!-- Otros Grupos -->
                <div class="mt-8">
                    <h3 class="subsection-title">Otros Grupos</h3>
                    <div id="otherGroupsContainer">
                        <!-- Otros grupos se renderizarán aquí -->
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <input type="text" id="newGroupName" class="input-field flex-grow" placeholder="Nombre del nuevo grupo" aria-label="Nuevo Nombre del Grupo">
                        <button onclick="addOtherGroup()" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón de Generar Informe -->
        <div class="text-center mb-8">
            <button onclick="generateReport()" class="btn btn-primary text-xl px-8 py-4">Generar Informe</button>
        </div>

        <!-- Área de Salida del Informe -->
        <div class="p-6 bg-gray-100 rounded-lg shadow-inner relative">
            <h2 class="section-title text-gray-800">Informe Generado</h2>
            <button onclick="copyReport()" class="absolute top-4 right-4 btn btn-secondary p-2 text-lg" title="Copiar informe">
                <i class="fas fa-copy"></i>
            </button>
            <pre id="reportOutput" class="report-output"></pre>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="customModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="modal-title"></h3>
            <p id="modalMessage" class="modal-message"></p>
            <input type="text" id="modalInput" class="modal-input hidden">
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn btn-primary hidden">Aceptar</button>
                <button id="modalCancelBtn" class="btn btn-secondary hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Feedback de copiado -->
    <div id="copyFeedback" class="copy-feedback">
        ¡Copiado!
    </div>

    <script>
        let scrollPosition = 0; // Variable para almacenar la posición de desplazamiento

        // Función para generar un ID único
        function generateUniqueId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Helper function to determine personnel category based on grade
        function getPersonnelCategory(grade) {
            const oficiales = ["TC", "MY", "CT", "TE", "ST"];
            const suboficiales = ["CM", "SC", "IJ", "IT", "SI"];
            const patrulleros = ["PT", "PP"];

            if (oficiales.includes(grade.toUpperCase())) {
                return "Oficiales";
            } else if (suboficiales.includes(grade.toUpperCase())) {
                return "Suboficiales";
            } else if (patrulleros.includes(grade.toUpperCase())) {
                return "Patrulleros";
            } else {
                return "Desconocido"; // Default category if not found
            }
        }

        // Datos iniciales por defecto
        const defaultData = {
            commanderName: "Buitrago Valderrama Diego Alejandro",
            commanderRank: "MY.",
            importantServices: [
                "Puntos criticos",
                "Sector comercio",
                "Sector bancario",
                "Sector residencial",
                "Carrilera",
                "Zona Tolerancia",
                "Universidades",
                "Talleres 7 Agosto",
                "Puentes de la 92",
                "Av. Caracas",
                "Calle 63",
                "Carrera 30",
                "Calle 80"
            ],
            personnel: [
                { id: generateUniqueId(), grade: "PT", name: "Martin", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Daniela", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Rosario", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Karol", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "SI", name: "Chacon", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "SI", name: "Manrique", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "SI", name: "Diaz", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PT", name: "Ospino", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Solano", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Hernandez", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "SI", name: "Pineda", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PT", name: "Escobar", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "SI", name: "Corredor", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PP", name: "Maria", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Castillo", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PP", name: "Juana", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Jurado", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "González Marrugo", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Chavarria", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PP", name: "Sofia", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "SI", name: "Gomez Lozano", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PT", name: "Montenegro", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "IJ", name: "Manuel Antonio Arias Guerra", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "SI", name: "Nieto", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "SI", name: "Ávila", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PT", name: "Higuita", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Ballesteros", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "González", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Marquez", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Gomez Muñoz", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Nayerly", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Sierra", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Garzon Garcia", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "SI", name: "Olivero", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "SI", name: "Marmol", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PT", name: "Sanchez", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "PT", name: "Trujillo", assigned: false, category: "Patrulleros" },
                { id: generateUniqueId(), grade: "SI", name: "Gonzalez", assigned: false, category: "Suboficiales" },
                { id: generateUniqueId(), grade: "PT", name: "Velazquez Bohorquez", assigned: false, category: "Patrulleros" }
            ],
            caiSections: [
                {
                    id: generateUniqueId(), name: "CAI - MODELO",
                    teams: [
                        { id: generateUniqueId(), name: "11-13", members: [] },
                        { id: generateUniqueId(), name: "12-14", members: [] },
                        { id: generateUniqueId(), name: "15-16", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - ALCAZARES",
                    teams: [
                        { id: generateUniqueId(), name: "1", members: [] },
                        { id: generateUniqueId(), name: "2", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - POLO CLUB",
                    teams: [
                        { id: generateUniqueId(), name: "6-7", members: [] },
                        { id: generateUniqueId(), name: "8", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - RIONEGRO",
                    teams: [
                        { id: generateUniqueId(), name: "9", members: [] },
                        { id: generateUniqueId(), name: "10", members: [] }
                    ]
                },
                {
                    id: generateUniqueId(), name: "CAI - 7 DE AGOSTO",
                    teams: [
                        { id: generateUniqueId(), name: "3", members: [] },
                        { id: generateUniqueId(), name: "4-5", members: [] }
                    ]
                }
            ],
            otherGroups: [
                { id: generateUniqueId(), name: "Jefe de Vigilancia", members: [], defaultName: "Jefe de Vigilancia" },
                { id: generateUniqueId(), name: "Zona T", members: [], defaultName: "Zona T" }, // Added "Zona T" group
                { id: generateUniqueId(), name: "Jefe de información E-12 y Centinelas", members: [], defaultName: "Jefe de información E-12 y Centinelas" },
                { id: generateUniqueId(), name: "Custodio E-12", members: [], defaultName: "Custodio E-12" },
                { id: generateUniqueId(), name: "CAI - ALCÁZARES (Información)", members: [], defaultName: "CAI - ALCÁZARES (Información)" },
                { id: generateUniqueId(), name: "CAI - MODELO (Información)", members: [], defaultName: "CAI - MODELO (Información)" },
                { id: generateUniqueId(), name: "CAI - POLO CLUB (Información)", members: [], defaultName: "CAI - POLO CLUB (Información)" },
                { id: generateUniqueId(), name: "CAI - RIONEGRO (Información)", members: [], defaultName: "CAI - RIONEGRO (Información)" },
                { id: generateUniqueId(), name: "CAI 7 DE AGOSTO (Información)", members: [], defaultName: "CAI 7 DE AGOSTO (Información)" },
                { id: generateUniqueId(), name: "Vacaciones", members: [], defaultName: "Vacaciones" },
                { id: generateUniqueId(), name: "Excusado", members: [], defaultName: "Excusado" },
                { id: generateUniqueId(), name: "Calamidad", members: [], defaultName: "Calamidad" }
            ],
            // UI state to manage collapsed sections
            uiState: {
                collapsedSections: {
                    configSection: true, // Set to true (collapsed) by default
                },
                collapsedCaiSections: {
                    // Initialize all default CAIs to be collapsed
                    // This will be populated dynamically in loadData based on defaultData.caiSections
                }
            }
        };

        let appData = {};

        // --- Funciones para el Modal Personalizado ---
        const modalOverlay = document.getElementById('customModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        let modalCallback = null;

        function showModal(title, message, type, defaultValue = '', callback) {
            scrollPosition = window.scrollY; // Guarda la posición de desplazamiento actual
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCallback = callback;

            modalInput.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            if (type === 'prompt') {
                modalInput.value = defaultValue;
                modalInput.classList.remove('hidden');
                modalConfirmBtn.textContent = 'Aceptar';
                modalConfirmBtn.classList.remove('hidden');
            } else if (type === 'confirm') {
                modalConfirmBtn.textContent = 'Sí';
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.textContent = 'No';
                modalCancelBtn.classList.remove('hidden');
            }

            modalOverlay.classList.add('active');
            // Deshabilita el desplazamiento del cuerpo mientras el modal está activo
            document.body.style.overflow = 'hidden';
            if (type === 'prompt') {
                modalInput.focus();
            }
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restaura el desplazamiento del cuerpo
            window.scrollTo(0, scrollPosition); // Vuelve a la posición de desplazamiento guardada
        }

        modalConfirmBtn.onclick = () => {
            closeModal();
            if (modalCallback) {
                if (!modalInput.classList.contains('hidden')) {
                    modalCallback(modalInput.value);
                } else {
                    modalCallback(true);
                }
            }
        };

        modalCancelBtn.onclick = () => {
            closeModal();
            if (modalCallback) {
                modalCallback(false);
            }
        };

        // --- Fin de funciones del Modal Personalizado ---

        // Function to load data from localStorage
        function loadData() {
            const storedData = localStorage.getItem('policeReportData');
            if (storedData) {
                appData = JSON.parse(storedData);
                // Ensures default structure is maintained for new properties
                appData.personnel = appData.personnel || defaultData.personnel;
                appData.caiSections = appData.caiSections || defaultData.caiSections;
                appData.otherGroups = appData.otherGroups || defaultData.otherGroups;
                appData.importantServices = appData.importantServices || defaultData.importantServices;
                appData.commanderName = appData.commanderName || defaultData.commanderName;
                appData.commanderRank = appData.commanderRank || defaultData.commanderRank;

                // Initialize uiState if it doesn't exist or is incomplete
                appData.uiState = appData.uiState || {};
                appData.uiState.collapsedSections = appData.uiState.collapsedSections || defaultData.uiState.collapsedSections;
                appData.uiState.collapsedCaiSections = appData.uiState.collapsedCaiSections || {}; // Ensure it's an object

                // Populate collapsedCaiSections with default collapsed state if not already present
                defaultData.caiSections.forEach(cai => {
                    if (appData.uiState.collapsedCaiSections[cai.id] === undefined) {
                        appData.uiState.collapsedCaiSections[cai.id] = true; // Set to true (collapsed) by default
                    }
                });

                // Ensure "Zona T" group exists in appData if it's new in defaultData
                const zonaTGroupExists = appData.otherGroups.some(g => g.name === "Zona T");
                if (!zonaTGroupExists) {
                    const zonaTDefault = defaultData.otherGroups.find(g => g.name === "Zona T");
                    if (zonaTDefault) {
                        appData.otherGroups.push(zonaTDefault);
                    }
                }


                // Re-assigns initial personnel to match default structure if not assigned
                defaultData.personnel.forEach(defaultP => {
                    const found = appData.personnel.find(p => p.grade === defaultP.grade && p.name === defaultP.name);
                    if (!found) {
                        appData.personnel.push({ ...defaultP, assigned: false, category: getPersonnelCategory(defaultP.grade) }); // Assign category for new default personnel
                    }
                });

                // Ensure all personnel have a category, re-assign if missing or incorrect based on current rules
                appData.personnel.forEach(person => {
                    person.category = getPersonnelCategory(person.grade);
                });

                // If no assignments loaded, apply default ones
                if (appData.caiSections.every(s => s.teams.every(t => t.members.length === 0)) &&
                    appData.otherGroups.every(g => g.members.every(m => m === ''))) { // Check for empty strings in members
                    assignDefaultPersonnel();
                } else {
                    // If data was loaded, ensure assigned status is correct
                    updatePersonnelAssignedStatus();
                }

            } else {
                appData = JSON.parse(JSON.stringify(defaultData)); // Deep copy of default data
                // Initialize all default CAIs to be collapsed for new data
                appData.caiSections.forEach(cai => {
                    appData.uiState.collapsedCaiSections[cai.id] = true;
                });
                // Set configSection to true (collapsed) for new data
                appData.uiState.collapsedSections.configSection = true;
                // Ensure categories are set for default personnel when initializing new data
                appData.personnel.forEach(person => {
                    person.category = getPersonnelCategory(person.grade);
                });
                assignDefaultPersonnel(); // Assigns default personnel to their initial places
            }
            renderUI();
        }

        // Función para asignar el personal por defecto a sus lugares iniciales
        function assignDefaultPersonnel() {
            // Reinicia todo el personal a no asignado primero
            appData.personnel.forEach(p => p.assigned = false);

            // Asigna el personal a los equipos CAI (basado en nombres para coincidir)
            const defaultCaiAssignments = [
                { caiName: "CAI - MODELO", teamName: "11-13", members: ["PT_Martin", "PT_Daniela"] },
                { caiName: "CAI - MODELO", teamName: "12-14", members: ["PT_Rosario", "PT_Karol"] },
                { caiName: "CAI - MODELO", teamName: "15-16", members: ["SI_Chacon", "SI_Manrique"] },
                { caiName: "CAI - ALCAZARES", teamName: "1", members: ["SI_Diaz", "PT_Ospino"] },
                { caiName: "CAI - ALCAZARES", teamName: "2", members: ["PT_Solano", "PT_Hernandez"] },
                { caiName: "CAI - POLO CLUB", teamName: "6-7", members: ["SI_Pineda", "PT_Escobar"] },
                { caiName: "CAI - POLO CLUB", teamName: "8", members: ["SI_Corredor", "PP_Maria"] },
                { caiName: "CAI - RIONEGRO", teamName: "9", members: ["PT_Castillo", "PP_Juana"] },
                { caiName: "CAI - RIONEGRO", teamName: "10", members: ["PT_Jurado", "PT_González Marrugo"] },
                { caiName: "CAI - 7 DE AGOSTO", teamName: "3", members: ["PT_Chavarria", "PP_Sofia"] },
                { caiName: "CAI - 7 DE AGOSTO", teamName: "4-5", members: ["SI_Gomez Lozano", "PT_Montenegro"] }
            ];

            defaultCaiAssignments.forEach(assignment => {
                const cai = appData.caiSections.find(c => c.name === assignment.caiName);
                if (cai) {
                    const team = cai.teams.find(t => t.name === assignment.teamName);
                    if (team) {
                        team.members = assignment.members.map(memberString => {
                            const [grade, ...nameParts] = memberString.split('_');
                            const name = nameParts.join(' ');
                            const person = appData.personnel.find(p => p.grade === grade && p.name === name);
                            if (person) {
                                person.assigned = true;
                                return person.id;
                            }
                            return ''; // Return empty string if not found
                        }).filter(Boolean); // Filter out any nulls/empty strings
                    }
                }
            });

            // Asigna el personal a otros grupos (basado en nombres para coincidir)
            const defaultOtherGroupAssignments = [
                { groupName: "Jefe de Vigilancia", members: ["IJ_Manuel Antonio Arias Guerra"] },
                { groupName: "Zona T", members: [] }, // No default member for Zona T, as it's a new group
                { groupName: "Jefe de información E-12 y Centinelas", members: ["SI_Nieto"] },
                { groupName: "Custodio E-12", members: ["SI_Ávila", "PT_Higuita", "PT_Ballesteros", "PT_González"] },
                { groupName: "CAI - ALCÁZARES (Información)", members: ["PT_Marquez"] },
                { groupName: "CAI - MODELO (Información)", members: ["PT_Gomez Muñoz"] },
                { groupName: "CAI - POLO CLUB (Información)", members: ["PT_Nayerly"] },
                { groupName: "CAI - RIONEGRO (Información)", members: ["PT_Sierra"] },
                { groupName: "CAI 7 DE AGOSTO (Información)", members: ["PT_Garzon Garcia"] },
                { groupName: "Vacaciones", members: ["SI_Olivero", "SI_Marmol", "PT_Sanche", "PT_Velázquez"] },
                { groupName: "Excusado", members: ["PT_Trujillo"] },
                { groupName: "Calamidad", members: ["SI_Gonzalez"] }
            ];

            // Assign "Zona T" default member if it exists
            const zonaTGroup = appData.otherGroups.find(g => g.name === "Zona T");
            if (zonaTGroup) {
                const zonaTDefault = defaultOtherGroupAssignments.find(a => a.groupName === "Zona T");
                if (zonaTDefault) {
                    zonaTGroup.members = zonaTDefault.members.map(memberString => {
                        const [grade, ...nameParts] = memberString.split('_');
                        const name = nameParts.join(' ');
                        const person = appData.personnel.find(p => p.grade === grade && p.name === name);
                        if (person) {
                            person.assigned = true;
                            return person.id;
                        }
                        return '';
                    }).filter(Boolean);
                }
            }


            defaultOtherGroupAssignments.forEach(assignment => {
                // Skip "Zona T" as it's handled separately
                if (assignment.groupName === "Zona T") return;

                const group = appData.otherGroups.find(g => g.name === assignment.groupName);
                if (group) {
                    group.members = assignment.members.map(memberString => {
                        const [grade, ...nameParts] = memberString.split('_');
                        const name = nameParts.join(' ');
                        const person = appData.personnel.find(p => p.grade === grade && p.name === name);
                        if (person) {
                            person.assigned = true;
                            return person.id;
                        }
                        return ''; // Return empty string if not found
                    }).filter(Boolean); // Filter out any nulls/empty strings
                }
            });
            updatePersonnelAssignedStatus(); // Re-run to ensure all assigned statuses are correct after default assignment
        }

        // Función para guardar datos en localStorage
        function saveData() {
            localStorage.setItem('policeReportData', JSON.stringify(appData));
            renderUI(); // Re-renderiza la UI después de guardar para actualizar el personal disponible
        }

        // Función para obtener el saludo según la hora
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) {
                return "buenos días";
            } else if (hour >= 12 && hour < 19) {
                return "buenas tardes";
            } else {
                return "buenas noches";
            }
        }

        // --- Gestión de Personal ---
        function renderPersonnelList() {
            const container = document.getElementById('personnelListContainer');
            container.innerHTML = '';
            appData.personnel.forEach(person => {
                const div = document.createElement('div');
                div.className = 'personnel-list-item';
                div.innerHTML = `
                    <span class="text-gray-800">${person.grade} ${person.name}</span>
                    <div class="flex gap-2">
                        <button onclick="editPersonnel('${person.id}')" class="text-blue-600 hover:text-blue-800 text-sm p-1 rounded-full"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePersonnel('${person.id}')" class="text-red-600 hover:text-red-800 text-sm p-1 rounded-full"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPersonnel() {
            const gradeInput = document.getElementById('newPersonnelGrade');
            const nameInput = document.getElementById('newPersonnelName');
            const grade = gradeInput.value.trim();
            const name = nameInput.value.trim();

            if (grade && name) {
                const category = getPersonnelCategory(grade); // Get category
                appData.personnel.push({ id: generateUniqueId(), grade: grade, name: name, assigned: false, category: category });
                gradeInput.value = '';
                nameInput.value = '';
                saveData();
            }
        }

        function editPersonnel(id) {
            const person = appData.personnel.find(p => p.id === id);
            if (person) {
                showModal('Editar Grado', `Editar grado para ${person.name}:`, 'prompt', person.grade, (newGrade) => {
                    if (newGrade !== null) {
                        showModal('Editar Nombre', `Editar nombre para ${person.grade} ${person.name}:`, 'prompt', person.name, (newName) => {
                            if (newName !== null) {
                                person.grade = newGrade.trim();
                                person.name = newName.trim();
                                person.category = getPersonnelCategory(newGrade.trim()); // Update category on grade change
                                saveData();
                            }
                        });
                    }
                });
            }
        }

        function deletePersonnel(id) {
            showModal('Eliminar Personal', '¿Estás seguro de que quieres eliminar a este miembro del personal? Esto lo desasignará de todos los equipos.', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    appData.personnel = appData.personnel.filter(p => p.id !== id);
                    // Eliminar de todas las asignaciones
                    appData.caiSections.forEach(cai => {
                        cai.teams.forEach(team => {
                            team.members = team.members.filter(memberId => memberId !== id);
                        });
                    });
                    appData.otherGroups.forEach(group => {
                        group.members = group.members.filter(memberId => memberId !== id);
                    });
                    saveData();
                }
            });
        }

        // --- Renderizado de Selectores de Personal ---
        function getAvailablePersonnel() {
            return appData.personnel.filter(p => !p.assigned);
        }

        function createPersonnelSelect(selectedPersonId = '', onChangeCallback) {
            const select = document.createElement('select');
            select.className = 'input-field w-full';
            select.innerHTML = '<option value="">-- Seleccionar Personal --</option>';

            const available = getAvailablePersonnel();
            const assignedPerson = selectedPersonId ? appData.personnel.find(p => p.id === selectedPersonId) : null;

            // Añade a la persona actualmente asignada a las opciones, incluso si está marcada como asignada
            if (assignedPerson) {
                const option = document.createElement('option');
                option.value = assignedPerson.id;
                option.textContent = `${assignedPerson.grade} ${assignedPerson.name}`;
                select.appendChild(option);
            }

            // Añade el resto del personal disponible
            available.forEach(person => {
                if (person.id !== selectedPersonId) { // Evita duplicar si ya se añadió como asignado
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = `${person.grade} ${person.name}`;
                    select.appendChild(option);
                }
            });

            // Set selected option
            if (selectedPersonId) {
                select.value = selectedPersonId;
            }

            select.onchange = onChangeCallback;
            return select;
        }

        // --- Actualizar estado de 'assigned' para el personal ---
        function updatePersonnelAssignedStatus() {
            appData.personnel.forEach(p => p.assigned = false); // Reinicia todos

            // Marca el personal asignado en los equipos CAI
            appData.caiSections.forEach(cai => {
                cai.teams.forEach(team => {
                    team.members.forEach(memberId => {
                        const person = appData.personnel.find(p => p.id === memberId);
                        if (person) person.assigned = true;
                    });
                });
            });

            // Marca el personal asignado en otros grupos
            appData.otherGroups.forEach(group => {
                group.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) person.assigned = true;
                });
            });
        }


        // --- Renderizado de Secciones CAI ---
        function renderCaiSections() {
            const container = document.getElementById('caiSectionsContainer');
            container.innerHTML = '';

            appData.caiSections.forEach(cai => {
                const caiDiv = document.createElement('div');
                caiDiv.id = `cai-${cai.id}`;
                caiDiv.className = 'card mb-6';
                caiDiv.innerHTML = `
                    <div class="cai-section-title" onclick="toggleCaiSection('${cai.id}')">
                        <input type="text" value="${cai.name}" class="font-semibold input-field flex-grow mr-2 mb-2 sm:mb-0" onchange="updateCaiName('${cai.id}', this.value)" onclick="event.stopPropagation();">
                        <i id="caiToggleIcon-${cai.id}" class="fas fa-chevron-up ml-2"></i>
                    </div>
                    <div id="caiContent-${cai.id}">
                        <div id="cai-teams-${cai.id}">
                            <!-- Los equipos se renderizarán aquí -->
                        </div>
                        <button onclick="addCaiTeam('${cai.id}')" class="btn btn-secondary mt-4"><i class="fas fa-plus"></i></button>
                        <div id="cai-info-${cai.id}" class="mt-6">
                            <!-- La sección de información del CAI se renderizará aquí -->
                        </div>
                    </div>
                `;
                container.appendChild(caiDiv);
                renderCaiTeams(cai.id);
                renderCaiInfoSection(cai.id, cai.name); // Render the CAI info section
                applyCaiSectionState(cai.id); // Apply state after rendering
            });
        }

        function renderCaiInfoSection(caiId, caiName) {
            const container = document.getElementById(`cai-info-${caiId}`);
            if (!container) return; // Ensure the container exists

            // Find the corresponding "Información" group
            const infoGroupName = `${caiName} (Información)`;
            const infoGroup = appData.otherGroups.find(g => g.name === infoGroupName);

            if (infoGroup) {
                container.innerHTML = `
                    <h3 class="subsection-title">Información de ${caiName.replace('CAI - ', '')}</h3>
                    <div id="cai-info-members-container-${infoGroup.id}" class="mb-3">
                        <!-- Los miembros de información se renderizarán aquí -->
                    </div>
                    <button onclick="addMemberToOtherGroup('${infoGroup.id}', 'cai-info-members-container-')" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i></button>
                `;
                renderOtherGroupMembers(infoGroup.id, 'cai-info-members-container-'); // Pass the correct container ID prefix
            } else {
                // If no matching info group, optionally display a message or nothing
                container.innerHTML = `<p class="text-gray-500 text-sm">No hay sección de información para este CAI.</p>`;
            }
        }


        function updateCaiName(caiId, newName) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                // Update the CAI name
                cai.name = newName.trim();

                // Also, update the name of the corresponding "Información" group in otherGroups
                const oldInfoGroupName = `${cai.name} (Información)`; // Use old name to find
                const newInfoGroupName = `${newName.trim()} (Información)`; // New name for the group
                const infoGroup = appData.otherGroups.find(g => g.name === oldInfoGroupName);
                if (infoGroup) {
                    infoGroup.name = newInfoGroupName;
                }
                saveData();
            }
        }

        function addCaiSection() {
            showModal('Añadir Sección CAI', 'Ingrese el nombre de la nueva sección CAI (ej. CAI - NUEVO):', 'prompt', '', (newCaiName) => {
                if (newCaiName) {
                    const newCaiId = generateUniqueId();
                    appData.caiSections.push({
                        id: newCaiId,
                        name: newCaiName.trim(),
                        teams: []
                    });
                    // Initialize the new CAI as collapsed by default
                    appData.uiState.collapsedCaiSections[newCaiId] = true;

                    // Also add a corresponding "Información" group
                    appData.otherGroups.push({
                        id: generateUniqueId(),
                        name: `${newCaiName.trim()} (Información)`,
                        members: []
                    });
                    saveData();
                }
            });
        }

        function deleteCaiSection(caiId) {
            showModal('Eliminar Sección CAI', '¿Estás seguro de que quieres eliminar esta sección CAI y todos sus equipos?', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const cai = appData.caiSections.find(c => c.id === caiId);
                    if (cai) {
                        // Desasigna a los miembros antes de eliminar la sección CAI
                        cai.teams.forEach(team => {
                            team.members.forEach(memberId => {
                                const person = appData.personnel.find(p => p.id === memberId);
                                if (person) person.assigned = false;
                            });
                        });

                        // Also remove the corresponding "Información" group
                        const infoGroupName = `${cai.name} (Información)`;
                        appData.otherGroups = appData.otherGroups.filter(g => g.name !== infoGroupName);
                    }
                    appData.caiSections = appData.caiSections.filter(c => c.id !== caiId);
                    delete appData.uiState.collapsedCaiSections[caiId]; // Remove state for deleted CAI
                    saveData();
                }
            });
        }

        // --- Renderizado de Equipos de CAI ---
        function renderCaiTeams(caiId) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (!cai) return;

            const container = document.getElementById(`cai-teams-${cai.id}`);
            container.innerHTML = '';

            cai.teams.forEach((team, teamIndex) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'card bg-white p-4 mb-3';
                teamDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-content-between items-center mb-3">
                        <input type="text" value="${team.name}" class="font-semibold input-field flex-grow mr-2 mb-2 sm:mb-0" onchange="updateCaiTeamName('${cai.id}', '${team.id}', this.value)">
                        <button onclick="deleteCaiTeam('${cai.id}', '${team.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div id="cai-${cai.id}-team-${team.id}-member1" class="flex-1"></div>
                        <div id="cai-${cai.id}-team-${team.id}-member2" class="flex-1"></div>
                    </div>
                `;
                container.appendChild(teamDiv);

                // Renderiza los selectores de miembros
                const member1Container = document.getElementById(`cai-${cai.id}-team-${team.id}-member1`);
                const member2Container = document.getElementById(`cai-${cai.id}-team-${team.id}-member2`);

                member1Container.appendChild(createPersonnelSelect(team.members[0], (event) => {
                    updateCaiTeamMember(cai.id, team.id, 0, event.target.value);
                }));
                member2Container.appendChild(createPersonnelSelect(team.members[1], (event) => {
                    updateCaiTeamMember(cai.id, team.id, 1, event.target.value);
                }));
            });
        }

        function updateCaiTeamName(caiId, teamId, newName) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                const team = cai.teams.find(t => t.id === teamId);
                if (team) {
                    team.name = newName.trim();
                    saveData();
                }
            }
        }

        function updateCaiTeamMember(caiId, teamId, memberIndex, personId) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                const team = cai.teams.find(t => t.id === teamId);
                if (team) {
                    // Verifica si hay una asignación duplicada dentro del mismo equipo
                    if (personId && team.members.includes(personId) && team.members[1 - memberIndex] === personId) {
                        // Si la persona seleccionada ya está en la otra ranura de este equipo,
                        // y no es la opción "vacía", evita la asignación.
                        // No es necesario un alert, simplemente no se actualiza y se re-renderiza.
                        renderUI(); // Re-renderiza para revertir la selección visualmente
                        return;
                    }

                    // Antes de actualizar, desasigna al miembro anterior si existe
                    const oldMemberId = team.members[memberIndex];
                    if (oldMemberId) {
                        const oldPerson = appData.personnel.find(p => p.id === oldMemberId);
                        if (oldPerson) oldPerson.assigned = false;
                    }

                    // Asigna al nuevo miembro
                    team.members[memberIndex] = personId;
                    if (personId) {
                        const newPerson = appData.personnel.find(p => p.id === personId);
                        if (newPerson) newPerson.assigned = true;
                    }
                    saveData();
                }
            }
        }


        function addCaiTeam(caiId) {
            const cai = appData.caiSections.find(c => c.id === caiId);
            if (cai) {
                showModal('Añadir Equipo', 'Ingrese el nombre del nuevo equipo (ej. 17-18):', 'prompt', '', (newTeamName) => {
                    if (newTeamName) {
                        cai.teams.push({ id: generateUniqueId(), name: newTeamName.trim(), members: [] });
                        saveData();
                    }
                });
            }
        }

        function deleteCaiTeam(caiId, teamId) {
            showModal('Eliminar Equipo', '¿Estás seguro de que quieres eliminar este equipo?', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const cai = appData.caiSections.find(c => c.id === caiId);
                    if (cai) {
                        const team = cai.teams.find(t => t.id === teamId);
                        if (team) {
                            // Desasigna a los miembros antes de eliminar el equipo
                            team.members.forEach(memberId => {
                                const person = appData.personnel.find(p => p.id === memberId);
                                if (person) person.assigned = false;
                            });
                        }
                        cai.teams = cai.teams.filter(t => t.id !== teamId);
                        saveData();
                    }
                }
            });
        }

        // --- Renderizado de Otros Grupos ---
        function renderOtherGroups() {
            const container = document.getElementById('otherGroupsContainer');
            container.innerHTML = '';

            // Filter out the "Información" groups as they are now rendered within CAI sections
            const filteredOtherGroups = appData.otherGroups.filter(group =>
                !group.name.includes("(Información)")
            );

            filteredOtherGroups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.id = `group-${group.id}`;
                groupDiv.className = 'card mb-6';
                // Display "Zona T" as "Zona T" in the UI, but keep its internal name for report logic
                const displayName = (group.name === "Zona T") ? "Zona T" : group.name;

                groupDiv.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-content-between items-center mb-4">
                        <input type="text" value="${displayName}" class="subsection-title input-field flex-grow mr-2 mb-2 sm:mb-0" onchange="updateOtherGroupName('${group.id}', this.value)">
                        <button onclick="deleteOtherGroup('${group.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="group-members-container-${group.id}" class="mb-3">
                        <!-- Los miembros se renderizarán aquí -->
                    </div>
                    <button onclick="addMemberToOtherGroup('${group.id}', 'group-members-container-')" class="btn btn-secondary btn-sm"><i class="fas fa-plus"></i></button>
                `;
                container.appendChild(groupDiv);
                renderOtherGroupMembers(group.id, 'group-members-container-'); // Pass the correct container ID prefix
            });
        }

        function updateOtherGroupName(groupId, newName) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                group.name = newName.trim();
                saveData();
            }
        }

        function addOtherGroup() {
            const newGroupNameInput = document.getElementById('newGroupName');
            const newGroupName = newGroupNameInput.value.trim();
            if (newGroupName) {
                appData.otherGroups.push({
                    id: generateUniqueId(),
                    name: newGroupName,
                    members: []
                });
                newGroupNameInput.value = '';
                saveData();
            }
        }

        function deleteOtherGroup(groupId) {
            showModal('Eliminar Grupo', '¿Estás seguro de que quieres eliminar este grupo?', 'confirm', '', (confirmed) => {
                if (confirmed) {
                    const group = appData.otherGroups.find(g => g.id === groupId);
                    if (group) {
                        // Desasigna a los miembros antes de eliminar el grupo
                        group.members.forEach(memberId => {
                            const person = appData.personnel.find(p => p.id === memberId);
                            if (person) person.assigned = false;
                        });
                    }
                    appData.otherGroups = appData.otherGroups.filter(g => g.id !== groupId);
                    saveData();
                }
            });
        }

        // Modified to accept containerIdPrefix
        function renderOtherGroupMembers(groupId, containerIdPrefix) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (!group) return;

            const container = document.getElementById(`${containerIdPrefix}${groupId}`);
            if (!container) return; // Ensure the container exists

            container.innerHTML = ''; // Clear existing members for re-render

            // Render existing members
            group.members.forEach((memberId, index) => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center gap-2 mb-2';
                const select = createPersonnelSelect(memberId, (event) => {
                    updateOtherGroupMember(group.id, index, event.target.value);
                });
                memberDiv.appendChild(select);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm p-2 text-xs rounded-full';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>'; // Icono 'X'
                deleteBtn.onclick = () => deleteMemberFromOtherGroup(group.id, index);
                memberDiv.appendChild(deleteBtn);

                container.appendChild(memberDiv);
            });

            // If no members, add one empty select field
            if (group.members.length === 0) {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'flex items-center gap-2 mb-2';
                const select = createPersonnelSelect('', (event) => {
                    // When this empty select changes, it means a new member is being assigned
                    // We need to add it to the group.members array and then re-render
                    if (event.target.value) {
                        group.members.push(event.target.value);
                        saveData();
                    }
                });
                memberDiv.appendChild(select);
                container.appendChild(memberDiv);
            }
        }

        // Modified to accept containerIdPrefix
        function addMemberToOtherGroup(groupId, containerIdPrefix) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                group.members.push(''); // Añade una ranura vacía para un nuevo miembro
                saveData();
            }
        }

        function updateOtherGroupMember(groupId, memberIndex, personId) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                // Desasigna al miembro anterior si existe
                const oldMemberId = group.members[memberIndex];
                if (oldMemberId) {
                    const oldPerson = appData.personnel.find(p => p.id === oldMemberId);
                    if (oldPerson) oldPerson.assigned = false;
                }

                // Asigna al nuevo miembro
                group.members[memberIndex] = personId;
                if (personId) {
                    const newPerson = appData.personnel.find(p => p.id === personId);
                    if (newPerson) newPerson.assigned = true;
                }
                saveData();
            }
        }

        function deleteMemberFromOtherGroup(groupId, memberIndex) {
            const group = appData.otherGroups.find(g => g.id === groupId);
            if (group) {
                const memberId = group.members[memberIndex];
                if (memberId) {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) person.assigned = false;
                }
                group.members.splice(memberIndex, 1);
                saveData();
            }
        }

        // --- Toggle Section Functionality (for main sections) ---
        function toggleSection(sectionId) {
            const contentDiv = document.getElementById(`${sectionId}Content`);
            const toggleIcon = document.getElementById(`${sectionId}ToggleIcon`);

            if (contentDiv && toggleIcon) {
                const isCollapsed = contentDiv.classList.toggle('hidden'); // Toggles the 'hidden' class
                appData.uiState.collapsedSections[sectionId] = isCollapsed; // Update state
                saveData(); // Save the new state

                // Toggle icon
                if (isCollapsed) {
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                } else {
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                }
            }
        }

        // --- Apply Section State on Load (for main sections) ---
        function applySectionState(sectionId) {
            const contentDiv = document.getElementById(`${sectionId}Content`);
            const toggleIcon = document.getElementById(`${sectionId}ToggleIcon`);

            if (contentDiv && toggleIcon) {
                const isCollapsed = appData.uiState.collapsedSections[sectionId];
                if (isCollapsed) {
                    contentDiv.classList.add('hidden');
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                } else {
                    contentDiv.classList.remove('hidden');
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                }
            }
        }

        // --- Toggle CAI Section Functionality ---
        function toggleCaiSection(caiId) {
            const contentDiv = document.getElementById(`caiContent-${caiId}`);
            const toggleIcon = document.getElementById(`caiToggleIcon-${caiId}`);

            if (contentDiv && toggleIcon) {
                const isCollapsed = contentDiv.classList.toggle('hidden');
                appData.uiState.collapsedCaiSections[caiId] = isCollapsed;
                saveData();

                if (isCollapsed) {
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                } else {
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                }
            }
        }

        // --- Apply CAI Section State on Load ---
        function applyCaiSectionState(caiId) {
            const contentDiv = document.getElementById(`caiContent-${caiId}`);
            const toggleIcon = document.getElementById(`caiToggleIcon-${caiId}`);

            if (contentDiv && toggleIcon) {
                // Ensure the state exists, default to true (collapsed) if not
                const isCollapsed = appData.uiState.collapsedCaiSections[caiId] === true;

                if (isCollapsed) {
                    contentDiv.classList.add('hidden');
                    toggleIcon.classList.remove('fa-chevron-up');
                    toggleIcon.classList.add('fa-chevron-down');
                } else {
                    contentDiv.classList.remove('hidden');
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-up');
                }
            }
        }

        // Función para determinar el turno según la hora
        function getTurno() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour <= 7) {
                return "segundo turno";
            } else if (hour >= 20 && hour <= 22) {
                return "primer turno";
            } else if (hour >= 12 && hour <= 14) {
                return "tercer turno";
            } else {
                return "segundo turno"; // Default to "segundo turno" if no specific condition met
            }
        }

        // --- Renderizado General de la UI ---
        function renderUI() {
            // Actualiza los campos de entrada
            document.getElementById('commanderRank').value = appData.commanderRank;
            document.getElementById('commanderName').value = appData.commanderName;
            document.getElementById('importantServices').value = appData.importantServices.join('\n');

            updatePersonnelAssignedStatus(); // Asegura que el estado de asignado sea correcto antes de renderizar los selectores
            renderPersonnelList();
            renderCaiSections(); // This will now also apply CAI specific collapse states
            renderOtherGroups(); // This will now only render non-CAI info groups

            // Apply the saved state for main collapsible sections
            applySectionState('configSection');
            // The assignmentSection is no longer collapsible, so no need to apply state
        }

        // --- Generar Informe ---
        function generateReport() {
            const greeting = getGreeting();
            const commanderRank = document.getElementById('commanderRank').value.trim();
            const commanderName = document.getElementById('commanderName').value.trim();
            const importantServicesText = document.getElementById('importantServices').value.trim();
            const importantServices = importantServicesText.split('\n').filter(line => line.trim() !== '');
            const turno = getTurno(); // Get the dynamic turno

            let oficialesTotalCount = 0;
            let suboficialesTotalCount = 0;
            let patrullerosTotalCount = 0;

            // Count personnel from CAI teams
            appData.caiSections.forEach(cai => {
                cai.teams.forEach(team => {
                    team.members.forEach(memberId => {
                        const person = appData.personnel.find(p => p.id === memberId);
                        if (person) {
                            if (person.category === "Oficiales") {
                                oficialesTotalCount++;
                            } else if (person.category === "Suboficiales") {
                                suboficialesTotalCount++;
                            } else if (person.category === "Patrulleros") {
                                patrullerosTotalCount++;
                            }
                        }
                    });
                });
            });

            // Count personnel from "Jefe de Vigilancia", "Jefe de información E-12 y Centinelas", "Zona T" and "Información de CAI" groups
            appData.otherGroups.forEach(group => {
                if (group.name === "Jefe de Vigilancia" || group.name === "Jefe de información E-12 y Centinelas" || group.name === "Zona T" || group.name.includes("(Información)")) {
                    group.members.forEach(memberId => {
                        const person = appData.personnel.find(p => p.id === memberId);
                        if (person) {
                            if (person.category === "Oficiales") {
                                oficialesTotalCount++;
                            } else if (person.category === "Suboficiales") {
                                suboficialesTotalCount++;
                            } else if (person.category === "Patrulleros") {
                                patrullerosTotalCount++;
                            }
                        }
                    });
                }
            });


            let report = `Dios y Patria mi Mayor ${greeting}, respetuosamente me permito reportar el personal para el ${turno}, así:\n\n`;

            // Parte de Zonas de Atención
            report += `*Parte =(${oficialesTotalCount}-${suboficialesTotalCount}-${patrullerosTotalCount})*\n\n`; // Updated with dynamic counts

            // Calculate totalZones based on complete teams
            let totalZones = 0;
            appData.caiSections.forEach(cai => {
                cai.teams.forEach(team => {
                    if (team.members.length === 2) { // Only count teams with 2 members
                        totalZones++;
                    }
                });
            });

            report += `Total: *(${totalZones})* Zonas de Atención asignados al Nuevo Modelo de Servicio de Policía en la Estación Barrios Unidos, así:\n\n`;

            appData.caiSections.forEach(cai => {
                report += `*${cai.name.toUpperCase()}*\n`;
                cai.teams.forEach(team => {
                    const members = team.members.map(memberId => {
                        const person = appData.personnel.find(p => p.id === memberId);
                        return person ? `${person.grade} ${person.name}` : 'Personal no asignado';
                    }).join(' / ');
                    report += `🚔 ${team.name} ${members}\n`;
                });
                report += '\n'; // Añade un salto de línea después de cada sección CAI
            });

            // Zona T (newly added group)
            const zonaTGroup = appData.otherGroups.find(g => g.name === "Zona T");
            let zonaTContentAdded = false;
            if (zonaTGroup && zonaTGroup.members.length > 0) {
                report += `*Zona T*\n`;
                zonaTGroup.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `${person.grade} ${person.name}\n`;
                    }
                });
                report += '\n'; // Add a newline after Zona T members
                zonaTContentAdded = true;
            }

            // Jefe de Vigilancia (existing group, now potentially separate from general Zona T members)
            const jefeVigilanciaGroup = appData.otherGroups.find(g => g.name === "Jefe de Vigilancia");
            let jefeVigilanciaContentAdded = false;
            if (jefeVigilanciaGroup && jefeVigilanciaGroup.members.length > 0) {
                const jefe = appData.personnel.find(p => p.id === jefeVigilanciaGroup.members[0]);
                if (jefe) {
                    report += `*Jefe de Vigilancia*\n`;
                    report += `${jefe.grade} ${jefe.name}\n`;
                    jefeVigilanciaContentAdded = true;
                }
            }
            // Add a newline after Jefe de Vigilancia if content was added
            if (jefeVigilanciaContentAdded) {
                report += '\n';
            }


            // Servicios de Importancia
            if (importantServices.length > 0) {
                report += `*Servicios de Importancia*\n\n`;
                importantServices.forEach(service => {
                    report += `📌${service}\n`;
                });
                report += '\n';
            }

            // Jefe de información E-12 y Centinelas
            const jefeInfoGroup = appData.otherGroups.find(g => g.name === "Jefe de información E-12 y Centinelas");
            if (jefeInfoGroup && jefeInfoGroup.members.length > 0) {
                report += `*Jefe de información E-12 y Centinelas*\n`; // Changed to single newline
                jefeInfoGroup.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `👮🏻‍♂️${person.grade}. ${person.name}\n`;
                    }
                });
                report += '\n'; // Added back a single newline after this section
            }

            // Custodio E-12
            const custodioE12Group = appData.otherGroups.find(g => g.name === "Custodio E-12");
            if (custodioE12Group && custodioE12Group.members.length > 0) {
                let custodioOficialesCount = 0;
                let custodioSuboficialesCount = 0;
                let custodioPatrullerosCount = 0;

                custodioE12Group.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        if (person.category === "Oficiales") {
                            custodioOficialesCount++;
                        } else if (person.category === "Suboficiales") {
                            custodioSuboficialesCount++;
                        } else if (person.category === "Patrulleros") {
                            custodioPatrullerosCount++;
                        }
                    }
                });

                report += `*Custodio E-12*\n\n`;
                report += `Parte: (${custodioOficialesCount}-${custodioSuboficialesCount}-${custodioPatrullerosCount})\n\n`; // Dynamic count for Custodio E-12
                custodioE12Group.members.forEach(memberId => {
                    const person = appData.personnel.find(p => p.id === memberId);
                    if (person) {
                        report += `${person.grade}. ${person.name}\n`;
                    }
                });
                report += '\n';
            }

            // Información de CAI (individual) - REVERTED to consolidated block
            const caiInfoGroups = appData.otherGroups.filter(g => g.name.includes("(Información)"));
            if (caiInfoGroups.length > 0) {
                report += `*Información de CAI*\n\n`;
                caiInfoGroups.forEach(group => {
                    if (group.members.length > 0) {
                        group.members.forEach(memberId => {
                            const person = appData.personnel.find(p => p.id === memberId);
                            if (person) {
                                report += `*${group.name.replace(' (Información)', '')}*\n`;
                                report += `👮🏻‍♂️ ${person.grade}. ${person.name}\n\n`;
                            }
                        });
                    }
                });
            }


            // Novedades (excluding the CAI Information groups, which are now handled above)
            const novedadesGroups = appData.otherGroups.filter(g => ["Vacaciones", "Excusado", "Calamidad"].includes(g.name));
            const customNovedadesGroups = appData.otherGroups.filter(g => !["Jefe de Vigilancia", "Zona T", "Jefe de información E-12 y Centinelas", "Custodio E-12", "Vacaciones", "Excusado", "Calamidad"].includes(g.name) && !g.name.includes("(Información)"));

            if (novedadesGroups.length > 0 || customNovedadesGroups.length > 0) {
                report += `*📌NOVEDADES*\n\n`;
                novedadesGroups.concat(customNovedadesGroups).forEach(group => {
                    if (group.members.length > 0) {
                        report += `*${group.name}*\n\n`;
                        group.members.forEach(memberId => {
                            const person = appData.personnel.find(p => p.id === memberId);
                            if (person) {
                                report += `${person.grade} ${person.name}\n`;
                            }
                        });
                        report += '\n';
                    }
                });
            }

            report += `${commanderRank} ${commanderName}\n`;
            report += `*Comandante Estación de Policía Barrios Unidos*\n`;

            document.getElementById('reportOutput').textContent = report;
        }

        // --- Función para copiar el informe ---
        function copyReport() {
            const reportText = document.getElementById('reportOutput').textContent;
            try {
                const textarea = document.createElement('textarea');
                textarea.value = reportText;
                textarea.style.position = 'fixed'; // Evita que el scroll se mueva
                textarea.style.opacity = 0; // Lo hace invisible
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000); // Oculta el feedback después de 2 segundos
            } catch (err) {
                console.error('Error al copiar el informe: ', err);
                // Aquí podrías mostrar un mensaje de error al usuario si la copia falla
            }
        }


        // Inicializar la aplicación al cargar la página
        window.onload = loadData;
    </script>
</body>
</html>

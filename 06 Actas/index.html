<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Unificada: Generar Acta & Extractor PDF</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #45a049;
            --primary-light: #a5d6a7;
            --secondary: #f4f4f4;
            --text: #333333;
            --text-light: #666666;
            --border: #cccccc;
            --danger: #f44336;
            --success: #4caf50;
            --radius: 0.375rem;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', Segoe UI, sans-serif;
            font-size: 10pt;
            color: var(--text);
            background-color: #f9fafb;
            line-height: 1.5;
            margin: 0;
        }

        header {
            background: var(--primary);
            color: white;
            text-align: center;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .app-title {
            font-size: 14pt;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .app-subtitle {
            font-size: 10pt;
            opacity: 0.9;
        }

        nav {
            background: var(--secondary);
            display: flex;
            gap: 20px;
            padding: 10px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        nav a {
            text-decoration: none;
            color: var(--text);
            padding: 8px 15px;
            border-radius: var(--radius);
            transition: background-color 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav a:hover {
            background-color: var(--primary-light);
            color: var(--text);
        }

        nav a.active {
            background-color: var(--primary);
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            border: 1px solid var(--border);
        }

        h1 {
            text-align: center;
            font-size: 14pt;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        h1 i {
            color: var(--primary);
        }

        h3 {
            font-size: 10pt;
            margin: 15px 0 5px;
        }

        form .form-group {
            margin-bottom: 15px;
        }

        form label {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
            font-size: 10pt;
        }

        form input[type="text"],
        form textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 10pt;
        }

        form input[type="text"]:focus,
        form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            padding: 10px 15px;
            font-size: 10pt;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #actaGenerada {
            border-top: 1px solid var(--border);
            margin-top: 20px;
            padding-top: 20px;
            text-align: justify;
        }

        #primerParrafo {
            text-transform: uppercase;
        }

        .drop-zone {
            border: 2px dashed var(--border);
            padding: 50px;
            text-align: center;
            cursor: pointer;
            background-color: var(--secondary);
            margin: 20px 0;
            border-radius: var(--radius);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .drop-zone i {
            font-size: 2.5rem;
            color: var(--text-light);
        }

        .drop-zone.dragover {
            border-color: var(--primary);
            background-color: #e6ffe6;
        }

        .drop-zone.dragover i {
            color: var(--primary);
        }

        #output, #suggestion, #stats {
            margin-top: 20px;
            padding: 10px;
            background-color: var(--secondary);
            border-radius: var(--radius);
            font-size: 10pt;
        }

        #stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .stat-item i {
            color: var(--primary);
        }

        .range-container {
            margin: 20px 0;
        }

        .range-container label {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }

        input[type="range"] {
            width: 100%;
        }

        .icon-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .icon-group label {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: normal;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            transition: all 0.3s;
        }
        
        .icon-group label:hover {
            border-color: var(--primary-light);
        }
        
        .icon-group input[type="radio"] {
            display: none;
        }

        .single-box {
            width: 50px;
            height: 50px;
            background-color: #e5e7eb;
            margin-bottom: 5px;
            border-radius: 0.25rem;
        }

        .four-boxes {
            display: grid;
            grid-template-columns: repeat(2, 20px);
            grid-template-rows: repeat(2, 20px);
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .four-boxes .box {
            background-color: #e5e7eb;
            border-radius: 0.25rem;
        }

        .icon-group input[type="radio"]:checked + label {
            border-color: var(--primary);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .image-container {
            margin-top: 20px;
            text-align: center;
        }

        .image-wrapper {
            display: inline-block;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            max-width: 100%;
            position: relative;
        }

        .image-wrapper::after {
            content: "Haz clic para copiar";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 9pt;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-wrapper:hover::after {
            opacity: 1;
        }

        .image-wrapper img {
            width: auto;
            height: auto;
            max-width: 100%;
            cursor: pointer;
            display: block;
        }

        .image-navigation {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }

        .image-counter {
            font-size: 10pt;
            color: var(--text-light);
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
                margin: 10px;
            }
            
            .drop-zone {
                padding: 30px 15px;
            }
            
            .icon-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<header>
    <h1 class="app-title">Aplicación Unificada</h1>
    <p class="app-subtitle">Generación de Acta de Instrucción & Extractor de Contenido PDF</p>
</header>

<nav>
    <a href="#" id="tabActa" class="active"><i class="fas fa-file-alt"></i> Generar Acta</a>
    <a href="#" id="tabPdf"><i class="fas fa-file-pdf"></i> Extractor PDF</a>
</nav>

<main>
    <!-- Sección Acta -->
    <section id="actaSection" class="container">
        <h1><i class="fas fa-file-signature"></i> Generar Acta de Instrucción</h1>
        <form id="actaForm">
            <div class="form-group">
                <label for="grado">Grado</label>
                <input type="text" id="grado" placeholder="Ej: Capitán" required>
            </div>
            
            <div class="form-group">
                <label for="nombre">Nombre</label>
                <input type="text" id="nombre" placeholder="Nombre completo" required>
            </div>
            
            <div class="form-group">
                <label for="cargo">Cargo</label>
                <input type="text" id="cargo" placeholder="Cargo del funcionario" required>
            </div>
            
            <div class="form-group">
                <label for="tema">Tema de Instrucción</label>
                <input type="text" id="tema" placeholder="Tema" required>
            </div>
            
            <div class="form-group">
                <label for="temas">Temas a tratar</label>
                <textarea id="temas" placeholder="Lista de temas a tratar" required rows="4"></textarea>
            </div>
            
            <button type="submit"><i class="fas fa-check-circle"></i> Generar Acta</button>
        </form>

        <div id="actaGenerada" style="display:none;">
            <h1>ACTA DE INSTRUCCIÓN</h1>
            <p>Lugar: ESTACIÓN DE POLICÍA BARRIOS UNIDOS</p> <br>
            <p id="primerParrafo">
                LA INSTRUCCIÓN DIRIGIDA POR PARTE DEL SEÑOR 
                <span id="actaGrado"></span>, 
                <span id="actaCargo"></span>, 
                AL PERSONAL QUE CONFORMA LA ESTACIÓN DE POLICÍA BARRIOS UNIDOS, 
                SOBRE <span id="articuloTema">EL</span> <span id="actaTema"></span>.
            </p>
            <br>
            <h3>ORDEN DEL DÍA</h3>
                <ol style="padding-left: 40px;"> <!-- Se añade el estilo inline aquí -->
                    <li>Verificación de asistentes</li>
                    <li>Lectura del acta anterior</li>
                    <li>Verificación de los compromisos</li>
                    <li>Temas a tratar</li>
                  </ol>
            <br>
            <h3>DESARROLLO</h3><br>
            <p>
                Se realiza instrucción al personal adscrito a la Estación de Policía Barrios Unidos 
                por parte del señor <span id="actaGrado2"></span>, <span id="actaCargo2"></span>, 
                a quienes se les socializan los lineamientos sobre 
                <span id="articuloTema2">el</span> <span id="actaTema2"></span>.
            </p>
            <br>
            <h3>1. Verificación de asistentes</h3><br>
            <p>
                Se verifica la asistencia del personal adscrito a la unidad y se constata la compatibilidad 
                de los correos electrónicos del personal que integra la Estación de Policía Barrios Unidos. 
                Dejando constancia que la presente acta de instrucción se surtirá presencialmente, por correo 
                electrónico y a través del Sistema de Información Gestor de Documentos Policiales, en virtud 
                a lo dispuesto en el Art. 103 del Código General del Proceso -- Uso de las tecnologías de la 
                información y de las comunicaciones, Ley 527 del 18 de agosto de 1999, Ley 794 del 01 de agosto 
                de 2003 y la Ley 962 del 08 de julio de 2005.
            </p>
            <br>
            <h3>2. Lectura del acta anterior</h3><br>
            <p>(NO APLICA)</p>
            <br>
            <h3>3. Verificación de los compromisos</h3><br>
            <p>(NO APLICA)</p>
            <br>
            <h3>4. Temas a tratar</h3><br>
            <p id="temasTratar"></p>
            <br>
        </div>
    </section>

    <!-- Sección Extractor PDF -->
    <section id="pdfSection" class="container" style="display:none;">
        <h1><i class="fas fa-file-export"></i> Extractor de Contenido PDF Mejorado</h1>
        
        <div class="form-group">
            <label for="fileInput">Seleccionar archivo PDF o arrastrar y soltar:</label>
            <div id="dropZone" class="drop-zone">
                <i class="fas fa-file-upload"></i>
                <p>Arrastra y suelta el archivo PDF aquí o haz clic para seleccionarlo</p>
            </div>
            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
        </div>

        <div id="suggestion"></div>

        <div class="range-container">
            <label for="marginRange">
                Margen sugerido para recorte (píxeles): 
                <span id="rangeValue">150</span>
            </label>
            <input type="range" id="marginRange" value="150" min="0" max="200" step="1">
        </div>

        <!-- Modo de agrupación: 1 hoja o 4 hojas -->
        <div>
            <p style="margin: 10px 0; font-weight: 600;">Elige modo de agrupación:</p>
            <div class="icon-group">
                <!-- Opción 1 página -->
                <input type="radio" id="singleMode" name="pagesMode" value="1" checked>
                <label for="singleMode">
                    <div class="single-box"></div>
                    <span>1 Hoja</span>
                </label>
                
                <!-- Opción 4 páginas -->
                <input type="radio" id="fourMode" name="pagesMode" value="4">
                <label for="fourMode">
                    <div class="four-boxes">
                        <div class="box"></div>
                        <div class="box"></div>
                        <div class="box"></div>
                        <div class="box"></div>
                    </div>
                    <span>4 Hojas</span>
                </label>
            </div>
        </div>

        <button id="processButton"><i class="fas fa-cogs"></i> Procesar PDF</button>

        <div id="output"></div>
        
        <div id="stats" style="display: none;">
            <div class="stat-item">
                <i class="fas fa-file-alt"></i>
                <span id="processedStat">0</span> páginas procesadas
            </div>
            <div class="stat-item">
                <i class="fas fa-file"></i>
                <span id="blankStat">0</span> páginas en blanco omitidas
            </div>
        </div>

        <div class="image-container" id="imageContainer" style="display:none;">
            <div class="image-wrapper">
                <img id="currentImage" alt="Imagen actual extraída del PDF">
            </div>
            <div class="image-navigation">
                <button id="prevButton"><i class="fas fa-chevron-left"></i> Anterior</button>
                <span class="image-counter">Imagen <span id="currentImageIndex">1</span> de <span id="totalImages">1</span></span>
                <button id="nextButton">Siguiente <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <button id="downloadAll" style="display: none; margin-top: 20px;">
            <i class="fas fa-download"></i> Descargar todas las imágenes
        </button>
    </section>
</main>

<!-- Librerías externas: pdf.js y JSZip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js"></script>
<script>
    // ------------------------------
    // Lógica de Pestañas
    // ------------------------------
    const tabActa = document.getElementById('tabActa');
    const tabPdf = document.getElementById('tabPdf');
    const actaSection = document.getElementById('actaSection');
    const pdfSection = document.getElementById('pdfSection');

    tabActa.addEventListener('click', (e) => {
        e.preventDefault();
        tabActa.classList.add('active');
        tabPdf.classList.remove('active');
        actaSection.style.display = 'block';
        pdfSection.style.display = 'none';
    });

    tabPdf.addEventListener('click', (e) => {
        e.preventDefault();
        tabPdf.classList.add('active');
        tabActa.classList.remove('active');
        pdfSection.style.display = 'block';
        actaSection.style.display = 'none';
    });

    // ------------------------------
    // Funciones para Generar Acta
    // ------------------------------
    function saveToLocalStorage(data) {
        localStorage.setItem('actaData', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const data = localStorage.getItem('actaData');
        return data ? JSON.parse(data) : null;
    }

    function updateForm(data) {
        if (data) {
            document.getElementById('grado').value = data.grado;
            document.getElementById('nombre').value = data.nombre;
            document.getElementById('cargo').value = data.cargo;
            document.getElementById('tema').value = data.tema;
            document.getElementById('temas').value = data.temas;
        }
    }



   // Función para determinar el artículo correcto basado en el tema de instrucción
function determinarArticulo(tema) {
    // Convertir a minúsculas y eliminar espacios iniciales y finales
    const temaLimpio = tema.trim().toLowerCase();
    
    // Si el tema está vacío, devolver un artículo por defecto
    if (!temaLimpio) return { articulo: "EL", articuloMin: "el" };
    
    // Array de palabras comunes masculinas (sustantivos que suelen ser tema de instrucción)
    const masculinos = [
        "protocolo", "procedimiento", "manual", "instructivo", "reglamento", 
        "decreto", "código", "estatuto", "memorando", "oficio", "formulario",
        "programa", "plan", "sistema", "método", "formato", "proceso", "uso",
        "manejo", "curso", "taller", "seminario", "simposio", "congreso", 
        "informe", "reporte", "documento", "expediente", "registro", "archivo",
        "control", "seguimiento", "operativo", "operacional", "servicio", "deber"
    ];
    
    // Array de palabras comunes femeninas (sustantivos que suelen ser tema de instrucción)
    const femeninas = [
        "normativa", "norma", "directiva", "instrucción", "circular", 
        "resolución", "orden", "directriz", "ley", "regulación", "disposición",
        "medida", "acción", "guía", "metodología", "técnica", "estrategia", 
        "táctica", "operación", "actividad", "capacitación", "formación", 
        "conferencia", "charla", "presentación", "exposición", "jornada", 
        "sesión", "reunión", "clase", "política", "aplicación", "implementación",
        "comunicación"
    ];
    
    // Array de palabras comunes en plural masculinas
    const masculinosPlural = [
        "protocolos", "procedimientos", "manuales", "instructivos", "reglamentos",
        "decretos", "códigos", "estatutos", "memorandos", "oficios", "formularios",
        "programas", "planes", "sistemas", "métodos", "formatos", "procesos", "usos",
        "manejos", "cursos", "talleres", "seminarios", "simposios", "congresos",
        "informes", "reportes", "documentos", "expedientes", "registros", "archivos",
        "controles", "seguimientos", "operativos"
    ];
    
    // Array de palabras comunes en plural femeninas
    const femeninaPlural = [
        "normativas", "normas", "directivas", "instrucciones", "circulares",
        "resoluciones", "órdenes", "directrices", "leyes", "regulaciones", "disposiciones",
        "medidas", "acciones", "guías", "metodologías", "técnicas", "estrategias",
        "tácticas", "operaciones", "actividades", "capacitaciones", "formaciones",
        "conferencias", "charlas", "presentaciones", "exposiciones", "jornadas",
        "sesiones", "reuniones", "clases", "políticas", "comunicaciones"
    ];
    
    // Dividir el tema en palabras
    const palabras = temaLimpio.split(' ');
    
    // Buscar la primera palabra sustantiva en el tema
    // Ignoramos artículos y preposiciones comunes al inicio
    let indicePalabra = 0;
    const preposicionesArticulos = ["de", "del", "la", "el", "los", "las", "sobre", "para", "en", "con", "y", "o"];
    
    while (indicePalabra < palabras.length && preposicionesArticulos.includes(palabras[indicePalabra])) {
        indicePalabra++;
    }
    
    // Si llegamos al final sin encontrar un sustantivo, usamos la primera palabra
    const primeraPalabra = (indicePalabra < palabras.length) ? palabras[indicePalabra] : palabras[0];
    
    // Verificar si la primera palabra termina en 's' o 'es' para detectar plurales
    const esPlural = primeraPalabra.endsWith('s') || primeraPalabra.endsWith('es');
    
    // Verificar listas de palabras conocidas
    if (masculinosPlural.includes(primeraPalabra)) {
        return { articulo: "LOS", articuloMin: "los" };
    } else if (femeninaPlural.includes(primeraPalabra)) {
        return { articulo: "LAS", articuloMin: "las" };
    } else if (masculinos.includes(primeraPalabra)) {
        return { articulo: "EL", articuloMin: "el" };
    } else if (femeninas.includes(primeraPalabra)) {
        return { articulo: "LA", articuloMin: "la" };
    }
    
    // Si no se encuentra en las listas, aplicar reglas generales de género en español
    if (esPlural) {
        // Para palabras en plural, verificar la terminación sin la 's'
        const singular = primeraPalabra.endsWith('es') 
            ? primeraPalabra.slice(0, -2) 
            : primeraPalabra.slice(0, -1);
            
        // Verificar terminaciones comunes femeninas en singular
        if (singular.endsWith('a') || 
            singular.endsWith('dad') || 
            singular.endsWith('ción') || 
            singular.endsWith('sión') || 
            singular.endsWith('tud') || 
            singular.endsWith('umbre')) {
            return { articulo: "LAS", articuloMin: "las" };
        } else {
            // Por defecto, usar masculino plural
            return { articulo: "LOS", articuloMin: "los" };
        }
    } else {
        // Para palabras en singular
        if (primeraPalabra.endsWith('a') || 
            primeraPalabra.endsWith('dad') || 
            primeraPalabra.endsWith('ción') || 
            primeraPalabra.endsWith('sión') || 
            primeraPalabra.endsWith('tud') || 
            primeraPalabra.endsWith('umbre')) {
            return { articulo: "LA", articuloMin: "la" };
        } else {
            // Por defecto, usar masculino singular
            return { articulo: "EL", articuloMin: "el" };
        }
    }
}

    // Ejemplos de uso:
// determinarArticulo("Protocolo de Seguridad") -> { articulo: "EL", articuloMin: "el" }
// determinarArticulo("Normativa de Conducta") -> { articulo: "LA", articuloMin: "la" }
// determinarArticulo("Protocolos de Seguridad") -> { articulo: "LOS", articuloMin: "los" }
// determinarArticulo("Normativas de Conducta") -> { articulo: "LAS", articuloMin: "las" }
// determinarArticulo("Comunicaciones") -> { articulo: "LAS", articuloMin: "las" }
// determinarArticulo("Sobre las Comunicaciones") -> { articulo: "LAS", articuloMin: "las" }


    
    function generateActa(data) {
    document.getElementById('actaGrado').textContent = data.grado + ' ' + data.nombre;
    document.getElementById('actaCargo').textContent = data.cargo;
    document.getElementById('actaTema').textContent = data.tema;
    document.getElementById('actaGrado2').textContent = data.grado + ' ' + data.nombre;
    document.getElementById('actaCargo2').textContent = data.cargo;
    document.getElementById('actaTema2').textContent = data.tema;
    document.getElementById('temasTratar').textContent = data.temas;

    // Usar la nueva función para determinar el artículo correcto
    const { articulo, articuloMin } = determinarArticulo(data.tema);

    document.getElementById('articuloTema').textContent = articulo;
    document.getElementById('articuloTema2').textContent = articuloMin;

    document.getElementById('actaGenerada').style.display = 'block';
}

    document.addEventListener('DOMContentLoaded', function() {
        const savedData = loadFromLocalStorage();
        updateForm(savedData);
        if (savedData) {
            generateActa(savedData);
        }
    });

    document.getElementById('actaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const data = {
            grado: document.getElementById('grado').value,
            nombre: document.getElementById('nombre').value,
            cargo: document.getElementById('cargo').value,
            tema: document.getElementById('tema').value,
            temas: document.getElementById('temas').value
        };

        saveToLocalStorage(data);
        generateActa(data);
    });

    // ------------------------------
    // Funciones Extractor PDF
    // ------------------------------
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const processButton = document.getElementById('processButton');
    const output = document.getElementById('output');
    const suggestion = document.getElementById('suggestion');
    const stats = document.getElementById('stats');
    const processedStat = document.getElementById('processedStat');
    const blankStat = document.getElementById('blankStat');
    const imageContainer = document.getElementById('imageContainer');
    const currentImage = document.getElementById('currentImage');
    const downloadAllButton = document.getElementById('downloadAll');
    const currentImageIndex = document.getElementById('currentImageIndex');
    const totalImages = document.getElementById('totalImages');

    const marginRange = document.getElementById('marginRange');
    const rangeValueSpan = document.getElementById('rangeValue');
    marginRange.addEventListener('input', () => {
        rangeValueSpan.textContent = marginRange.value;
    });

    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');

    let singlePageImages = []; // Páginas procesadas individualmente
    let processedImages = [];  // Imágenes finales (collages o individuales)
    let currentIndex = 0;

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) {
            fileInput.files = files;
            handleFileSelection();
        }
    });

    fileInput.addEventListener('change', handleFileSelection);

    async function handleFileSelection() {
        const file = fileInput.files[0];
        if (!file || file.type !== 'application/pdf') {
            suggestion.innerHTML = '<i class="fas fa-exclamation-circle"></i> Por favor, sube un archivo PDF válido.';
            suggestion.style.display = 'block';
            return;
        }
        suggestion.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando el archivo...';
        suggestion.style.display = 'block';
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            suggestion.innerHTML = '<i class="fas fa-check-circle"></i> Archivo PDF cargado correctamente.';
            processButton.onclick = () => processPDF(pdf);
        } catch (error) {
            suggestion.innerHTML = '<i class="fas fa-times-circle"></i> Error al cargar el archivo PDF.';
            console.error("Error al cargar el archivo PDF: ", error);
        }
    }

    async function processPDF(pdf) {
        output.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando PDF...';
        output.style.display = 'block';
        imageContainer.style.display = 'none';
        stats.style.display = 'none';
        singlePageImages = [];
        processedImages = [];
        currentIndex = 0;
        downloadAllButton.style.display = 'none';

        try {
            const numPages = pdf.numPages;
            let processedPages = 0;
            let blankPages = 0;

            // Leemos qué opción se eligió (1 o 4)
            const pagesMode = parseInt(document.querySelector('input[name="pagesMode"]:checked').value, 10);

            // Renderizamos todas las páginas
            for (let i = 1; i <= numPages; i++) {
                const isBlank = await processPage(pdf, i);
                if (isBlank) {
                    blankPages++;
                } else {
                    processedPages++;
                }
                output.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Procesando página ${i} de ${numPages}...`;
            }

            // Si es modo 1: se añaden las imágenes individuales tal cual
            if (pagesMode === 1) {
                processedImages = singlePageImages;

            // Si es modo 4: se agrupan en collages de 4
            } else if (pagesMode === 4) {
                let index = 0;
                while (index < singlePageImages.length) {
                    const remaining = singlePageImages.length - index;
                    if (remaining >= 4) {
                        const group = singlePageImages.slice(index, index + 4);
                        const collage = await createCollageOfFour(group);
                        processedImages.push(collage);
                        index += 4;
                    } else {
                        // si sobran < 4, se añaden individualmente
                        const leftover = singlePageImages.slice(index);
                        processedImages.push(...leftover);
                        break;
                    }
                }
            }

            processedStat.textContent = processedPages;
            blankStat.textContent = blankPages;
            stats.style.display = 'flex';
            output.innerHTML = '<i class="fas fa-check-circle"></i> Proceso completado. Todas las imágenes han sido generadas.';
            downloadAllButton.style.display = 'block';

            if (processedImages.length > 0) {
                currentIndex = 0;
                totalImages.textContent = processedImages.length;
                currentImageIndex.textContent = currentIndex + 1;
                showImage(currentIndex);
                imageContainer.style.display = 'block';
            } else {
                imageContainer.style.display = 'none';
            }
        } catch (error) {
            output.innerHTML = `<i class="fas fa-times-circle"></i> Error: ${error.message}`;
            console.error('Error durante el procesamiento del PDF:', error);
        }
    }

    // Procesa cada página y genera un DataURL
    async function processPage(pdf, pageNumber) {
        const page = await pdf.getPage(pageNumber);
        const scale = 3; 
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: context, viewport }).promise;
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

        if (isPageBlank(imageData)) {
            return true; // Página en blanco
        }

        // Encontrar el área con contenido
        const bounds = findContentBounds(imageData);

        // Recortar el área con contenido
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = bounds.right - bounds.left;
        croppedCanvas.height = bounds.bottom - bounds.top;
        const croppedContext = croppedCanvas.getContext('2d');
        croppedContext.drawImage(
            canvas, 
            bounds.left, bounds.top, 
            croppedCanvas.width, croppedCanvas.height, 
            0, 0, 
            croppedCanvas.width, croppedCanvas.height
        );

        const dataUrl = croppedCanvas.toDataURL('image/png');
        // Guardamos esta imagen individual
        singlePageImages.push({
            name: `page_${pageNumber}.png`,
            dataUrl: dataUrl
        });

        return false; // No está en blanco
    }

    // Determina si una página está en blanco mediante muestreo aleatorio de pixeles
    function isPageBlank(imageData) {
        const { data, width, height } = imageData;
        const threshold = 245;
        const sampleSize = 100;
        const totalPixels = width * height;
        let whitePixels = 0;

        for (let i = 0; i < sampleSize; i++) {
            const randomPixel = Math.floor(Math.random() * totalPixels);
            const index = randomPixel * 4;
            if (data[index] > threshold && data[index + 1] > threshold && data[index + 2] > threshold) {
                whitePixels++;
            }
        }

        return (whitePixels / sampleSize) > 0.98;
    }

    // Encuentra la zona con contenido para recortar
    function findContentBounds(imageData) {
        const { data, width, height } = imageData;
        const initialMargin = parseInt(marginRange.value);

        let left = width, top = height, right = 0, bottom = 0;
        const threshold = 200;
        const extraMargin = 5;

        for (let y = initialMargin; y < height - initialMargin; y++) {
            for (let x = initialMargin; x < width - initialMargin; x++) {
                const i = (y * width + x) * 4;
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Detectar pixeles "oscuros"
                if (r < threshold || g < threshold || b < threshold) {
                    left = Math.min(left, x);
                    top = Math.min(top, y);
                    right = Math.max(right, x);
                    bottom = Math.max(bottom, y);
                }
            }
        }

        return {
            left: Math.max(initialMargin, left - extraMargin),
            top: Math.max(initialMargin, top - extraMargin),
            right: Math.min(width - initialMargin, right + extraMargin),
            bottom: Math.min(height - initialMargin, bottom + extraMargin)
        };
    }

    // Crea un collage de 4 imágenes en un lienzo tamaño carta (2x2)
    async function createCollageOfFour(imagesGroup) {
        const collageWidth = 1275;  // Aprox. ancho carta
        const collageHeight = 1650; // Aprox. alto carta

        const collageCanvas = document.createElement('canvas');
        collageCanvas.width = collageWidth;
        collageCanvas.height = collageHeight;
        const collageContext = collageCanvas.getContext('2d');

        const quadrantWidth = collageWidth / 2;
        const quadrantHeight = collageHeight / 2;

        for (let i = 0; i < imagesGroup.length; i++) {
            const imageData = imagesGroup[i];
            const imageEl = new Image();
            await new Promise((resolve) => {
                imageEl.onload = resolve;
                imageEl.src = imageData.dataUrl;
            });
            const row = Math.floor(i / 2);
            const col = i % 2;
            const dx = col * quadrantWidth;
            const dy = row * quadrantHeight;
            collageContext.drawImage(
                imageEl,
                0, 0, imageEl.width, imageEl.height,
                dx, dy, quadrantWidth, quadrantHeight
            );
        }

        return {
            name: 'collage.png',
            dataUrl: collageCanvas.toDataURL('image/png')
        };
    }

    // Navegación de imágenes
    function showImage(index) {
        if (processedImages.length === 0) return;

        currentImage.src = processedImages[index].dataUrl;
        currentImage.alt = processedImages[index].name || `Imagen ${index + 1}`;
        currentImageIndex.textContent = index + 1;

        prevButton.disabled = (index === 0);
        nextButton.disabled = (index === processedImages.length - 1);
    }

    prevButton.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showImage(currentIndex);
        }
    });

    nextButton.addEventListener('click', () => {
        if (currentIndex < processedImages.length - 1) {
            currentIndex++;
            showImage(currentIndex);
        }
    });

    // Al hacer clic en la imagen, se copia al portapapeles y pasa a la siguiente
    currentImage.addEventListener('click', async () => {
        try {
            const dataUrl = processedImages[currentIndex].dataUrl;
            const blob = await (await fetch(dataUrl)).blob();
            const clipboardItem = new ClipboardItem({ [blob.type]: blob });
            await navigator.clipboard.write([clipboardItem]);
            console.log('Imagen copiada al portapapeles.');
            
            // Mostrar feedback visual al usuario
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'rgba(76, 175, 80, 0.9)';
            toast.style.color = 'white';
            toast.style.padding = '8px 16px';
            toast.style.borderRadius = '4px';
            toast.style.zIndex = '1000';
            toast.style.fontSize = '10pt';
            toast.innerHTML = '<i class="fas fa-check-circle"></i> ¡Imagen copiada al portapapeles!';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 2000);

            if (currentIndex < processedImages.length - 1) {
                currentIndex++;
                showImage(currentIndex);
            }
        } catch (error) {
            console.error('Error al copiar la imagen:', error);
        }
    });

    // Descarga todas las imágenes en un ZIP
    async function downloadAllImages() {
        const zip = new JSZip();

        processedImages.forEach((image, index) => {
            const base64Data = image.dataUrl.split(',')[1];
            let fileName = image.name;
            if (!fileName) {
                fileName = `imagen_${index + 1}.png`;
            }
            zip.file(fileName, base64Data, { base64: true });
        });

        const content = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = 'imagenes_extraidas.zip';
        link.click();
    }

    downloadAllButton.addEventListener('click', downloadAllImages);
</script>
</body>
</html>
